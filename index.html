<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tersys - SAP Analytics</title>
    
    <!-- Assets & Libraries -->
    <link rel="icon" type="image/png" href="https://jsmnykikflkjceiqfmne.supabase.co/storage/v1/object/public/LOGOS/Logo_sm_texto-removebg-preview.png">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a' }
                    },
                    boxShadow: { 'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)' }
                }
            }
        }
    </script>

    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border-top-color: #3b82f6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .glass-card { background: rgba(255, 255, 255, 0.95); border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 0.75rem; backdrop-filter: blur(8px); }
        .dark .glass-card { background: rgba(30, 41, 59, 0.95); border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .interactive-row:hover { background-color: #f1f5f9; cursor: pointer; transition: background-color 0.2s; }
        .dark .interactive-row:hover { background-color: #334155; }
        .input-label { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.05em; }
        .dark .input-label { color: #94a3b8; }
        .animate-enter { animation: fadeInScale 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .content-transition { transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .picker-popover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        /* --- CSS DE IMPRESSÃO (MODO RETRATO / PORTRAIT) --- */
/* --- CSS DE IMPRESSÃO (CORREÇÃO DE CORTE DE PÁGINA) --- */
@media print {
    @page { 
        size: portrait; 
        margin: 5mm; 
    }
    
    /* 1. DESTRAVAR ALTURA: Essencial para imprimir múltiplas páginas */
    html, body, #root, main, .h-screen, .min-h-screen, .overflow-y-auto, .flex-1 {
        height: auto !important;
        min-height: 0 !important;
        overflow: visible !important;
        display: block !important; /* Remove comportamento flex que pode travar altura */
    }

    /* 2. OCULTAR UI */
    nav, header, aside, .sidebar, .filters-area, .status-log, button, .no-print, .fixed { 
        display: none !important; 
    }

    /* 3. LAYOUT DO RELATÓRIO */
    .report-container {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        color: black !important;
    }

    /* Remove margens laterais da sidebar */
    .ml-64, .ml-20 { margin-left: 0 !important; }

    /* Estilo dos Cards e Elementos */
    .glass-card {
        background: #ffffff !important;
        border: 1px solid #000000 !important;
        box-shadow: none !important;
        border-radius: 4px !important;
        margin-bottom: 10px !important;
        page-break-inside: avoid; /* Tenta não quebrar cards ao meio */
    }

    /* 4. CONFIGURAÇÃO DA TABELA (PRINCIPAL) */
    table { 
        width: 100% !important; 
        border-collapse: collapse !important; 
        font-size: 9px !important; 
    }
    
    /* Faz o cabeçalho da tabela repetir em cada nova página */
    thead { display: table-header-group !important; }
    
    /* Evita que uma linha da tabela seja cortada ao meio */
    tr { page-break-inside: avoid !important; }
    
    th, td {
        border: 1px solid #000000 !important;
        padding: 3px !important;
        color: black !important;
    }
    th { background-color: #e5e7eb !important; font-weight: bold !important; }

    /* Gráficos */
    .recharts-wrapper { width: 100% !important; }
    
    /* Forçar quebra de página antes da tabela se necessário (opcional) */
    /* .break-before { page-break-before: always; } */
}
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // 1. SETUP & UTILITIES
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell, ComposedChart, Area, Brush, ReferenceLine } = window.Recharts || {};
        
        const getChartColors = (isDark) => ({
            text: isDark ? '#94a3b8' : '#64748b',
            grid: isDark ? '#334155' : '#e2e8f0',
            tooltipBg: isDark ? '#1e293b' : '#ffffff',
            primary: '#0f172a', secondary: '#3b82f6', accent: '#f59e0b', success: '#10b981',
            bomba: isDark ? '#fdba74' : '#f97316', betoneira: isDark ? '#93c5fd' : '#3b82f6', 
            controladoria: isDark ? '#a78bfa' : '#8b5cf6', controladoria_dark: isDark ? '#8b5cf6' : '#6d28d9', danger: '#ef4444'
        });

        const Utils = {
            normalizeKey: (key) => key ? key.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "") : '',
            cleanStr: (str) => str ? str.toString().trim().toUpperCase() : '',
            normalizeClass: (str) => str ? str.toString().trim().toUpperCase().replace(/\s+/g, ' ') : '',
            checkPermission: (role, required) => {
                if (!role) return false;
                const r = role.toLowerCase();
                if (r === 'admin' || r === 'administrador') return true;
                if (required === 'terceirizacao') return r === 'terceirizacao' || r === 'terceirização';
                if (required === 'controladoria') return r === 'controladoria';
                if (required === 'diesel') return r === 'diesel' || r === 'admin';
                return false;
            },
            formatters: {
                currency: (val) => (typeof val === 'string' ? parseFloat(val) : val || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}),
                number: (val, decimals = 2) => (typeof val === 'string' ? parseFloat(val) : val || 0).toLocaleString('pt-BR', {minimumFractionDigits: decimals, maximumFractionDigits: decimals}),
                parseDate: (val) => {
                    if(!val) return null; if(val instanceof Date) return val.toISOString().split('T')[0];
                    const str = String(val).trim();
                    if(str.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)){ const p=str.split('/'); return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; }
                    if(!isNaN(str) && parseFloat(str) > 30000){ const d = new Date((parseFloat(str)-25569)*86400*1000); return d.toISOString().split('T')[0]; }
                    if(str.match(/^\d{4}-\d{2}-\d{2}$/)) return str;
                    return null;
                },
                parseBrl: (val) => { if (!val) return 0; if(typeof val === 'number') return val; let str = String(val).replace('R$', '').trim(); if(str.includes(',') && !str.includes('e')) str = str.replace(/\./g, '').replace(',', '.'); return parseFloat(str) || 0; }
            },
            math: { roundVolume: (val) => Math.round(((typeof val === 'string' ? parseFloat(val) : val) || 0) * 2) / 2 },
            date: {
                formatNice: (dateStr) => {
                    if(!dateStr) return '';
                    const [y, m] = dateStr.split('-').map(Number);
                    const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                    return `${months[m-1]} ${y}`;
                },
                getMonths: () => ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez']
            }
        };

        const Icons = {
            Database: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 2.68-9 2.68S3 13.66 3 12"/><path d="M3 5v14c0 1.66 4 2.68 9 2.68s9-1.02 9-2.68V5"/></svg>,
            LayoutDashboard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>,
            Table: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/></svg>,
            Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Filter: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            ListFilter: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M3 6h18"/><path d="M7 12h10"/><path d="M10 18h4"/></svg>,
            LogOut: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            DollarSign: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Truck: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>,
            Droplet: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M12 2.69l5.74 5.74c.84.84 1.5 2.12 1.5 3.57v4.5c0 1.66-1.34 3-3 3H7.76c-1.66 0-3-1.34-3-3v-4.5c0-1.45.66-2.73 1.5-3.57L12 2.69z"/></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            RefreshCw: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            ChevronLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="9 18 15 12 9 6"/></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Ban: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>,
            Briefcase: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            User: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            BarChart2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
            FileText2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Edit: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Target: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            ArrowLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
            Menu: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
            ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="6 9 12 15 18 9"/></svg>,
            ChevronRightSmall: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="9 18 15 12 9 6"/></svg>,
            Fuel: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="3" y1="22" x2="15" y2="22"/><line x1="5" y1="17" x2="5" y2="11"/><circle cx="14" cy="10" r="7"/><path d="M8 12a7 7 0 0 1 14 0"/></svg>,
            AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Moon: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Phone: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>,
            Mail: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>,
            Sun: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            ArrowUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>,
            ArrowDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>,
            Calendar: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"></polyline></svg>,
            Activity: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>,
            TrendingUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
            TrendingDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        };

        // --- MultiSelect Dropdown com Busca ---
        const MultiSelectDropdown = ({ label, options, selected, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const filteredOptions = options.filter(opt => 
                opt.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const toggleOption = (option) => {
                let newSelected;
                if (option === 'Todas') {
                    newSelected = ['Todas'];
                } else {
                    if (selected.includes('Todas')) {
                        newSelected = [option];
                    } else {
                        if (selected.includes(option)) {
                            newSelected = selected.filter(s => s !== option);
                            if (newSelected.length === 0) newSelected = ['Todas'];
                        } else {
                            newSelected = [...selected, option];
                        }
                    }
                }
                onChange(newSelected);
            };

            const getDisplayText = () => {
                if (selected.includes('Todas')) return 'Todas';
                if (selected.length === 0) return 'Selecione...';
                if (selected.length === 1) return selected[0];
                return `${selected.length} selecionadas`;
            };

            return (
                <div className="flex flex-col relative" ref={dropdownRef}>
                    {label && <span className="input-label mb-1">{label}</span>}
                    <div className="relative">
                        <button 
                            onClick={() => setIsOpen(!isOpen)}
                            className={`flex items-center justify-between w-full pl-3 pr-3 py-2 text-sm bg-white dark:bg-slate-800 border ${isOpen ? 'border-blue-500 ring-2 ring-blue-500/20' : 'border-slate-200 dark:border-slate-700'} rounded-lg transition-all text-slate-700 dark:text-slate-200 hover:border-slate-300 dark:hover:border-slate-600 shadow-sm min-w-[180px]`}
                        >
                            <span className="flex items-center gap-2 truncate max-w-[200px]">
                                <Icons.Filter className="w-4 h-4 text-slate-400" />
                                {getDisplayText()}
                            </span>
                            <Icons.ChevronDown className={`w-4 h-4 ml-2 transition-transform ${isOpen ? 'rotate-180 text-blue-500' : 'text-slate-400'}`} />
                        </button>

                        {isOpen && (
                            <div className="absolute z-50 mt-2 w-64 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl picker-popover overflow-hidden animate-enter top-full left-0 flex flex-col max-h-80">
                                <div className="p-2 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
                                    <div className="relative">
                                        <Icons.Search className="absolute left-2 top-2 w-3 h-3 text-slate-400" />
                                        <input 
                                            type="text" 
                                            placeholder="Buscar..." 
                                            className="w-full pl-7 pr-2 py-1 text-xs border border-slate-200 dark:border-slate-600 rounded bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 focus:outline-none focus:border-blue-500"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            autoFocus
                                        />
                                    </div>
                                </div>
                                <div className="p-2 overflow-y-auto custom-scrollbar flex-1">
                                    <div 
                                        onClick={() => toggleOption('Todas')}
                                        className={`flex items-center gap-2 px-3 py-2 rounded-md cursor-pointer text-sm ${selected.includes('Todas') ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-bold' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'}`}
                                    >
                                        <div className={`w-4 h-4 rounded border flex items-center justify-center ${selected.includes('Todas') ? 'bg-blue-500 border-blue-500 text-white' : 'border-slate-300'}`}>
                                            {selected.includes('Todas') && <Icons.Check width={12} />}
                                        </div>
                                        Todas as Usinas
                                    </div>
                                    <div className="h-px bg-slate-100 dark:bg-slate-700 my-1"></div>
                                    {filteredOptions.length > 0 ? (
                                        filteredOptions.map(opt => (
                                            <div 
                                                key={opt}
                                                onClick={() => toggleOption(opt)}
                                                className={`flex items-center gap-2 px-3 py-2 rounded-md cursor-pointer text-sm ${selected.includes(opt) ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-medium' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'}`}
                                            >
                                                <div className={`w-4 h-4 rounded border flex items-center justify-center ${selected.includes(opt) ? 'bg-blue-500 border-blue-500 text-white' : 'border-slate-300'}`}>
                                                    {selected.includes(opt) && <Icons.Check width={12} />}
                                                </div>
                                                {opt}
                                            </div>
                                        ))
                                    ) : (
                                        <div className="text-xs text-slate-400 text-center py-2">Nenhuma opção encontrada</div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Month Picker ---
        const MonthPicker = ({ label, value, onChange, isMulti = false }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [viewYear, setViewYear] = useState(new Date().getFullYear());
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            useEffect(() => {
                if (value) {
                    const firstVal = Array.isArray(value) ? value[0] : value;
                    if (firstVal && firstVal.length >= 4) {
                        setViewYear(parseInt(firstVal.split('-')[0]));
                    }
                }
            }, []);

            const months = Utils.date.getMonths();

            const handleMonthClick = (monthIndex) => {
                const monthStr = String(monthIndex + 1).padStart(2, '0');
                const selectedPeriod = `${viewYear}-${monthStr}`;

                if (isMulti) {
                    let newValues = Array.isArray(value) ? [...value] : [];
                    if (newValues.includes(selectedPeriod)) {
                        newValues = newValues.filter(v => v !== selectedPeriod);
                    } else {
                        newValues.push(selectedPeriod);
                    }
                    onChange(newValues);
                } else {
                    onChange(selectedPeriod);
                    setIsOpen(false);
                }
            };

            const isSelected = (monthIndex) => {
                const monthStr = String(monthIndex + 1).padStart(2, '0');
                const period = `${viewYear}-${monthStr}`;
                if (Array.isArray(value)) {
                    return value.includes(period);
                }
                return value === period;
            };

            const getDisplayText = () => {
                if (isMulti) {
                    if (!value || value.length === 0) return 'Selecione...';
                    if (value.length === 1) return Utils.date.formatNice(value[0]);
                    return `${value.length} meses`;
                } else {
                    return value ? Utils.date.formatNice(value) : 'Selecione...';
                }
            };

            return (
                <div className="flex flex-col relative" ref={dropdownRef}>
                    {label && <span className="input-label mb-1">{label}</span>}
                    <div className="relative">
                        <button 
                            onClick={() => setIsOpen(!isOpen)}
                            className={`flex items-center justify-between w-full pl-3 pr-3 py-2 text-sm bg-white dark:bg-slate-800 border ${isOpen ? 'border-blue-500 ring-2 ring-blue-500/20' : 'border-slate-200 dark:border-slate-700'} rounded-lg transition-all text-slate-700 dark:text-slate-200 hover:border-slate-300 dark:hover:border-slate-600 shadow-sm min-w-[180px]`}
                        >
                            <span className="flex items-center gap-2 truncate">
                                <Icons.Calendar className="w-4 h-4 text-slate-400" />
                                {getDisplayText()}
                            </span>
                            <Icons.ChevronDown className={`w-4 h-4 ml-2 transition-transform ${isOpen ? 'rotate-180 text-blue-500' : 'text-slate-400'}`} />
                        </button>

                        {isOpen && (
                            <div className="absolute z-50 mt-2 w-64 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl picker-popover overflow-hidden animate-enter p-3 top-full left-0">
                                <div className="flex justify-between items-center mb-3 pb-2 border-b border-slate-100 dark:border-slate-700">
                                    <button onClick={() => setViewYear(viewYear - 1)} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-slate-500 dark:text-slate-400"><Icons.ChevronLeft width={16}/></button>
                                    <span className="font-bold text-slate-700 dark:text-slate-200">{viewYear}</span>
                                    <button onClick={() => setViewYear(viewYear + 1)} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-slate-500 dark:text-slate-400"><Icons.ChevronRight width={16}/></button>
                                </div>
                                <div className="grid grid-cols-3 gap-2">
                                    {months.map((m, i) => {
                                        const active = isSelected(i);
                                        return (
                                            <button 
                                                key={m} 
                                                onClick={() => handleMonthClick(i)}
                                                className={`text-xs py-2 rounded-md font-medium transition-colors ${
                                                    active 
                                                    ? 'bg-blue-600 text-white shadow-md shadow-blue-500/30' 
                                                    : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'
                                                }`}
                                            >
                                                {m}
                                            </button>
                                        )
                                    })}
                                </div>
                                {isMulti && (
                                    <div className="mt-3 pt-2 border-t border-slate-100 dark:border-slate-700 flex justify-between">
                                        <button onClick={() => onChange([])} className="text-xs text-slate-500 hover:text-red-500">Limpar</button>
                                        <button onClick={() => setIsOpen(false)} className="text-xs text-blue-600 font-bold">Pronto</button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- DRE Component ---
        const ControladoriaDRE = ({ rawData, mappings, periodoIni, periodoFim, usinasSelecionadas, isDark }) => {
            const months = useMemo(() => {
                if (!periodoIni || !periodoFim) return [];
                let start = new Date(periodoIni + '-01T00:00:00');
                let end = new Date(periodoFim + '-01T00:00:00');
                start = new Date(start.valueOf() + start.getTimezoneOffset() * 60000);
                end = new Date(end.valueOf() + end.getTimezoneOffset() * 60000);

                const list = [];
                while (start <= end) {
                    const mStr = (start.getMonth() + 1).toString().padStart(2, '0');
                    const yStr = start.getFullYear();
                    const id = `${yStr}-${mStr}`;
                    const label = `${Utils.date.getMonths()[start.getMonth()]} ${yStr.toString().substring(2)}`;
                    list.push({ id, label });
                    start.setMonth(start.getMonth() + 1);
                }
                return list;
            }, [periodoIni, periodoFim]);

            const dreData = useMemo(() => {
                const structure = {
                    receita: { title: 'Receita Bruta', items: {}, total: {}, type: 'credit' },
                    custo_var: { title: '(-) Custos Variáveis', items: {}, total: {}, type: 'debit' },
                    margem: { title: '(=) Margem de Contribuição', isResult: true },
                    custo_fix: { title: '(-) Custos Fixos', items: {}, total: {}, type: 'debit' },
                    despesa: { title: '(-) Despesas', items: {}, total: {}, type: 'debit' },
                    ebitda: { title: '(=) Resultado Operacional', isResult: true }
                };

                months.forEach(m => {
                    structure.receita.total[m.id] = 0;
                    structure.custo_var.total[m.id] = 0;
                    structure.custo_fix.total[m.id] = 0;
                    structure.despesa.total[m.id] = 0;
                });

                const filteredRaw = rawData.filter(r => 
                    usinasSelecionadas.includes('Todas') || usinasSelecionadas.includes(r.usina)
                );

                filteredRaw.forEach(row => {
                    if (row.periodo < periodoIni || row.periodo > periodoFim) return;

                    Object.entries(row.detalhes || {}).forEach(([contaOriginal, valor]) => {
                        const val = parseFloat(valor) || 0;
                        if (val === 0) return;

                        const map = mappings.find(m => m.original_name === contaOriginal);
                        if (!map) return; 

                        let groupKey = null;
                        if (map.tipo === 'Receita') groupKey = 'receita';
                        else if (map.tipo === 'Custo' && map.classificacao === 'Variável') groupKey = 'custo_var';
                        else if (map.tipo === 'Custo' && map.classificacao === 'Fixo') groupKey = 'custo_fix';
                        else if (map.tipo === 'Despesa') groupKey = 'despesa';

                        if (groupKey) {
                            const friendlyName = map.friendly_name;
                            if (!structure[groupKey].items[friendlyName]) {
                                structure[groupKey].items[friendlyName] = {};
                                months.forEach(m => structure[groupKey].items[friendlyName][m.id] = 0);
                            }
                            if (structure[groupKey].items[friendlyName][row.periodo] !== undefined) {
                                structure[groupKey].items[friendlyName][row.periodo] += val;
                            }
                            if (structure[groupKey].total[row.periodo] !== undefined) {
                                structure[groupKey].total[row.periodo] += val;
                            }
                        }
                    });
                });

                return structure;
            }, [rawData, mappings, months, usinasSelecionadas, periodoIni, periodoFim]);

            const getStats = (rowObj) => {
                let sum = 0;
                let count = 0;
                months.forEach(m => {
                    const val = rowObj[m.id] || 0;
                    sum += val;
                    if (val !== 0) count++;
                });
                return { total: sum, avg: count > 0 ? sum / count : 0 };
            };

            const renderRow = (label, values, isHeader = false, indent = false) => {
                const stats = getStats(values);
                return (
                    <tr key={label} className={`border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors ${isHeader ? 'font-bold bg-slate-50 dark:bg-slate-800 text-slate-800 dark:text-white' : 'text-slate-600 dark:text-slate-300'}`}>
                        <td className={`px-4 py-2 whitespace-nowrap ${indent ? 'pl-8' : ''}`}>{label}</td>
                        {months.map(m => (
                            <td key={m.id} className="px-2 py-2 text-right text-xs whitespace-nowrap">
                                {values[m.id] ? Utils.formatters.currency(values[m.id]) : '-'}
                            </td>
                        ))}
                        <td className="px-2 py-2 text-right text-xs font-bold bg-yellow-50/50 dark:bg-yellow-900/10 text-slate-800 dark:text-slate-200">
                            {Utils.formatters.currency(stats.avg)}
                        </td>
                        <td className="px-2 py-2 text-right text-xs font-bold bg-slate-100 dark:bg-slate-800">
                            {Utils.formatters.currency(stats.total)}
                        </td>
                    </tr>
                );
            };

            const renderResultRow = (key, title) => {
                const values = {};
                months.forEach(m => {
                    const rec = dreData.receita.total[m.id] || 0;
                    const cv = dreData.custo_var.total[m.id] || 0;
                    const cf = dreData.custo_fix.total[m.id] || 0;
                    const desp = dreData.despesa.total[m.id] || 0;

                    if (key === 'margem') values[m.id] = rec - cv; 
                    if (key === 'ebitda') values[m.id] = (rec - cv) - cf - desp; 
                });
                
                const stats = getStats(values);
                const colorClass = key === 'ebitda' 
                    ? (stats.total >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400') 
                    : 'text-blue-600 dark:text-blue-400';

                return (
                    <tr key={key} className="border-y-2 border-slate-200 dark:border-slate-600 bg-slate-100 dark:bg-slate-800 font-bold text-sm">
                        <td className="px-4 py-3">{title}</td>
                        {months.map(m => (
                            <td key={m.id} className={`px-2 py-3 text-right whitespace-nowrap ${values[m.id] < 0 ? 'text-red-500' : ''}`}>
                                {Utils.formatters.currency(values[m.id])}
                            </td>
                        ))}
                        <td className={`px-2 py-3 text-right bg-yellow-100/50 dark:bg-yellow-900/20 ${colorClass}`}>
                            {Utils.formatters.currency(stats.avg)}
                        </td>
                        <td className={`px-2 py-3 text-right ${colorClass}`}>
                            {Utils.formatters.currency(stats.total)}
                        </td>
                    </tr>
                );
            };

            return (
                <div className="glass-card overflow-hidden">
                    <div className="overflow-x-auto custom-scrollbar">
                        <table className="w-full text-sm text-left">
                            <thead className="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-10">
                                <tr>
                                    <th className="px-4 py-3 min-w-[200px]">DRE / Conta</th>
                                    {months.map(m => <th key={m.id} className="px-2 py-3 text-right min-w-[100px]">{m.label}</th>)}
                                    <th className="px-2 py-3 text-right min-w-[100px] bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-500">Média</th>
                                    <th className="px-2 py-3 text-right min-w-[120px] bg-slate-100 dark:bg-slate-700">Total Período</th>
                                </tr>
                            </thead>
                            <tbody>
                                {renderRow(dreData.receita.title, dreData.receita.total, true)}
                                {Object.entries(dreData.receita.items).sort().map(([k, v]) => renderRow(k, v, false, true))}
                                
                                {renderRow(dreData.custo_var.title, dreData.custo_var.total, true)}
                                {Object.entries(dreData.custo_var.items).sort().map(([k, v]) => renderRow(k, v, false, true))}

                                {renderResultRow('margem', dreData.margem.title)}

                                {renderRow(dreData.custo_fix.title, dreData.custo_fix.total, true)}
                                {Object.entries(dreData.custo_fix.items).sort().map(([k, v]) => renderRow(k, v, false, true))}

                                {renderRow(dreData.despesa.title, dreData.despesa.total, true)}
                                {Object.entries(dreData.despesa.items).sort().map(([k, v]) => renderRow(k, v, false, true))}

                                {renderResultRow('ebitda', dreData.ebitda.title)}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- Core Components ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null, errorInfo: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Erro capturado:", error, errorInfo); this.setState({ errorInfo }); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-slate-100 dark:bg-slate-900 p-4">
                            <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-2xl max-w-3xl w-full border-l-8 border-red-500">
                                <h1 className="text-2xl font-bold text-red-600 dark:text-red-400 mb-4">Ocorreu um erro na aplicação</h1>
                                <div className="bg-red-50 dark:bg-red-900/20 p-4 rounded border border-red-100 dark:border-red-800 mb-6 overflow-auto max-h-60">
                                    <p className="font-mono text-sm text-red-800 dark:text-red-300 font-bold mb-2">{this.state.error && this.state.error.toString()}</p>
                                    <pre className="text-xs text-red-600 dark:text-red-400 whitespace-pre-wrap">{this.state.errorInfo && this.state.errorInfo.componentStack}</pre>
                                </div>
                                <div className="flex gap-4">
                                    <button onClick={() => window.location.reload()} className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">Recarregar Página</button>
                                    <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="px-6 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded hover:bg-slate-300 dark:hover:bg-slate-600 font-bold">Limpar Cache</button>
                                </div>
                            </div>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        const CustomTooltip = ({ active, payload, label, isDark }) => {
            if (active && payload && payload.length) {
                const bgClass = isDark ? 'bg-slate-800 border-slate-700 text-slate-200' : 'bg-white border-slate-200 text-slate-800';
                return (
                    <div className={`p-3 border shadow-xl rounded-lg text-sm z-50 ${bgClass}`}>
                        <p className="font-bold mb-2 border-b border-slate-600/20 pb-1">{label}</p>
                        {payload.map((entry, index) => (
                            <div key={index} className="flex items-center justify-between gap-4 mb-1 last:mb-0">
                                <div className="flex items-center gap-2" style={{ color: entry.color }}>
                                    <span className="w-2 h-2 rounded-full" style={{ backgroundColor: entry.color }}></span>
                                    <span className="font-medium truncate max-w-[200px]">{entry.name}:</span>
                                </div>
                                <div className="flex gap-2 text-right">
                                    <span className="font-bold">{typeof entry.value === 'number' ? entry.value.toLocaleString('pt-BR', {maximumFractionDigits: 2}) : entry.value}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                );
            }
            return null;
        };

        const StatusLog = ({ logs, clearLogs }) => {
            if (logs.length === 0) return null;
            return (
                <div className="fixed bottom-4 right-4 z-50 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-4 rounded-lg shadow-xl w-80 max-h-60 overflow-y-auto animate-enter">
                    <div className="flex justify-between mb-2 border-b dark:border-slate-700 pb-1">
                        <span className="font-bold text-xs text-slate-700 dark:text-slate-300">Notificações</span>
                        <button onClick={clearLogs} className="text-xs text-blue-500 hover:underline">Limpar</button>
                    </div>
                    {logs.map((l, i) => (
                        <div key={i} className={`text-xs p-2 mb-1 rounded border-l-2 ${l.type === 'error' ? 'bg-red-50 dark:bg-red-900/30 border-red-500 text-red-700 dark:text-red-300' : 'bg-blue-50 dark:bg-blue-900/30 border-blue-500 text-slate-700 dark:text-slate-300'}`}>{l.msg}</div>
                    ))}
                </div>
            );
        };

        const Card = ({ title, value, subtext, iconName, color = "blue" }) => {
            const Icon = Icons[iconName.charAt(0).toUpperCase() + iconName.slice(1)] || Icons.Database;
            const styles = {
                blue: { bg: "bg-gradient-to-br from-white to-blue-50/50 dark:from-slate-800 dark:to-blue-900/20", icon: "bg-blue-100 text-blue-600 dark:bg-blue-900/50 dark:text-blue-400", border: "border-blue-100 dark:border-blue-900/30" },
                emerald: { bg: "bg-gradient-to-br from-white to-emerald-50/50 dark:from-slate-800 dark:to-emerald-900/20", icon: "bg-emerald-100 text-emerald-600 dark:bg-emerald-900/50 dark:text-emerald-400", border: "border-emerald-100 dark:border-emerald-900/30" },
                sky: { bg: "bg-gradient-to-br from-white to-sky-50/50 dark:from-slate-800 dark:to-sky-900/20", icon: "bg-sky-100 text-sky-600 dark:bg-sky-900/50 dark:text-sky-400", border: "border-sky-100 dark:border-sky-900/30" },
                orange: { bg: "bg-gradient-to-br from-white to-orange-50/50 dark:from-slate-800 dark:to-orange-900/20", icon: "bg-orange-100 text-orange-600 dark:bg-orange-900/50 dark:text-orange-400", border: "border-orange-100 dark:border-orange-900/30" },
                purple: { bg: "bg-gradient-to-br from-white to-purple-50/50 dark:from-slate-800 dark:to-purple-900/20", icon: "bg-purple-100 text-purple-600 dark:bg-purple-900/50 dark:text-purple-400", border: "border-purple-100 dark:border-purple-900/30" },
                gray: { bg: "bg-gradient-to-br from-white to-slate-50/50 dark:from-slate-800 dark:to-slate-700/20", icon: "bg-slate-100 text-slate-500 dark:bg-slate-700/50 dark:text-slate-400", border: "border-slate-100 dark:border-slate-700" },
                green: { bg: "bg-gradient-to-br from-white to-green-50/50 dark:from-slate-800 dark:to-green-900/20", icon: "bg-green-100 text-green-600 dark:bg-green-900/50 dark:text-green-400", border: "border-green-100 dark:border-green-900/30" }
            };
            const s = styles[color] || styles.blue;
            return (
                <div className={`glass-card p-6 flex justify-between items-start hover:shadow-lg hover:-translate-y-1 transition-all duration-300 border ${s.border} ${s.bg}`}>
                    <div>
                        <p className="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">{title}</p>
                        <h3 className="text-2xl font-extrabold text-slate-800 dark:text-white tracking-tight">{value}</h3>
                        {subtext && <p className="text-xs text-slate-400 dark:text-slate-500 mt-1 font-medium">{subtext}</p>}
                    </div>
                    <div className={`p-3 rounded-xl shadow-sm ${s.icon}`}><Icon /></div>
                </div>
            );
        };

        const DataTable = ({ data, onNotify, onExportAll, title }) => {
            const [currentPage, setCurrentPage] = useState(1);
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
            const rowsPerPage = 20;

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            const sortedData = useMemo(() => {
                let sortableItems = [...data];
                if (sortConfig.key !== null) {
                    sortableItems.sort((a, b) => {
                        let aVal = a[sortConfig.key];
                        let bVal = b[sortConfig.key];
                        
                        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                        if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return sortableItems;
            }, [data, sortConfig]);

            const headers = data.length > 0 ? Object.keys(data[0]).filter(k => k !== 'detalhes') : [];
            const totalPages = Math.ceil(sortedData.length / rowsPerPage);
            const currentRows = sortedData.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);
            const goToPage = (p) => setCurrentPage(Math.min(Math.max(1, p), totalPages));
            
            const exportLocal = () => {
                const XLSX = window.XLSX;
                if (!XLSX) { if (onNotify) onNotify("Biblioteca XLSX não carregada.", "error"); return; }
                if (data.length === 0) { if (onNotify) onNotify("Sem dados.", "error"); return; }
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Dados");
                XLSX.writeFile(wb, "Exportacao_Parcial.xlsx");
            };

            if(data.length === 0) return <div className="p-8 text-center text-slate-400 dark:text-slate-500">Sem dados para exibir.</div>;
            
            return (
                <div className="glass-card overflow-hidden">
                    <div className="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h3 className="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2 text-sm"><Icons.Table /> {title || `Visualizando ${data.length} registros`}</h3>
                        <div className="flex gap-2">
                            <button onClick={onExportAll || exportLocal} className="text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/30 border border-green-200 dark:border-green-800 px-3 py-1.5 rounded text-xs flex items-center gap-1 transition-colors font-bold"><Icons.Download /> {onExportAll ? 'Baixar TUDO (Excel)' : 'Exportar Visualização'}</button>
                            <div className="border-l border-slate-300 dark:border-slate-600 mx-2 h-6"></div>
                            <span className="text-xs text-slate-400 dark:text-slate-500 self-center">Página {currentPage} de {totalPages}</span>
                            <button onClick={() => goToPage(currentPage-1)} disabled={currentPage===1} className="p-1 border dark:border-slate-600 rounded hover:bg-white dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 disabled:opacity-30"><Icons.ChevronLeft /></button>
                            <button onClick={() => goToPage(currentPage+1)} disabled={currentPage===totalPages} className="p-1 border dark:border-slate-600 rounded hover:bg-white dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 disabled:opacity-30"><Icons.ChevronRight /></button>
                        </div>
                    </div>
                    <div className="overflow-x-auto custom-scrollbar">
                        <table className="w-full text-xs text-left text-slate-600 dark:text-slate-300">
                            <thead className="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700">
                                <tr>
                                    {headers.map(h => (
                                        <th key={h} onClick={() => requestSort(h)} className="px-4 py-3 font-semibold whitespace-nowrap cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors group select-none">
                                            <div className="flex items-center gap-1">
                                                {h}
                                                <span className={`text-slate-300 dark:text-slate-600 ${sortConfig.key === h ? 'text-blue-500 dark:text-blue-400' : ''}`}>
                                                    {sortConfig.key === h ? (sortConfig.direction === 'asc' ? <Icons.ArrowUp width={12} /> : <Icons.ArrowDown width={12} />) : <div className="h-3 w-3 opacity-0 group-hover:opacity-50"><Icons.ArrowDown width={12} /></div>}
                                                </span>
                                            </div>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {currentRows.map((row, i) => (
                                    <tr key={i} className={`border-b border-slate-50 dark:border-slate-800 transition-colors ${i % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-slate-50/50 dark:bg-slate-800/30'} hover:bg-blue-50/30 dark:hover:bg-blue-900/20`}>
                                        {headers.map(h => { 
                                            const val = row[h]; const displayVal = typeof val === 'number' ? val.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : val; 
                                            return <td key={h} className="px-4 py-2.5 whitespace-nowrap">{displayVal}</td> 
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 3. AUTHENTICATION MODULE
        // ==========================================
        const LoginScreen = ({ onLogin, loading }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            return (
                <div className="min-h-screen flex bg-slate-50 dark:bg-slate-900 font-sans">
                    <div className="hidden md:block md:w-1/2 bg-cover bg-center relative" style={{ backgroundImage: "url('https://jsmnykikflkjceiqfmne.supabase.co/storage/v1/object/public/LOGOS/Loginpage.jpg')" }}>
                        <div className="absolute inset-0 bg-gradient-to-r from-black/20 to-transparent"></div>
                    </div>
                    <div className="w-full md:w-1/2 flex items-center justify-center p-8 md:p-12 bg-white dark:bg-slate-900">
                        <div className="w-full max-w-md space-y-8">
                            <div className="text-center">
                                <div className="inline-block p-6 rounded-2xl bg-slate-50 dark:bg-slate-800 mb-6 shadow-sm logo-interactive animate-enter cursor-pointer">
                                    <img src="https://jsmnykikflkjceiqfmne.supabase.co/storage/v1/object/public/LOGOS/Logo_com_texto-removebg-preview.png" alt="SAP Analytics Logo" className="h-40 mx-auto object-contain" />
                                </div>
                                <h2 className="text-3xl font-bold tracking-tight text-slate-900 dark:text-white">Bem-vindo de volta</h2>
                                <p className="mt-2 text-sm text-slate-600 dark:text-slate-400">Acesse sua conta para gerenciar os dados</p>
                            </div>
                            <form className="mt-8 space-y-6" onSubmit={(e) => { e.preventDefault(); onLogin(email, password); }}>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Email Corporativo</label>
                                        <div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><Icons.User /></div><input type="email" required className="block w-full pl-10 pr-3 py-3 border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 transition-colors outline-none" placeholder="seu@email.com" value={email} onChange={e => setEmail(e.target.value)} /></div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Senha</label>
                                        <div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><Icons.Lock /></div><input type="password" required className="block w-full pl-10 pr-3 py-3 border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 transition-colors outline-none" placeholder="••••••••" value={password} onChange={e => setPassword(e.target.value)} /></div>
                                    </div>
                                </div>
                                <div><button type="submit" disabled={loading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-bold rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all disabled:opacity-70 shadow-lg shadow-blue-200 dark:shadow-blue-900/30">{loading ? <span className="loader h-5 w-5 border-2 border-white rounded-full border-t-transparent"></span> : 'Entrar na Plataforma'}</button></div>
                            </form>
                            <div className="mt-6 text-center"><p className="text-xs text-slate-400 dark:text-slate-500">&copy; {new Date().getFullYear()} SAP Analytics. Todos os direitos reservados.</p></div>
                        </div>
                    </div>
                </div>
            );
        };

        const ControladoriaDashboardAnalitico = ({ stats, loading, tipo, setTipo, onDrillDown, periodo, periodoComp, isDark }) => {
            const chartColors = getChartColors(isDark);
            const isPositiveGood = tipo === 'Receita' || tipo === 'Resultado';
            const getVariationColor = (val) => {
                if(val === 0) return 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300';
                if(isPositiveGood) return val > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400';
                return val > 0 ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400' : 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400';
            };
            const getArrow = (val) => val > 0 ? '▲' : (val < 0 ? '▼' : '-');
            
            const totalValue = (stats || []).reduce((acc, curr) => acc + (parseFloat(curr.valor_atual) || 0), 0);

            const safeStats = (stats || []).map(row => {
                const val = parseFloat(row.valor_atual) || 0;
                let perc = parseFloat(row.perc_receita) || 0;
                if (Math.abs(perc) < 0.01 && totalValue !== 0) {
                    perc = (val / totalValue) * 100;
                }
                return {
                    ...row,
                    valor_atual: val,
                    rs_m3: parseFloat(row.rs_m3) || 0,
                    perc_receita: perc,
                    variacao_perc: parseFloat(row.variacao_perc) || 0
                };
            });

            if (safeStats.length === 0) return (
                <div className="flex flex-col items-center justify-center h-64 text-slate-400 dark:text-slate-500"><Icons.Info /><p className="mt-2 font-bold">Sem dados.</p><p className="text-sm text-center">Verifique o período ou o cadastro De/Para para "{tipo}".</p></div>
            );

            const topVariacoes = [...safeStats]
                .filter(i => isPositiveGood ? (i.variacao_perc < 0 && Math.abs(i.valor_atual) > 500) : (i.variacao_perc > 0 && i.valor_atual > 500))
                .sort((a,b) => isPositiveGood ? a.variacao_perc - b.variacao_perc : b.variacao_perc - a.variacao_perc)
                .slice(0, 3);

            const tabs = [{ id: 'Receita', color: 'emerald' }, { id: 'Resultado', color: 'blue' }, { id: 'Custo', color: 'orange' }, { id: 'Despesa', color: 'red' }];

            return (
                <div className="space-y-6">
                    <div className="flex justify-center mb-4"><div className="bg-slate-200 dark:bg-slate-700 p-1 rounded-lg flex shadow-inner gap-1">{tabs.map(t => (<button key={t.id} onClick={() => setTipo(t.id)} className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${tipo === t.id ? `bg-white dark:bg-slate-600 text-${t.color}-600 dark:text-${t.color}-400 shadow` : 'text-slate-500 dark:text-slate-400'}`}>{t.id}s</button>))}</div></div>
                    
                    <div className="flex gap-6 items-start flex-col lg:flex-row">
                        <div className="flex-1 glass-card overflow-hidden w-full relative z-10">
                            <div className="p-4 bg-slate-50 dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center"><h3 className="font-bold text-sm text-slate-700 dark:text-slate-200">Detalhamento de {tipo}s</h3><span className="text-xs text-slate-400">Comparando: {periodo} vs {periodoComp || '...'}</span></div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                                    <thead className="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700">
                                        <tr>
                                            <th className="px-6 py-3">Conta</th>
                                            <th className="px-6 py-3 text-right">Valor Total</th>
                                            <th className="px-6 py-3 text-right">R$ / m³</th>
                                            <th className="px-6 py-3 text-right">% Repres.</th>
                                            <th className="px-6 py-3 text-right">Var. Período</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {safeStats.map((row, i) => (
                                            <tr key={i} onClick={() => onDrillDown(row.conta)} className="border-b border-slate-50 dark:border-slate-800 interactive-row transition-colors">
                                                <td className="px-6 py-3 font-medium text-slate-800 dark:text-slate-200">{row.conta}</td>
                                                <td className="px-6 py-3 text-right">{Utils.formatters.currency(row.valor_atual)}</td>
                                                <td className="px-6 py-3 text-right font-mono text-slate-600 dark:text-slate-400">{Utils.formatters.currency(row.rs_m3)}</td>
                                                <td className="px-6 py-3 text-right">
                                                    <div className="flex items-center justify-end gap-2">
                                                        <span className="text-xs font-bold text-slate-700 dark:text-slate-300">{row.perc_receita.toFixed(2)}%</span>
                                                        <div className="w-16 h-1.5 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                                            <div className={`h-full ${isPositiveGood ? 'bg-emerald-500' : 'bg-red-500'}`} style={{ width: `${Math.min(row.perc_receita, 100)}%` }}></div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-3 text-right">
                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${getVariationColor(row.variacao_perc)}`}>
                                                        {getArrow(row.variacao_perc)} {Math.abs(row.variacao_perc).toFixed(1)}%
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="w-full lg:w-80 space-y-4"><div className={`glass-card p-5 border-t-4 ${isPositiveGood ? 'border-orange-500' : 'border-red-500'}`}><h4 className="font-bold text-slate-800 dark:text-white mb-3 flex items-center gap-2"><span className={isPositiveGood ? 'text-orange-500' : 'text-red-500'}><Icons.BarChart2 /></span> {isPositiveGood ? 'Quedas Relevantes' : 'Aumentos de Custo'}</h4><p className="text-xs text-slate-500 dark:text-slate-400 mb-4">Maiores impactos negativos.</p>{topVariacoes.length > 0 ? (<div className="space-y-3">{topVariacoes.map((item, idx) => (<div key={idx} onClick={() => onDrillDown(item.conta)} className={`p-3 rounded-lg border interactive-row ${isPositiveGood ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-100 dark:border-orange-900/30' : 'bg-red-50 dark:bg-red-900/20 border-red-100 dark:border-red-900/30'}`}><p className="text-xs font-bold text-slate-700 dark:text-slate-300 mb-1">{item.conta}</p><div className="flex justify-between items-end"><span className={`${isPositiveGood ? 'text-orange-600 dark:text-orange-400' : 'text-red-600 dark:text-red-400'} font-bold text-sm`}>{isPositiveGood ? '▼' : '▲'} {Math.abs(item.variacao_perc).toFixed(1)}%</span><span className="text-xs text-slate-400">R$ {item.valor_atual.toLocaleString('pt-BR', {notation: 'compact'})}</span></div></div>))}</div>) : (<div className="text-center py-4 text-slate-400 text-xs">Nenhuma variação crítica.</div>)}</div></div>
                    </div>
                </div>
            );
        };

        const ControladoriaDashboardCentroCusto = ({ supabaseClient, periodo, contas, onNotify, initialConta, onBack, isDark }) => {
            const [selectedConta, setSelectedConta] = useState(initialConta || (contas.length > 0 ? contas[0] : ''));
            const [data, setData] = useState({ ranking: [], evolucao: [] });
            const chartColors = getChartColors(isDark);
            
            useEffect(() => { if(contas.length > 0 && !selectedConta) setSelectedConta(contas[0]); }, [contas]);

            const fetchData = async () => {
                if (!selectedConta || !periodo) return;
                try {
                    const { data: ranking, error: errRank } = await supabaseClient.rpc('get_controladoria_detalhe_conta', { p_periodo: periodo, p_conta: selectedConta });
                    if (errRank) throw errRank;
                    const { data: evolucao, error: errEvo } = await supabaseClient.rpc('get_controladoria_evolucao_conta', { p_conta: selectedConta, p_periodo_fim: periodo });
                    if (errEvo) throw errEvo;
                    const safeRanking = (ranking || []).map(r => ({ ...r, valor_atual: parseFloat(r.valor_atual)||0, vol_atual: parseFloat(r.vol_atual)||0, rs_m3_atual: parseFloat(r.rs_m3_atual)||0, media_12m: parseFloat(r.media_12m)||0, variacao_12m_perc: parseFloat(r.variacao_12m_perc)||0 }));
                    const safeEvolucao = (evolucao || []).sort((a,b)=>a.periodo.localeCompare(b.periodo)).map(e => ({ ...e, valor_total: parseFloat(e.valor_total)||0, rs_m3_medio: parseFloat(e.rs_m3_medio)||0 }));
                    setData({ ranking: safeRanking, evolucao: safeEvolucao });
                } catch (e) { onNotify("Erro detalhe: " + e.message, "error"); }
            };

            useEffect(() => { fetchData(); }, [selectedConta, periodo]);

            const totalGasto = data.ranking.reduce((acc, curr) => acc + curr.valor_atual, 0);
            const totalVol = data.ranking.reduce((acc, curr) => acc + curr.vol_atual, 0);
            const mediaRsM3 = totalVol > 0 ? totalGasto / totalVol : 0;
            const trend = data.evolucao.length >= 2 ? ((data.evolucao[data.evolucao.length-1].valor_total - data.evolucao[0].valor_total) / data.evolucao[0].valor_total) * 100 : 0;
            const safeTrend = isFinite(trend) ? trend : 0;

            return (
                <div className="space-y-6">
                    <div className="flex items-center gap-4 mb-4">
                        <button onClick={onBack} className="flex items-center gap-2 text-slate-500 hover:text-purple-600 transition-colors font-medium text-sm bg-white dark:bg-slate-800 px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm"><Icons.ArrowLeft /> Voltar</button>
                        <h2 className="text-xl font-bold text-slate-800 dark:text-white">Detalhamento: <span className="text-purple-600 dark:text-purple-400">{selectedConta}</span></h2>
                    </div>
                    <div className="glass-card p-4 flex items-center gap-4 relative z-20">
                        <div className="flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-400"><Icons.Filter className="w-4 h-4" /> Alternar Centro de Custo:</div>
                        <select className="border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm w-96 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 focus:ring-2 focus:ring-purple-500 outline-none" value={selectedConta} onChange={e => setSelectedConta(e.target.value)}>
                            {contas.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                        <button onClick={fetchData} className="text-purple-600 hover:text-purple-800"><Icons.RefreshCw className="w-4 h-4" /></button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <Card title="Gasto Total (Mês)" value={Utils.formatters.currency(totalGasto)} iconName="dollar" color="purple" />
                        <Card title="Custo Unitário Médio" value={`R$ ${Utils.formatters.number(mediaRsM3)}/m³`} iconName="target" color="blue" subtext="Média global" />
                        <Card title="Volatilidade" value={`${safeTrend > 0 ? '+' : ''}${safeTrend.toFixed(1)}%`} iconName="barChart" color={safeTrend > 0 ? "orange" : "emerald"} subtext="vs 12 meses" />
                        <Card title="Volume Afetado" value={`${Utils.math.roundVolume(totalVol).toLocaleString('pt-BR')} m³`} iconName="truck" color="gray" />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="glass-card p-6 h-[400px] flex flex-col">
                            <h3 className="font-bold text-slate-800 dark:text-slate-200 mb-4">Top 10 Usinas - Maior Custo por m³</h3>
                            <ResponsiveContainer width="100%" height="100%"><BarChart layout="vertical" data={data.ranking.sort((a,b) => b.rs_m3_atual - a.rs_m3_atual).slice(0,10)} margin={{top: 5, right: 30, left: 40, bottom: 5}}><CartesianGrid strokeDasharray="3 3" horizontal={false} stroke={chartColors.grid} /><XAxis type="number" tick={{fill: chartColors.text}} tickFormatter={(val) => `R$ ${val}`} /><YAxis dataKey="usina" type="category" width={50} tick={{fontSize: 11, fontWeight: 'bold', fill: chartColors.text}} /><Tooltip content={<CustomTooltip isDark={isDark} />} /><Bar dataKey="rs_m3_atual" fill={chartColors.controladoria} radius={[0, 4, 4, 0]} name="R$/m³" barSize={20}>{data.ranking.slice(0,10).map((entry, index) => (<Cell key={`cell-${index}`} fill={entry.rs_m3_atual > mediaRsM3 ? chartColors.danger : chartColors.success} />))}</Bar></BarChart></ResponsiveContainer>
                        </div>
                        <div className="glass-card p-6 h-[400px] flex flex-col">
                            <h3 className="font-bold text-slate-800 dark:text-slate-200 mb-4">Evolução Histórica (12 Meses)</h3>
                            <ResponsiveContainer width="100%" height="100%"><ComposedChart data={data.evolucao} margin={{top: 10, right: 10, left: 0, bottom: 0}}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke={chartColors.grid} /><XAxis dataKey="periodo" tick={{fontSize: 10, fill: chartColors.text}} /><YAxis yAxisId="left" orientation="left" tick={{fill: chartColors.text}} tickFormatter={(val) => `R$ ${val/1000}k`} /><YAxis yAxisId="right" orientation="right" tick={{fill: chartColors.text}} tickFormatter={(val) => `R$ ${val}`} /><Tooltip content={<CustomTooltip isDark={isDark} />} /><Legend /><Bar yAxisId="left" dataKey="valor_total" name="Valor Total" fill={chartColors.controladoria_dark} barSize={30} fillOpacity={0.6} /><Line yAxisId="right" type="monotone" dataKey="rs_m3_medio" name="R$/m³ Médio" stroke={chartColors.accent} strokeWidth={3} dot={{r:4}} /></ComposedChart></ResponsiveContainer>
                        </div>
                    </div>
                    <DataTable data={data.ranking} onNotify={onNotify} title="Detalhamento Completo por Usina" />
                </div>
            );
        };

        const ControladoriaImport = ({ onImport, loading }) => {
            const [date, setDate] = useState('');
            return (
                <div className="max-w-2xl mx-auto glass-card p-8">
                    <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><Icons.Upload /> Importação Controladoria</h3>
                    <div className="space-y-4">
                        <MonthPicker label="Período de Referência" value={date} onChange={setDate} />
                        <div className="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-8 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"><input type="file" accept=".xlsx, .csv" className="hidden" id="fileInput" disabled={loading || !date} onChange={(e) => { if(e.target.files[0]) onImport(e.target.files[0], date); e.target.value = null; }} /><label htmlFor="fileInput" className={`cursor-pointer flex flex-col items-center ${!date ? 'opacity-50 cursor-not-allowed' : ''}`}><div className="bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 p-4 rounded-full mb-3"><Icons.FileText /></div><span className="font-bold text-slate-700 dark:text-slate-300">Selecionar Arquivo</span></label></div>
                        {loading && <div className="text-center text-xs text-blue-600 font-medium">Processando...</div>}
                    </div>
                </div>
            );
        };

        const ControladoriaDePara = ({ supabaseClient, onNotify }) => {
            const [mappings, setMappings] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [formData, setFormData] = useState({ id: null, original_name: '', friendly_name: '', tipo: 'Despesa', classificacao: 'Variável' });
            const [availableAccounts, setAvailableAccounts] = useState([]);

            const fetchMappings = async () => { try { const { data } = await supabaseClient.from('controladoria_de_para').select('*').order('friendly_name'); setMappings(data || []); } catch (e) { onNotify(e.message, "error"); } };
            const fetchAvailableAccounts = async () => { try { const { data, error } = await supabaseClient.rpc('get_controladoria_contas'); if (error) throw error; setAvailableAccounts(data.map(d => d.conta)); } catch (e) { onNotify("Erro contas: " + e.message, "error"); } };
            
            useEffect(() => { fetchMappings(); fetchAvailableAccounts(); }, []);

            const handleEdit = (item) => {
                setFormData({
                    id: item.id,
                    original_name: item.original_name,
                    friendly_name: item.friendly_name,
                    tipo: item.tipo,
                    classificacao: item.classificacao || 'Variável'
                });
                setShowModal(true);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                try {
                    const payload = { original_name: formData.original_name, friendly_name: formData.friendly_name, tipo: formData.tipo, classificacao: (formData.tipo === 'Custo' || formData.tipo === 'Despesa') ? formData.classificacao : null };
                    const { error } = formData.id ? await supabaseClient.from('controladoria_de_para').update(payload).eq('id', formData.id) : await supabaseClient.from('controladoria_de_para').insert(payload);
                    if (error) throw error; onNotify("Salvo!", "success"); setShowModal(false); fetchMappings();
                } catch (e) { onNotify(e.message, "error"); }
            };

            const handleDelete = async (id) => { if(!confirm('Confirmar exclusão?')) return; await supabaseClient.from('controladoria_de_para').delete().eq('id', id); fetchMappings(); };

            const getTypeColor = (tipo) => { switch(tipo) { case 'Receita': return 'bg-green-100 text-green-700'; case 'Resultado': return 'bg-blue-100 text-blue-700'; case 'Custo': return 'bg-orange-100 text-orange-700'; default: return 'bg-red-100 text-red-700'; } };

            return (
                <div className="max-w-5xl mx-auto space-y-6">
                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><Icons.Settings /> Configuração De/Para</h2><button onClick={() => { setFormData({ id: null, original_name: '', friendly_name: '', tipo: 'Despesa', classificacao: 'Variável' }); setShowModal(true); }} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><Icons.Plus /> Novo De/Para</button></div>
                    <div className="glass-card overflow-hidden">
                        <table className="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                            <thead className="text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700"><tr><th className="px-6 py-3">Original</th><th className="px-6 py-3">Amigável</th><th className="px-6 py-3">Tipo</th><th className="px-6 py-3 text-right">Ações</th></tr></thead>
                            <tbody>{mappings.map(item => (<tr key={item.id} className="border-b border-slate-50 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800"><td className="px-6 py-3 font-mono">{item.original_name}</td><td className="px-6 py-3 font-bold">{item.friendly_name}</td><td className="px-6 py-3"><div className="flex gap-2"><span className={`px-2 py-1 rounded text-xs font-bold ${getTypeColor(item.tipo)}`}>{item.tipo}</span>{item.classificacao && <span className="px-2 py-1 rounded text-xs font-bold bg-slate-100 text-slate-600 border border-slate-200">{item.classificacao}</span>}</div></td><td className="px-6 py-3 text-right flex justify-end gap-3"><button onClick={() => handleEdit(item)} className="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"><Icons.Edit /></button><button onClick={() => handleDelete(item.id)} className="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition-colors"><Icons.Trash2 /></button></td></tr>))}</tbody>
                        </table>
                    </div>
                    {showModal && (
    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div className="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-lg border border-slate-200 dark:border-slate-700 shadow-2xl animate-enter">
            <h3 className="font-bold mb-4 text-slate-800 dark:text-white">{formData.id ? 'Editar' : 'Novo'} Mapeamento</h3>
            <form onSubmit={handleSave} className="space-y-4">
                <div>
                    <label className="input-label">Conta Original</label>
                    <select 
                        className="w-full border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" 
                        value={formData.original_name} 
                        onChange={e => setFormData({...formData, original_name: e.target.value})} 
                        required 
                        disabled={!!formData.id}
                    >
                        <option value="">Selecione...</option>
                        {availableAccounts.map(acc => (<option key={acc} value={acc}>{acc}</option>))}
                    </select>
                </div>
                
                <div>
                    <label className="input-label">Nome Amigável</label>
                    <input 
                        placeholder="Ex: Combustível Frota" 
                        className="w-full border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none placeholder-slate-400" 
                        value={formData.friendly_name} 
                        onChange={e=>setFormData({...formData, friendly_name:e.target.value})} 
                        required 
                    />
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="input-label">Categoria</label>
                        <select 
                            className="w-full border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" 
                            value={formData.tipo} 
                            onChange={e => setFormData({...formData, tipo: e.target.value})} 
                            required
                        >
                            <option value="Despesa">Despesa</option>
                            <option value="Custo">Custo</option>
                            <option value="Receita">Receita</option>
                            <option value="Resultado">Resultado</option>
                        </select>
                    </div>
                    {(formData.tipo === 'Custo' || formData.tipo === 'Despesa') && (
                        <div>
                            <label className="input-label">Classificação</label>
                            <select 
                                className="w-full border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" 
                                value={formData.classificacao} 
                                onChange={e => setFormData({...formData, classificacao: e.target.value})}
                            >
                                <option value="Variável">Variável</option>
                                <option value="Fixo">Fixo</option>
                            </select>
                        </div>
                    )}
                </div>
                
                <div className="flex justify-end gap-2 pt-2">
                    <button 
                        type="button" 
                        onClick={()=>setShowModal(false)} 
                        className="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors font-medium text-sm"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm transition-colors shadow-lg shadow-blue-500/30"
                    >
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
)}
</div>
    );
};
        const DieselImport = ({ onImport, loading }) => {
            const [date, setDate] = useState('');
            return (
                <div className="max-w-2xl mx-auto glass-card p-8">
                    <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><Icons.Upload /> Importação de Estoque Diesel</h3>
                    <div className="space-y-4">
                        <MonthPicker label="Mês de Referência" value={date} onChange={setDate} />
                        <div className="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-8 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"><input type="file" accept=".xlsx, .csv" className="hidden" id="fileDiesel" disabled={loading || !date} onChange={(e) => { if(e.target.files[0]) onImport(e.target.files[0], date); e.target.value = null; }} /><label htmlFor="fileDiesel" className={`cursor-pointer flex flex-col items-center ${!date ? 'opacity-50 cursor-not-allowed' : ''}`}><div className="bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 p-4 rounded-full mb-3"><Icons.Fuel /></div><span className="font-bold text-slate-700 dark:text-slate-300">Selecionar Arquivo</span></label></div>
                        {loading && <div className="text-center text-xs text-blue-600 font-medium">Processando...</div>}
                    </div>
                </div>
            );
        };

        const DieselDashboard = ({ data, loading, periodo, isDark }) => {
            const [sortConfig, setSortConfig] = useState({ key: 'usina', direction: 'asc' });
            const safeData = data || [];

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            // --- Formatação ---
            const fmt = {
                vol: (val) => (val || 0).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }),
                money: (val) => (val || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
                perc: (val) => (val || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%'
            };

            // --- Helpers de Data (Para o Cabeçalho) ---
            const getDateRange = (periodoStr) => {
                if (!periodoStr) return { ini: '-', fim: '-' };
                const [y, m] = periodoStr.split('-');
                const dateIni = new Date(y, m - 1, 1);
                const dateFim = new Date(y, m, 0);
                return {
                    ini: dateIni.toLocaleDateString('pt-BR'),
                    fim: dateFim.toLocaleDateString('pt-BR')
                };
            };
            const { ini: dataInicialTxt, fim: dataFinalTxt } = getDateRange(periodo);

            // --- Cálculos MACRO ---
            const macro = useMemo(() => {
                const totals = safeData.reduce((acc, curr) => {
                    const cm = parseFloat(curr.custo_medio) || 0;
                    
                    // Lógica para Custo Pós Ajuste
                    const volAntesAjuste = (curr.vol_final || 0) - (curr.ajuste_vol || 0);
                    const valFinanceiroTeorico = volAntesAjuste * cm;

                    return {
                        vol_inicial: acc.vol_inicial + (curr.vol_inicial || 0),
                        entradas: acc.entradas + (curr.entradas || 0),
                        saidas: acc.saidas + (curr.saidas || 0),
                        vol_final: acc.vol_final + (curr.vol_final || 0),
                        ajuste_vol: acc.ajuste_vol + (curr.ajuste_vol || 0),
                        
                        // Valores Monetários
                        vlr_inicial: acc.vlr_inicial + ((curr.vol_inicial || 0) * cm),
                        vlr_entradas: acc.vlr_entradas + ((curr.entradas || 0) * cm),
                        vlr_saidas: acc.vlr_saidas + ((curr.saidas || 0) * cm),
                        vlr_final: acc.vlr_final + (curr.vlr_final || 0),

                        vlr_teorico_acumulado: acc.vlr_teorico_acumulado + valFinanceiroTeorico
                    };
                }, { 
                    vol_inicial: 0, entradas: 0, saidas: 0, vol_final: 0, ajuste_vol: 0, 
                    vlr_inicial: 0, vlr_entradas: 0, vlr_saidas: 0, vlr_final: 0, vlr_teorico_acumulado: 0 
                });

                const custoMedioGeral = totals.vol_final > 0 ? totals.vlr_final / totals.vol_final : 0;
                const custoMedioPosAjuste = totals.vol_final > 0 ? totals.vlr_teorico_acumulado / totals.vol_final : 0;

                const divisorVar = totals.entradas + totals.vol_inicial;
                const variacaoPerc = divisorVar > 0 ? (totals.ajuste_vol / divisorVar) * 100 : 0;

                const diffEstoque = totals.vol_final - totals.vol_inicial;
                const varEstoquePerc = totals.vol_inicial > 0 ? (diffEstoque / totals.vol_inicial) * 100 : 0;

                return { ...totals, custoMedioGeral, custoMedioPosAjuste, variacaoPerc, varEstoquePerc, diffEstoque };
            }, [safeData]);

            // --- Preparação MICRO ---
            const microData = useMemo(() => {
                let processed = safeData.map(row => {
                    const divisor = (row.entradas || 0) + (row.vol_inicial || 0);
                    const variacao = divisor > 0 ? ((row.ajuste_vol || 0) / divisor) * 100 : 0;
                    
                    const cm = parseFloat(row.custo_medio) || 0;
                    const volAntesAjuste = (row.vol_final || 0) - (row.ajuste_vol || 0);
                    const valTeorico = volAntesAjuste * cm;
                    
                    const custoPos = (row.vol_final && row.vol_final > 0) 
                        ? (valTeorico / row.vol_final) 
                        : cm;

                    return { ...row, variacao_calc: variacao, custo_pos_calc: custoPos };
                });

                if (sortConfig.key) {
                    processed.sort((a, b) => {
                        let aVal = a[sortConfig.key];
                        let bVal = b[sortConfig.key];
                        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return processed;
            }, [safeData, sortConfig]);

            if (!data || data.length === 0) {
                return <div className="p-8 text-center text-slate-400">Sem dados para o período {periodo}.</div>;
            }

            // Gráficos
            const topCustos = [...safeData].sort((a, b) => b.custo_medio - a.custo_medio).slice(0, 10);
            
            // Top 10 Ajustes por Variação % (Absoluta)
            const topAjustesPerc = [...microData]
                .filter(d => Math.abs(d.variacao_calc) > 0)
                .sort((a, b) => Math.abs(b.variacao_calc) - Math.abs(a.variacao_calc))
                .slice(0, 10);

            const barColors = { blue: "#3b82f6", orange: "#f59e0b" };

            const SortableHeader = ({ label, sortKey, align = "right" }) => (
                <th className={`px-2 py-1 text-${align} cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors select-none group border-r border-slate-200 dark:border-slate-700 last:border-0`} onClick={() => requestSort(sortKey)}>
                    <div className={`flex items-center gap-1 ${align === 'right' ? 'justify-end' : 'justify-start'}`}>
                        <span className="truncate">{label}</span>
                        <span className={`text-slate-400 ${sortConfig.key === sortKey ? 'text-blue-500' : 'opacity-0 group-hover:opacity-50'}`}>
                            {sortConfig.key === sortKey && sortConfig.direction === 'desc' ? <Icons.ArrowDown width={10} /> : <Icons.ArrowUp width={10} />}
                        </span>
                    </div>
                </th>
            );

            // StatItem INVERTIDO: Valor (R$) grande, Volume (L) pequeno
            const StatItem = ({ label, value, sub, colorClass, borderClass }) => (
                <div className={`flex flex-col p-3 border rounded bg-white dark:bg-slate-800 ${borderClass}`}>
                    <span className="text-[9px] uppercase font-bold text-slate-500 tracking-wider mb-1 truncate">{label}</span>
                    <div className="flex flex-col">
                        <span className={`text-lg font-bold leading-none ${colorClass}`}>{value}</span>
                        {sub && <span className="text-xs text-slate-500 dark:text-slate-400 font-mono font-medium mt-1">{sub}</span>}
                    </div>
                </div>
            );

            const CustomGraphTooltip = ({ active, payload, label }) => {
                if (active && payload && payload.length) {
                    const dataKey = payload[0].dataKey;
                    let val = payload[0].value;
                    let prefix = '';
                    
                    if (dataKey === 'custo_medio') { prefix = 'R$ '; val = fmt.money(val); }
                    else if (dataKey === 'variacao_calc') { prefix = ''; val = fmt.perc(val); }
                    else { prefix = ''; val = fmt.vol(val); }

                    return (
                        <div className="bg-white p-2 border border-slate-300 shadow-lg text-xs text-slate-800">
                            <p className="font-bold">{label}</p>
                            <p>{payload[0].name}: {prefix}{val}</p>
                        </div>
                    );
                }
                return null;
            };

            return (
                <div className="w-full report-container pb-10">
                    {/* Cabeçalho Impressão (DATA INI e FIM CORRIGIDAS) */}
                    <div className="hidden print:flex justify-between items-center mb-4 border-b-2 border-black pb-2">
                        <div>
                            <h1 className="text-xl font-extrabold text-black uppercase tracking-tight">Relatório de Diesel</h1>
                            <p className="text-xs text-black">Período: <strong>{dataInicialTxt} à {dataFinalTxt}</strong></p>
                        </div>
                        <div className="text-right">
                            <div className="text-[10px] font-bold text-black border border-black px-2 py-0.5 inline-block mb-1">SAP ANALYTICS</div>
                            <p className="text-[9px] text-black">Emissão: {new Date().toLocaleDateString()} {new Date().toLocaleTimeString()}</p>
                        </div>
                    </div>

                    {/* Botão Exportar */}
                    <div className="flex justify-end no-print mb-4">
                        <button onClick={() => window.print()} className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-5 py-2 rounded-lg text-sm font-bold shadow transition-all">
                            <Icons.Download className="w-4 h-4" /> Exportar PDF
                        </button>
                    </div>

                    {/* --- 1. RESUMO MACRO --- */}
                    <div className="mb-4 avoid-break">
                        <h3 className="font-bold text-slate-700 dark:text-slate-200 mb-2 flex items-center gap-2 text-xs uppercase tracking-wide no-print">
                            <Icons.LayoutDashboard className="w-4 h-4" /> Visão Geral Financeira
                        </h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                            {/* Inversão: R$ como principal, Litros como Sub */}
                            <StatItem 
                                label="Estoque Inicial" 
                                value={`R$ ${fmt.money(macro.vlr_inicial)}`} 
                                sub={`${fmt.vol(macro.vol_inicial)} L`} 
                                colorClass="text-slate-700 dark:text-slate-200" 
                                borderClass="border-slate-200 dark:border-slate-700 border-l-4 border-l-slate-400" 
                            />
                            <StatItem 
                                label="Entradas" 
                                value={`R$ ${fmt.money(macro.vlr_entradas)}`} 
                                sub={`${fmt.vol(macro.entradas)} L`} 
                                colorClass="text-green-600 dark:text-green-400" 
                                borderClass="border-green-100 dark:border-slate-700 border-l-4 border-l-green-500" 
                            />
                            <StatItem 
                                label="Saídas" 
                                value={`R$ ${fmt.money(macro.vlr_saidas)}`} 
                                sub={`${fmt.vol(macro.saidas)} L`} 
                                colorClass="text-orange-600 dark:text-orange-400" 
                                borderClass="border-orange-100 dark:border-slate-700 border-l-4 border-l-orange-500" 
                            />
                            <StatItem 
                                label="Estoque Final" 
                                value={`R$ ${fmt.money(macro.vlr_final)}`} 
                                sub={`${fmt.vol(macro.vol_final)} L`} 
                                colorClass="text-blue-600 dark:text-blue-400" 
                                borderClass="border-blue-100 dark:border-slate-700 border-l-4 border-l-blue-500" 
                            />
                            
                            {/* Custo Médio Original */}
                            <StatItem 
                                label="Custo Médio Geral" 
                                value={`R$ ${fmt.money(macro.custoMedioGeral)}`}
                                sub="/ Litro"
                                colorClass="text-slate-700 dark:text-slate-300" 
                                borderClass="border-slate-200 dark:border-slate-700 border-l-4 border-l-slate-400" 
                            />

                            {/* Custo Médio PÓS AJUSTE */}
                            <div className={`flex flex-col p-3 border rounded bg-white dark:bg-slate-800 border-l-4 dark:border-slate-700 ${macro.custoMedioPosAjuste > macro.custoMedioGeral ? 'border-red-100 border-l-red-500' : (macro.custoMedioPosAjuste < macro.custoMedioGeral ? 'border-emerald-100 border-l-emerald-500' : 'border-slate-100 border-l-slate-400')}`}>
                                <span className="text-[9px] uppercase font-bold text-slate-500 tracking-wider mb-1 truncate">Custo Médio (Pós Ajuste)</span>
                                <div className="flex flex-col">
                                    <span className={`text-lg font-bold leading-none ${macro.custoMedioPosAjuste > macro.custoMedioGeral ? 'text-red-600' : (macro.custoMedioPosAjuste < macro.custoMedioGeral ? 'text-emerald-600' : 'text-slate-600')}`}>
                                        R$ {fmt.money(macro.custoMedioPosAjuste)}
                                    </span>
                                    <span className="text-xs text-slate-400 font-medium mt-1">
                                        {macro.custoMedioPosAjuste > macro.custoMedioGeral 
                                            ? `+ R$ ${fmt.money(macro.custoMedioPosAjuste - macro.custoMedioGeral)}` 
                                            : (macro.custoMedioPosAjuste < macro.custoMedioGeral 
                                                ? `- R$ ${fmt.money(macro.custoMedioGeral - macro.custoMedioPosAjuste)}` 
                                                : 'Sem variação')}
                                    </span>
                                </div>
                            </div>

                            <StatItem 
                                label="Var. (Ajustes)" 
                                value={(macro.variacaoPerc > 0 ? '+' : '') + fmt.perc(macro.variacaoPerc)} 
                                sub={`${fmt.vol(macro.ajuste_vol)} L`}
                                colorClass={Math.abs(macro.variacaoPerc) > 0.5 ? 'text-red-600 dark:text-red-400' : 'text-blue-600 dark:text-blue-400'} 
                                borderClass={`dark:border-slate-700 ${Math.abs(macro.variacaoPerc) > 0.5 ? 'border-red-100 border-l-4 border-l-red-500' : 'border-blue-100 border-l-4 border-l-blue-500'}`} 
                            />

                            <div className={`flex flex-col p-3 border rounded bg-white dark:bg-slate-800 dark:border-slate-700 border-l-4 ${macro.varEstoquePerc >= 0 ? 'border-indigo-100 border-l-indigo-500' : 'border-orange-100 border-l-orange-500'}`}>
                                <span className="text-[9px] uppercase font-bold text-slate-500 tracking-wider mb-1 truncate flex items-center gap-1">
                                    <Icons.Activity width={12}/> Evolução (Fim x Ini)
                                </span>
                                <div className="flex items-center justify-between">
                                    <div className="flex flex-col">
                                        <span className={`text-lg font-bold leading-none ${macro.varEstoquePerc >= 0 ? 'text-indigo-600 dark:text-indigo-400' : 'text-orange-600 dark:text-orange-400'}`}>
                                            {(macro.varEstoquePerc > 0 ? '+' : '') + fmt.perc(macro.varEstoquePerc)}
                                        </span>
                                        <span className="text-xs text-slate-400 font-medium mt-1">Percentual</span>
                                    </div>
                                    <div className="flex flex-col items-end border-l border-slate-100 dark:border-slate-700 pl-4">
                                        <span className={`text-sm font-bold font-mono ${macro.diffEstoque >= 0 ? 'text-indigo-600 dark:text-indigo-400' : 'text-orange-600 dark:text-orange-400'}`}>
                                            {macro.diffEstoque > 0 ? '+' : ''}{fmt.vol(macro.diffEstoque)} L
                                        </span>
                                        <span className="text-xs text-slate-400 font-medium mt-1">Volume</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* --- 2. GRÁFICOS (Atualizado para Variação %) --- */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4 avoid-break">
                        <div className="glass-card overflow-hidden flex flex-col h-[280px]">
                            <div className="bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 p-2 print-header">
                                <h3 className="font-bold text-slate-700 dark:text-slate-200 text-[10px] uppercase">Top 10 Custo Médio (R$/L)</h3>
                            </div>
                            <div className="p-2 flex-1">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart layout="vertical" data={topCustos} margin={{top: 0, right: 30, left: 35, bottom: 0}}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                                        <XAxis type="number" hide />
                                        <YAxis dataKey="usina" type="category" width={40} tick={{fontSize: 9, fontWeight: 'bold', fill: '#64748b'}} />
                                        <Tooltip content={<CustomGraphTooltip />} />
                                        <Bar dataKey="custo_medio" fill={barColors.blue} radius={[0, 4, 4, 0]} barSize={14} label={{ position: 'right', fontSize: 9, fontWeight: 'bold', formatter: (v) => fmt.money(v) }} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="glass-card overflow-hidden flex flex-col h-[280px]">
                            <div className="bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 p-2 print-header">
                                <h3 className="font-bold text-slate-700 dark:text-slate-200 text-[10px] uppercase">Top 10 Variação Ajuste (%)</h3>
                            </div>
                            <div className="p-2 flex-1">
                                <ResponsiveContainer width="100%" height="100%">
                                    {/* Alterado para usar dados de % (topAjustesPerc) */}
                                    <BarChart data={topAjustesPerc} margin={{top: 15, right: 0, left: 0, bottom: 0}}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                        <XAxis dataKey="usina" tick={{fontSize: 8, fill: '#64748b'}} interval={0} height={20} />
                                        <Tooltip content={<CustomGraphTooltip />} />
                                        <ReferenceLine y={0} stroke="#94a3b8" />
                                        <Bar dataKey="variacao_calc" fill={barColors.orange} radius={[2, 2, 0, 0]} barSize={25} label={{ position: 'top', fontSize: 8, fontWeight: 'bold', formatter: (v) => fmt.perc(v) }} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    {/* --- 3. TABELA ANALÍTICA (Com Highlight de Ajustes) --- */}
                    <div className="avoid-break">
                        <div className="glass-card overflow-hidden print:border-slate-300">
                            <div className="bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 p-2 flex justify-between items-center print-header">
                                <h3 className="font-bold text-slate-700 dark:text-slate-200 text-[10px] uppercase flex items-center gap-2">
                                    <Icons.Table className="w-3 h-3" /> Detalhamento Analítico
                                </h3>
                                <span className="text-[9px] text-slate-400 uppercase font-bold">{microData.length} Reg.</span>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-xs text-left">
                                    <thead className="text-[9px] uppercase bg-slate-100 dark:bg-slate-900 border-b-2 border-slate-300 dark:border-slate-700 text-slate-600 dark:text-slate-400 font-bold print-header">
                                        <tr>
                                            <SortableHeader label="Usina" sortKey="usina" align="left" />
                                            <SortableHeader label="E. Inic." sortKey="vol_inicial" />
                                            <SortableHeader label="Entradas" sortKey="entradas" />
                                            <SortableHeader label="Saídas" sortKey="saidas" />
                                            <SortableHeader label="Ajustes" sortKey="ajuste_vol" />
                                            <SortableHeader label="E. Final" sortKey="vol_final" />
                                            <SortableHeader label="Var %" sortKey="variacao_calc" />
                                            <SortableHeader label="Custo Méd." sortKey="custo_medio" />
                                            <SortableHeader label="Custo Aj." sortKey="custo_pos_calc" />
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                                        {microData.map((row, i) => {
                                            // Lógica de Highlight: Se houver ajuste (diferente de zero), aplica cor
                                            const hasAjuste = Math.abs(row.ajuste_vol) > 0.01;
                                            
                                            // Classes CSS
                                            let rowClass = "";
                                            if (hasAjuste) {
                                                // Cor Amarela/Laranja para destacar
                                                rowClass = "bg-orange-50 dark:bg-orange-900/20 border-l-4 border-l-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900/30";
                                            } else {
                                                // Padrão Zebrado
                                                rowClass = `hover:bg-slate-50 dark:hover:bg-slate-800/50 ${i % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-slate-50/50 dark:bg-slate-800/20'}`;
                                            }

                                            return (
                                                <tr key={i} className={rowClass}>
                                                    <td className={`px-2 py-1 font-bold text-slate-700 dark:text-slate-200 border-r border-slate-50 dark:border-slate-800 ${hasAjuste ? 'pl-1' : ''}`}>{row.usina}</td>
                                                    <td className="px-2 py-1 text-right text-slate-600 dark:text-slate-400">{fmt.vol(row.vol_inicial)}</td>
                                                    <td className="px-2 py-1 text-right text-slate-600 dark:text-slate-400">{fmt.vol(row.entradas)}</td>
                                                    <td className="px-2 py-1 text-right text-slate-600 dark:text-slate-400">{fmt.vol(row.saidas)}</td>
                                                    <td className={`px-2 py-1 text-right font-medium ${row.ajuste_vol < 0 ? 'text-red-600 dark:text-red-400' : (row.ajuste_vol > 0 ? 'text-blue-600 dark:text-blue-400' : 'text-slate-300')}`}>
                                                        {fmt.vol(row.ajuste_vol)}
                                                    </td>
                                                    <td className="px-2 py-1 text-right font-bold text-slate-700 dark:text-white border-l border-slate-50 dark:border-slate-800">{fmt.vol(row.vol_final)}</td>
                                                    <td className="px-2 py-1 text-right">
                                                        <span className={`px-1 py-0.5 rounded text-[9px] font-bold ${Math.abs(row.variacao_calc) > 0.5 ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'}`}>
                                                            {fmt.perc(row.variacao_calc)}
                                                        </span>
                                                    </td>
                                                    <td className="px-2 py-1 text-right font-mono text-slate-600 dark:text-slate-400">R$ {fmt.money(row.custo_medio)}</td>
                                                    <td className={`px-2 py-1 text-right font-mono font-bold border-l border-slate-50 dark:border-slate-700 ${row.custo_pos_calc > row.custo_medio ? 'text-red-600' : (row.custo_pos_calc < row.custo_medio ? 'text-emerald-600' : 'text-slate-600 dark:text-slate-400')}`}>
                                                        R$ {fmt.money(row.custo_pos_calc)}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const UploadCard = ({ type, iconName, onAnalyze, isAnalyzing, progress }) => {
            const Icon = Icons[iconName.charAt(0).toUpperCase() + iconName.slice(1)] || Icons.FileText;
            return (
                <div className="glass-card p-6 text-center relative group hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-300">
                    <div className="mb-4 text-slate-400 p-4 bg-slate-50 dark:bg-slate-800 rounded-full inline-block group-hover:text-blue-500 group-hover:bg-blue-50 dark:group-hover:bg-blue-900/30 transition-colors"><Icon /></div>
                    <h3 className="font-bold capitalize mb-2 text-slate-700 dark:text-slate-200">{type}</h3>
                    <input type="file" className="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 dark:file:bg-blue-900/50 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 cursor-pointer" onChange={e => e.target.files && onAnalyze(e.target.files[0], type)} disabled={isAnalyzing} />
                    {progress > 0 && (<div className="w-full bg-slate-100 h-1.5 mt-4 rounded-full overflow-hidden"><div className="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div></div>)}
                </div>
            );
        };

        const Sidebar = ({ isSidebarOpen, toggleSidebar, toggleModule, expandedModules, userRole, setView, view, handleLogout, session }) => {
            return (
                <div className={`bg-slate-900 text-slate-300 flex flex-col fixed h-full shadow-2xl z-50 sidebar-transition ${isSidebarOpen ? 'w-64' : 'w-20'}`}>
                    <div className="p-4 border-b border-slate-800 flex items-center justify-between relative">
                        <div className={`flex items-center gap-3 overflow-hidden ${!isSidebarOpen && 'justify-center w-full'}`}><img src="https://jsmnykikflkjceiqfmne.supabase.co/storage/v1/object/public/LOGOS/Logo_sm_texto-removebg-preview.png" alt="Logo" className="h-12 w-auto flex-shrink-0" />{isSidebarOpen && <div className="fade-enter whitespace-nowrap"><span className="font-bold text-white text-lg block leading-tight">SAP</span><span className="text-[10px] font-medium text-slate-400 tracking-widest uppercase">Analytics</span></div>}</div>
                        <button onClick={toggleSidebar} className="absolute -right-4 top-6 bg-slate-800 text-slate-400 hover:text-white p-1 rounded-full border border-slate-700 shadow-lg z-30 hover:scale-110 transition-transform"><Icons.ChevronLeft className={`transform transition-transform ${!isSidebarOpen ? 'rotate-180' : ''}`} /></button>
                    </div>
                    <nav className="flex-1 p-2 space-y-2 overflow-y-auto custom-scrollbar">
                        {Utils.checkPermission(userRole, 'terceirizacao') && (<div className="group"><button onClick={() => isSidebarOpen && toggleModule('terceirizacao')} className={`w-full flex items-center justify-between px-3 py-3 rounded-lg transition-colors ${!isSidebarOpen ? 'justify-center' : 'bg-slate-800/40 text-slate-100 hover:bg-slate-800'}`}><div className="flex items-center gap-3"><Icons.Briefcase />{isSidebarOpen && <span className="font-semibold text-sm fade-enter">Terceirização</span>}</div>{isSidebarOpen && (<span className={`text-slate-500 transform transition-transform duration-200 ${expandedModules.terceirizacao ? 'rotate-180' : ''}`}><Icons.ChevronDown /></span>)}</button>{isSidebarOpen && expandedModules.terceirizacao && (<div className="ml-4 mt-1 space-y-1 border-l-2 border-slate-800 pl-3 fade-enter"><button onClick={() => setView('dashboard')} className={`w-full flex items-center gap-2 px-2 py-2 text-sm rounded transition-colors ${view === 'dashboard' ? 'text-blue-400 font-medium bg-slate-800/50' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`}>Visão Geral</button><button onClick={() => setView('reports')} className={`w-full flex items-center gap-2 px-2 py-2 text-sm rounded transition-colors ${view === 'reports' ? 'text-emerald-400 font-medium bg-slate-800/50' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`}>Relatórios</button><button onClick={() => setView('terceirizacao_ativos')} className={`w-full flex items-center gap-2 px-2 py-2 text-sm rounded transition-colors ${view === 'terceirizacao_ativos' ? 'text-teal-400 font-medium bg-slate-800/50' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`} >Relatório de Ativos</button><button onClick={() => setView('upload')} className={`w-full flex items-center gap-2 px-2 py-2 text-sm rounded transition-colors ${view === 'upload' ? 'text-purple-400 font-medium bg-slate-800/50' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`}>Importação</button><button onClick={() => setView('terceirizacao_cadastros')} className={`w-full flex items-center gap-2 px-2 py-2 text-sm rounded transition-colors ${view === 'terceirizacao_cadastros' ? 'text-indigo-400 font-medium bg-slate-800/50' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`} >Cadastros</button><button onClick={() => setView('terceirizacao_depara')} className={`w-full flex items-center gap-2 px-2 py-2 text-sm rounded transition-colors ${view === 'terceirizacao_depara' ? 'text-orange-400 font-medium bg-slate-800/50' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`}>Configuração</button><button onClick={() => setView('terceirizacao_turnover')}  className={`w-full flex items-center gap-2 px-2 py-2 text-sm rounded transition-colors ${view === 'terceirizacao_turnover' ? 'text-cyan-400 font-medium bg-slate-800/50' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`} >Turnover (RH)</button><button onClick={() => setView('terceirizacao_pagamentos')} className={`w-full flex items-center gap-2 px-2 py-2 text-sm rounded transition-colors ${view ==='terceirizacao_pagamentos' ? 'text-emerald-400 font-medium bg-slate-800/50' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`} >Pagamentos</button></div>)}</div>)}
                        {Utils.checkPermission(userRole, 'controladoria') && (<div className="group mt-2">
        <button onClick={() => isSidebarOpen && toggleModule('controladoria')} className={`w-full flex items-center justify-between px-3 py-3 rounded-lg transition-colors ${!isSidebarOpen ? 'justify-center' : 'bg-slate-800/40 text-slate-100 hover:bg-slate-800'}`}>
            <div className="flex items-center gap-3"><Icons.BarChart2 />{isSidebarOpen && <span className="font-semibold text-sm fade-enter">Controladoria</span>}</div>
            {isSidebarOpen && (<span className={`text-slate-500 transform transition-transform duration-200 ${expandedModules.controladoria ? 'rotate-180' : ''}`}><Icons.ChevronDown /></span>)}
        </button>
        {isSidebarOpen && expandedModules.controladoria && (
            <div className="ml-4 mt-1 space-y-1 border-l-2 border-slate-800 pl-3 fade-enter">
                <button onClick={() => setView('controladoria', 'dash')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Visão Geral</button>
                {/* Botão DRE corrigido e padronizado aqui */}
                <button onClick={() => setView('controladoria', 'dre')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">DRE Gerencial</button>
                <button onClick={() => setView('controladoria', 'report')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Dados Detalhados</button>
                <button onClick={() => setView('controladoria', 'depara')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Configuração</button>
                <button onClick={() => setView('controladoria', 'import')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Importação</button>
            </div>
        )}
    </div>
)}
                        {Utils.checkPermission(userRole, 'diesel') && (<div className="group mt-2"><button onClick={() => isSidebarOpen && toggleModule('diesel')} className={`w-full flex items-center justify-between px-3 py-3 rounded-lg transition-colors ${!isSidebarOpen ? 'justify-center' : 'bg-slate-800/40 text-slate-100 hover:bg-slate-800'}`}><div className="flex items-center gap-3"><Icons.Fuel />{isSidebarOpen && <span className="font-semibold text-sm fade-enter">Diesel</span>}</div>{isSidebarOpen && (<span className={`text-slate-500 transform transition-transform duration-200 ${expandedModules.diesel ? 'rotate-180' : ''}`}><Icons.ChevronDown /></span>)}</button>{isSidebarOpen && expandedModules.diesel && (<div className="ml-4 mt-1 space-y-1 border-l-2 border-slate-800 pl-3 fade-enter"><button onClick={() => setView('diesel', 'dash')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Visão Geral</button><button onClick={() => setView('diesel', 'report')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Relatório</button><button onClick={() => setView('diesel', 'import')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Importação</button></div>)}</div>)}
                    </nav>
                    <div className="p-4 border-t border-slate-800"><div className={`flex items-center gap-3 ${!isSidebarOpen && 'justify-center'}`}><div className="relative w-9 h-9 flex items-center justify-center flex-shrink-0"><div className="absolute inset-0 rounded-full bg-[conic-gradient(from_0deg,red,orange,yellow,green,blue,purple,red)] animate-[spin_3s_linear_infinite] blur-[2px]"></div><div className="relative w-8 h-8 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-white font-bold text-xs z-10 shadow-inner">{session.user.email.substring(0,2).toUpperCase()}</div></div>{isSidebarOpen && (<div className="overflow-hidden flex-1 fade-enter"><p className="text-white text-xs font-medium truncate">{session.user.email.split('@')[0]}</p><p className="text-[10px] text-slate-500 truncate capitalize">{userRole}</p></div>)}{isSidebarOpen && (<button onClick={handleLogout} className="text-slate-400 hover:text-white transition-colors" title="Sair"><Icons.LogOut /></button>)}</div></div>
                </div>
            );
        };
const TerceirizacaoDePara = ({ supabaseClient, onNotify }) => {
    const [mappings, setMappings] = useState([]);
    const [showModal, setShowModal] = useState(false);
    const [formData, setFormData] = useState({ id: null, codigo: '', descricao: '', considerar_volume: false });

    const fetchMappings = async () => {
        try {
            const { data, error } = await supabaseClient.from('terceirizacao_de_para').select('*').order('codigo');
            if (error) throw error;
            setMappings(data || []);
        } catch (e) {
            onNotify(e.message, "error");
        }
    };

    useEffect(() => { fetchMappings(); }, []);

    const handleSave = async (e) => {
        e.preventDefault();
        try {
            const payload = { 
                codigo: formData.codigo, 
                descricao: formData.descricao, 
                considerar_volume: formData.considerar_volume 
            };
            
            const { error } = formData.id 
                ? await supabaseClient.from('terceirizacao_de_para').update(payload).eq('id', formData.id)
                : await supabaseClient.from('terceirizacao_de_para').insert(payload);

            if (error) throw error;
            onNotify("Salvo com sucesso!", "success");
            setShowModal(false);
            fetchMappings();
        } catch (e) {
            onNotify(e.message, "error");
        }
    };

    const handleDelete = async (id) => {
        if (!confirm('Deseja excluir este mapeamento?')) return;
        try {
            const { error } = await supabaseClient.from('terceirizacao_de_para').delete().eq('id', id);
            if (error) throw error;
            fetchMappings();
        } catch (e) {
            onNotify(e.message, "error");
        }
    };

    return (
        <div className="max-w-4xl mx-auto space-y-6 animate-enter">
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <Icons.Settings /> Configuração De/Para - Terceirização
                </h2>
                <button 
                    onClick={() => { setFormData({ id: null, codigo: '', descricao: '', considerar_volume: false }); setShowModal(true); }} 
                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg"
                >
                    <Icons.Plus /> Novo Código
                </button>
            </div>

            <div className="glass-card overflow-hidden">
                <table className="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                    <thead className="text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700">
                        <tr>
                            <th className="px-6 py-3">Código (Lançamento)</th>
                            <th className="px-6 py-3">Descrição (Centro de Custo)</th>
                            <th className="px-6 py-3 text-center">Soma Volume?</th>
                            <th className="px-6 py-3 text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {mappings.map(item => (
                            <tr key={item.id} className="border-b border-slate-50 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800">
                                <td className="px-6 py-3 font-mono font-bold text-blue-600 dark:text-blue-400">{item.codigo}</td>
                                <td className="px-6 py-3 font-bold">{item.descricao}</td>
                                <td className="px-6 py-3 text-center">
                                    <span className={`px-2 py-1 rounded text-xs font-bold ${item.considerar_volume ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>
                                        {item.considerar_volume ? 'SIM' : 'NÃO'}
                                    </span>
                                </td>
                                <td className="px-6 py-3 text-right flex justify-end gap-3">
                                    <button onClick={() => { setFormData(item); setShowModal(true); }} className="text-blue-500 hover:text-blue-700 transition-colors"><Icons.Edit width={16} /></button>
                                    <button onClick={() => handleDelete(item.id)} className="text-red-500 hover:text-red-700 transition-colors"><Icons.Trash2 width={16} /></button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {showModal && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                    <div className="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md border border-slate-200 dark:border-slate-700 shadow-2xl animate-enter">
                        <h3 className="font-bold mb-4 text-slate-800 dark:text-white">{formData.id ? 'Editar' : 'Novo'} Código</h3>
                        <form onSubmit={handleSave} className="space-y-4">
                            <div>
                                <label className="input-label">Código do Lançamento</label>
                                <input 
                                    className="w-full border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={formData.codigo} 
                                    onChange={e => setFormData({...formData, codigo: e.target.value})} 
                                    placeholder="Ex: 1, 10, 4..." 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="input-label">Descrição Amigável</label>
                                <input 
                                    className="w-full border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={formData.descricao} 
                                    onChange={e => setFormData({...formData, descricao: e.target.value})} 
                                    placeholder="Ex: Produção, Diesel..." 
                                    required 
                                />
                            </div>
                            <div className="flex items-center gap-3 p-3 border border-slate-100 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-900/50">
                                <input 
                                    type="checkbox" 
                                    id="checkVol"
                                    className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                                    checked={formData.considerar_volume} 
                                    onChange={e => setFormData({...formData, considerar_volume: e.target.checked})} 
                                />
                                <label htmlFor="checkVol" className="text-sm font-medium text-slate-700 dark:text-slate-300 cursor-pointer">
                                    Considerar como Volume Produzido?
                                    <p className="text-[10px] text-slate-400 font-normal">Marque apenas para itens de produção (Ex: 1, 10)</p>
                                </label>
                            </div>
                            <div className="flex justify-end gap-2 pt-2">
                                <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors font-medium text-sm">Cancelar</button>
                                <button type="submit" className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm transition-colors shadow-lg">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
};
        const TerceirizacaoDashboard = ({ data, loading, isDark, filters, supabaseClient }) => {
    const chartColors = getChartColors(isDark);
    
    // Estados para o Drill-down (Detalhamento)
    const [drillData, setDrillData] = useState(null);
    const [isDrillLoading, setIsDrillLoading] = useState(false);
    const [selectedCostType, setSelectedCostType] = useState(null);

    if (!data || !data.kpis) return <div className="p-10 text-center text-slate-400">Carregando dados...</div>;

    // Helper de Variação
    const getVar = (atual, ant) => {
        if (!ant || ant === 0) return 0;
        return ((atual - ant) / ant) * 100;
    };

    const analiseProcessada = (data.analise_tipo || []).map(item => ({
        ...item,
        varPerc: getVar(item.rs_m3_atual, item.rs_m3_ant)
    }));

    // Função que chama o detalhamento ao clicar
    const handleDrillDown = async (tipoCusto) => {
        setSelectedCostType(tipoCusto);
        setIsDrillLoading(true);
        setDrillData(null);

        try {
            const { data: res, error } = await supabaseClient.rpc('get_terceirizacao_detalhe_custo', {
                p_data_ini: filters.dateIni,
                p_data_fim: filters.dateFim,
                p_filial: filters.filial,
                p_tipo_custo: tipoCusto,
                p_vol_prod_total: data.kpis.volume_total // Passa o volume total para calcular o impacto relativo
            });

            if (error) throw error;
            setDrillData(res);
        } catch (error) {
            console.error("Erro no drilldown:", error);
        } finally {
            setIsDrillLoading(false);
        }
    };

    // Componente interno do Modal
    const DrillDownModal = () => {
        if (!selectedCostType) return null;

        return (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-enter">
                <div className="bg-white dark:bg-slate-900 w-full max-w-5xl rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 flex flex-col max-h-[90vh]">
                    {/* Header Modal */}
                    <div className="p-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 rounded-t-xl">
                        <div>
                            <h3 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <Icons.Search className="text-blue-500" /> Detalhes: <span className="text-blue-600 dark:text-blue-400">{selectedCostType}</span>
                            </h3>
                            <p className="text-xs text-slate-500">Impacto no Custo Médio Geral (R$/m³)</p>
                        </div>
                        <button onClick={() => setSelectedCostType(null)} className="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors text-slate-500">
                            <Icons.X />
                        </button>
                    </div>

                    {/* Conteúdo Modal */}
                    <div className="p-6 overflow-y-auto custom-scrollbar flex-1">
                        {isDrillLoading ? (
                            <div className="h-64 flex flex-col items-center justify-center text-slate-400">
                                <div className="loader h-8 w-8 border-4 border-blue-500 rounded-full border-t-transparent mb-4"></div>
                                Carregando detalhes...
                            </div>
                        ) : drillData ? (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                {/* Gráfico Placas */}
                                <div className="glass-card p-5 border border-slate-200 dark:border-slate-700">
                                    <h4 className="font-bold text-slate-700 dark:text-slate-200 mb-4 text-sm border-b pb-2">Top 10 Equipamentos (Impacto R$/m³)</h4>
                                    <div className="h-[300px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart layout="vertical" data={drillData.placas} margin={{ top: 5, right: 30, left: 40, bottom: 5 }}>
                                                <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke={chartColors.grid} />
                                                <XAxis type="number" tick={{ fill: chartColors.text, fontSize: 10 }} tickFormatter={(v) => `R$ ${v.toFixed(2)}`} />
                                                <YAxis dataKey="name" type="category" width={60} tick={{ fill: chartColors.text, fontSize: 10, fontWeight: 'bold' }} />
                                                <Tooltip 
                                                    content={({ active, payload }) => {
                                                        if (active && payload && payload.length) {
                                                            const d = payload[0].payload;
                                                            return (
                                                                <div className="bg-white dark:bg-slate-800 p-2 border shadow text-xs rounded">
                                                                    <p className="font-bold text-slate-700 dark:text-slate-200">{d.name}</p>
                                                                    <p className="text-slate-500">{d.classe}</p>
                                                                    <p className="text-blue-600 font-bold">R$ {d.rs_m3_impacto.toFixed(4)} /m³</p>
                                                                    <p className="text-slate-400">Total: {Utils.formatters.currency(d.valor)}</p>
                                                                </div>
                                                            );
                                                        }
                                                        return null;
                                                    }}
                                                />
                                                <Bar dataKey="rs_m3_impacto" fill={chartColors.bomba} radius={[0, 4, 4, 0]} barSize={20} />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Gráfico Filiais */}
                                <div className="glass-card p-5 border border-slate-200 dark:border-slate-700">
                                    <h4 className="font-bold text-slate-700 dark:text-slate-200 mb-4 text-sm border-b pb-2">Top 10 Filiais (Impacto R$/m³)</h4>
                                    <div className="h-[300px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart layout="vertical" data={drillData.filiais} margin={{ top: 5, right: 30, left: 40, bottom: 5 }}>
                                                <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke={chartColors.grid} />
                                                <XAxis type="number" tick={{ fill: chartColors.text, fontSize: 10 }} tickFormatter={(v) => `R$ ${v.toFixed(2)}`} />
                                                <YAxis dataKey="name" type="category" width={60} tick={{ fill: chartColors.text, fontSize: 10, fontWeight: 'bold' }} />
                                                <Tooltip 
                                                    content={({ active, payload }) => {
                                                        if (active && payload && payload.length) {
                                                            const d = payload[0].payload;
                                                            return (
                                                                <div className="bg-white dark:bg-slate-800 p-2 border shadow text-xs rounded">
                                                                    <p className="font-bold text-slate-700 dark:text-slate-200">{d.name}</p>
                                                                    <p className="text-green-600 font-bold">R$ {d.rs_m3_impacto.toFixed(4)} /m³</p>
                                                                    <p className="text-slate-400">Total: {Utils.formatters.currency(d.valor)}</p>
                                                                </div>
                                                            );
                                                        }
                                                        return null;
                                                    }}
                                                />
                                                <Bar dataKey="rs_m3_impacto" fill={chartColors.secondary} radius={[0, 4, 4, 0]} barSize={20} />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                                
                                {/* Tabela Detalhada (Opcional, se quiser ver números brutos) */}
                                <div className="lg:col-span-2 glass-card overflow-hidden">
                                    <table className="w-full text-xs text-left text-slate-600 dark:text-slate-300">
                                        <thead className="bg-slate-100 dark:bg-slate-800 uppercase font-bold text-slate-500">
                                            <tr>
                                                <th className="px-4 py-2">Placa</th>
                                                <th className="px-4 py-2">Classe</th>
                                                <th className="px-4 py-2 text-right">Valor Total</th>
                                                <th className="px-4 py-2 text-right">Impacto (R$/m³)</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                                            {drillData.placas.slice(0, 5).map((row, i) => (
                                                <tr key={i} className="hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                                    <td className="px-4 py-2 font-bold">{row.name}</td>
                                                    <td className="px-4 py-2">{row.classe}</td>
                                                    <td className="px-4 py-2 text-right">{Utils.formatters.currency(row.valor)}</td>
                                                    <td className="px-4 py-2 text-right font-mono text-blue-600 dark:text-blue-400">{row.rs_m3_impacto.toFixed(4)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ) : (
                            <div className="text-center text-slate-500">Nenhum dado encontrado para este detalhamento.</div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    return (
        <div className="space-y-6 animate-enter">
            {/* Modal de Detalhamento */}
            <DrillDownModal />

            {/* 1. KPIs Principais */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <Card title="Volume Produzido" value={`${Utils.math.roundVolume(data.kpis.volume_total).toLocaleString()} m³`} iconName="database" color="blue" />
                <Card title="Custo Total" value={Utils.formatters.currency(data.kpis.valor_total)} iconName="dollarSign" color="purple" />
                <Card title="Custo Médio Geral" value={`${Utils.formatters.currency(data.kpis.custo_medio_geral)} /m³`} iconName="target" color="emerald" subtext="R$ Total / Vol. Prod" />
                <Card title="Vol. Bombeado" value={`${Utils.math.roundVolume(data.kpis.vol_bomba).toLocaleString()} m³`} iconName="droplet" color="sky" />
                <Card title="Vol. Transportado" value={`${Utils.math.roundVolume(data.kpis.vol_transp).toLocaleString()} m³`} iconName="truck" color="orange" />
            </div>

            {/* 2. Análise Detalhada por Tipo de Lançamento */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Tabela de Variação e Impacto */}
                <div className="lg:col-span-2 glass-card overflow-hidden flex flex-col">
                    <div className="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex justify-between items-center">
                        <h3 className="font-bold text-slate-700 dark:text-slate-200 text-sm flex items-center gap-2">
                            <Icons.Activity className="w-4 h-4 text-blue-500" /> Análise de Impacto (R$/m³)
                        </h3>
                        <span className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Clique na linha para detalhar</span>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                            <thead className="text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700">
                                <tr>
                                    <th className="px-6 py-3">Tipo de Custo</th>
                                    <th className="px-6 py-3 text-right">Valor Total</th>
                                    <th className="px-6 py-3 text-right bg-blue-50/50 dark:bg-blue-900/10">R$ / m³ (Atual)</th>
                                    {filters.month !== 'Todos' && <th className="px-6 py-3 text-right">Var. vs Mês Ant.</th>}
                                </tr>
                            </thead>
                            <tbody>
                                {analiseProcessada.map((row, i) => (
                                    <tr 
                                        key={i} 
                                        onClick={() => handleDrillDown(row.name)}
                                        className="border-b border-slate-50 dark:border-slate-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer transition-colors group"
                                        title="Clique para ver detalhes por placa e filial"
                                    >
                                        <td className="px-6 py-3 font-bold flex items-center gap-2">
                                            {row.name}
                                            <Icons.Search className="w-3 h-3 text-slate-300 group-hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-all" />
                                        </td>
                                        <td className="px-6 py-3 text-right">{Utils.formatters.currency(row.valor_atual)}</td>
                                        <td className="px-6 py-3 text-right font-mono font-bold text-blue-600 dark:text-blue-400 bg-blue-50/30 dark:bg-blue-900/10">
                                            {Utils.formatters.currency(row.rs_m3_atual)}
                                        </td>
                                        {filters.month !== 'Todos' && (
                                            <td className="px-6 py-3 text-right">
                                                <div className={`flex items-center justify-end gap-1 font-bold text-xs px-2 py-1 rounded-full w-fit ml-auto ${
                                                    row.varPerc > 0 ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 
                                                    (row.varPerc < 0 ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-slate-100 text-slate-500')
                                                }`}>
                                                    {row.varPerc > 0 ? '▲' : (row.varPerc < 0 ? '▼' : '-')} {Math.abs(row.varPerc).toFixed(1)}%
                                                </div>
                                            </td>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>

                {/* Card de Distribuição */}
                <div className="glass-card p-5 flex flex-col">
                    <h3 className="font-bold text-slate-700 dark:text-slate-200 mb-4 text-sm">Distribuição de Custo</h3>
                    <div className="flex-1 min-h-[200px]">
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                                <Pie 
                                    data={analiseProcessada} 
                                    cx="50%" cy="50%" 
                                    innerRadius={60} outerRadius={80} 
                                    paddingAngle={5} 
                                    dataKey="valor_atual"
                                >
                                    {analiseProcessada.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={[chartColors.secondary, chartColors.accent, chartColors.success, chartColors.danger][index % 4]} />
                                    ))}
                                </Pie>
                                <Tooltip content={<CustomTooltip isDark={isDark} />} />
                                <Legend verticalAlign="bottom" height={36} />
                            </PieChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            </div>

            {/* 3. Gráficos de Detalhe */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Custo Médio por Classe */}
                <div className="glass-card p-6 h-[400px] flex flex-col">
                    <h3 className="font-bold text-slate-800 dark:text-slate-200 mb-4 text-sm">Custo Médio por Classe de Equipamento (R$/m³)</h3>
                    <div className="flex-1 w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart layout="vertical" data={data.chart_classe} margin={{top: 5, right: 30, left: 40, bottom: 5}}>
                                <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke={chartColors.grid} />
                                <XAxis type="number" tick={{fill: chartColors.text}} tickFormatter={(val) => `R$ ${val}`} />
                                <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 10, fontWeight: 'bold', fill: chartColors.text}} />
                                <Tooltip content={<CustomTooltip isDark={isDark} />} />
                                <Bar dataKey="rs_m3" fill={chartColors.controladoria} radius={[0, 4, 4, 0]} barSize={20} name="R$/m³" />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* Top 10 Usinas */}
                <div className="glass-card p-6 h-[400px] flex flex-col">
                    <h3 className="font-bold text-slate-800 dark:text-slate-200 mb-4 text-sm">Top 10 Filiais - Maior Custo Total</h3>
                    <div className="flex-1 w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={data.chart_usina} margin={{top: 5, right: 5, left: 0, bottom: 5}}>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={chartColors.grid} />
                                <XAxis dataKey="name" tick={{fontSize: 10, fill: chartColors.text}} interval={0} angle={-15} textAnchor="end" height={50} />
                                <YAxis tick={{fill: chartColors.text}} tickFormatter={(val) => `R$ ${val/1000}k`} />
                                <Tooltip content={<CustomTooltip isDark={isDark} />} />
                                <Bar dataKey="value" fill={chartColors.bomba} radius={[4, 4, 0, 0]} name="Custo Total" />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            </div>
        </div>
    );
};
       // =============================================================================
// 1. COMPONENTE DO MODAL (DEFINIDO FORA DA FUNÇÃO PRINCIPAL)
// =============================================================================
// --- NOVO DESIGN DO MODAL DE AJUSTE (Substitua o anterior) ---
const ConciliacaoModal = ({ provider, data, loading, ajustes, onClose, onAddAjuste, onDeleteAjuste }) => {
    if (!provider) return null;

    const [localAjuste, setLocalAjuste] = useState({ tipo: 'ISS', valor: '', obs: '' });
    const [isSaving, setIsSaving] = useState(false);

    // Proteção de dados
    const creditos = (data && data.creditos) ? data.creditos : [];
    const debitos = (data && data.debitos) ? data.debitos : [];
    const listaAjustes = Array.isArray(ajustes) ? ajustes : [];

    const totalCred = creditos.reduce((acc, curr) => acc + (Number(curr.valor) || 0), 0);
    const totalDeb = debitos.reduce((acc, curr) => acc + (Math.abs(Number(curr.valor)) || 0), 0);
    const totalAj = listaAjustes.reduce((acc, a) => acc + (Number(a.valor) || 0), 0);
    
    const saldoModal = totalCred - (totalDeb + totalAj);

    const handleSubmitAjuste = async (e) => {
        e.preventDefault();
        if (!localAjuste.valor) return;
        setIsSaving(true);
        await onAddAjuste(localAjuste);
        setLocalAjuste({ ...localAjuste, valor: '', obs: '' });
        setIsSaving(false);
    };

    return (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[9999] p-4 animate-enter" onClick={onClose}>
            {/* Container Principal do Modal */}
            <div 
                className="bg-white dark:bg-slate-800 w-full max-w-[95%] h-[90vh] rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 flex flex-col overflow-hidden ring-1 ring-slate-900/5" 
                onClick={e => e.stopPropagation()}
            >
                
                {/* 1. CABEÇALHO DO MODAL */}
                <div className="px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center">
                    <div>
                        <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <span className="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg">
                                <Icons.Search width={20} height={20} />
                            </span>
                            Extrato Detalhado
                        </h3>
                        <div className="flex items-center gap-2 mt-1 text-sm">
                            <span className="font-bold text-slate-700 dark:text-slate-200">{provider.nome_terceiro}</span>
                            <span className="text-slate-400">•</span>
                            <span className="font-mono text-slate-500 bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-xs">SAP: {provider.sap_code}</span>
                        </div>
                    </div>

                    <div className="flex items-center gap-4">
                        <div className={`px-5 py-2 rounded-xl border flex flex-col items-end shadow-sm ${Math.abs(saldoModal) <= 1.00 ? 'bg-emerald-50 dark:bg-emerald-900/10 border-emerald-200 dark:border-emerald-900/30 text-emerald-700 dark:text-emerald-400' : 'bg-rose-50 dark:bg-rose-900/10 border-rose-200 dark:border-rose-900/30 text-rose-700 dark:text-rose-400'}`}>
                            <span className="text-[10px] font-bold uppercase opacity-70 tracking-wider">Saldo Final</span>
                            <span className="text-xl font-bold font-mono">{Utils.formatters.currency(saldoModal)}</span>
                        </div>
                        <button 
                            onClick={onClose} 
                            className="p-2.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-500 hover:text-slate-700 dark:hover:text-slate-200 rounded-full transition-all"
                        >
                            <Icons.X width={20} height={20} />
                        </button>
                    </div>
                </div>

                {/* 2. CONTEÚDO (3 COLUNAS) */}
                <div className="flex-1 overflow-hidden flex flex-col lg:flex-row bg-slate-50/50 dark:bg-slate-900/20">
                    
                    {/* COLUNA 1: CRÉDITOS */}
                    <div className="flex-1 flex flex-col border-r border-slate-200 dark:border-slate-700 min-w-[320px] bg-white dark:bg-slate-800">
                        <div className="p-3 bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-blue-800/30 flex justify-between items-center">
                            <span className="font-bold text-blue-700 dark:text-blue-400 text-xs uppercase tracking-wider flex items-center gap-2">
                                <Icons.FileText width={14} /> Apuração (Créditos)
                            </span>
                            <span className="bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 text-[10px] font-bold px-2 py-0.5 rounded-full">{creditos.length} itens</span>
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-0">
                            {loading ? <div className="p-10 text-center text-slate-400 text-xs animate-pulse">Carregando dados...</div> : (
                                <table className="w-full text-xs text-left border-collapse">
                                    <thead className="sticky top-0 bg-slate-50 dark:bg-slate-800/95 backdrop-blur shadow-sm text-slate-500 font-semibold z-10">
                                        <tr>
                                            <th className="p-3 border-b dark:border-slate-700 font-medium">Data</th>
                                            <th className="p-3 border-b dark:border-slate-700 font-medium">Placa/Ref</th>
                                            <th className="p-3 border-b dark:border-slate-700 text-right font-medium">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 dark:divide-slate-700 text-slate-600 dark:text-slate-300">
                                        {creditos.map((c, i) => (
                                            <tr key={i} className="hover:bg-blue-50/50 dark:hover:bg-blue-900/10 transition-colors">
                                                <td className="p-3 whitespace-nowrap text-slate-500">{Utils.date.formatNice(c.data)}</td>
                                                <td className="p-3 font-medium">{c.placa}</td>
                                                <td className="p-3 text-right font-bold text-slate-800 dark:text-slate-200">{Utils.formatters.currency(c.valor)}</td>
                                            </tr>
                                        ))}
                                        {creditos.length === 0 && <tr><td colSpan="3" className="p-8 text-center text-slate-400 italic text-xs">Nenhum crédito encontrado.</td></tr>}
                                    </tbody>
                                </table>
                            )}
                        </div>
                        <div className="p-4 bg-slate-50 dark:bg-slate-800/80 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center">
                            <span className="text-xs font-medium text-slate-500 uppercase">Total Crédito</span>
                            <span className="text-sm font-bold text-blue-600 dark:text-blue-400 font-mono">{Utils.formatters.currency(totalCred)}</span>
                        </div>
                    </div>

                    {/* COLUNA 2: DÉBITOS */}
                    <div className="flex-1 flex flex-col border-r border-slate-200 dark:border-slate-700 min-w-[320px] bg-white dark:bg-slate-800">
                        <div className="p-3 bg-emerald-50 dark:bg-emerald-900/20 border-b border-emerald-100 dark:border-emerald-800/30 flex justify-between items-center">
                            <span className="font-bold text-emerald-700 dark:text-emerald-400 text-xs uppercase tracking-wider flex items-center gap-2">
                                <Icons.DollarSign width={14} /> Pagamentos (Débitos)
                            </span>
                            <span className="bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300 text-[10px] font-bold px-2 py-0.5 rounded-full">{debitos.length} itens</span>
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-0">
                            {loading ? <div className="p-10 text-center text-slate-400 text-xs animate-pulse">Carregando dados...</div> : (
                                <table className="w-full text-xs text-left border-collapse">
                                    <thead className="sticky top-0 bg-slate-50 dark:bg-slate-800/95 backdrop-blur shadow-sm text-slate-500 font-semibold z-10">
                                        <tr>
                                            <th className="p-3 border-b dark:border-slate-700 font-medium">Doc</th>
                                            <th className="p-3 border-b dark:border-slate-700 font-medium">Texto</th>
                                            <th className="p-3 border-b dark:border-slate-700 text-right font-medium">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 dark:divide-slate-700 text-slate-600 dark:text-slate-300">
                                        {debitos.map((d, i) => (
                                            <tr key={i} className="hover:bg-emerald-50/50 dark:hover:bg-emerald-900/10 transition-colors">
                                                <td className="p-3 font-mono text-[10px] text-slate-500">{d.n_documento}</td>
                                                <td className="p-3 truncate max-w-[140px]" title={d.texto}>{d.texto || '-'}</td>
                                                <td className="p-3 text-right font-bold text-emerald-600 dark:text-emerald-400">{Utils.formatters.currency(Math.abs(d.valor))}</td>
                                            </tr>
                                        ))}
                                        {debitos.length === 0 && <tr><td colSpan="3" className="p-8 text-center text-slate-400 italic text-xs">Nenhum pagamento localizado.</td></tr>}
                                    </tbody>
                                </table>
                            )}
                        </div>
                        <div className="p-4 bg-slate-50 dark:bg-slate-800/80 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center">
                            <span className="text-xs font-medium text-slate-500 uppercase">Total Débito</span>
                            <span className="text-sm font-bold text-emerald-600 dark:text-emerald-400 font-mono">{Utils.formatters.currency(totalDeb)}</span>
                        </div>
                    </div>

                    {/* COLUNA 3: AJUSTES */}
                    <div className="flex-1 flex flex-col min-w-[320px] bg-slate-50 dark:bg-slate-900/50">
                        <div className="p-3 bg-orange-50 dark:bg-orange-900/20 border-b border-orange-100 dark:border-orange-800/30 flex justify-between items-center">
                            <span className="font-bold text-orange-700 dark:text-orange-400 text-xs uppercase tracking-wider flex items-center gap-2">
                                <Icons.Settings width={14} /> Ajustes Manuais
                            </span>
                            <span className="bg-orange-100 dark:bg-orange-900/40 text-orange-700 dark:text-orange-300 text-[10px] font-bold px-2 py-0.5 rounded-full">{listaAjustes.length} itens</span>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-3">
                            {listaAjustes.map(aj => (
                                <div key={aj.id} className="bg-white dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700 text-xs shadow-sm hover:shadow-md transition-all group relative">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-[10px]">{aj.tipo}</span>
                                            <span className="text-[10px] text-slate-400">{Utils.date.formatNice(aj.created_at)}</span>
                                        </div>
                                        <button 
                                            onClick={() => onDeleteAjuste(aj.id)} 
                                            className="text-slate-300 hover:text-red-500 transition-colors p-1 absolute top-2 right-2 opacity-0 group-hover:opacity-100"
                                            title="Excluir Ajuste"
                                        >
                                            <Icons.Trash2 width={14} />
                                        </button>
                                    </div>
                                    <div className="text-slate-500 dark:text-slate-400 mb-2 leading-relaxed italic border-l-2 border-slate-200 dark:border-slate-600 pl-2">
                                        {aj.observacao || 'Sem observação'}
                                    </div>
                                    <div className="text-right font-bold text-orange-600 dark:text-orange-400 font-mono text-sm border-t border-slate-100 dark:border-slate-700 pt-2 mt-2">
                                        {Utils.formatters.currency(aj.valor)}
                                    </div>
                                </div>
                            ))}
                            {listaAjustes.length === 0 && (
                                <div className="flex flex-col items-center justify-center h-40 text-slate-400 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50/50 dark:bg-slate-800/30 m-2">
                                    <Icons.Info width={24} className="mb-2 opacity-50"/>
                                    <span className="text-xs">Nenhum ajuste lançado.</span>
                                </div>
                            )}
                        </div>

                        {/* Formulário de Inserção */}
                        <div className="p-4 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
                            <h4 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Novo Lançamento</h4>
                            <form onSubmit={handleSubmitAjuste} className="space-y-3">
                                <div className="flex gap-3">
                                    <div className="w-1/3">
                                        <select 
                                            className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-xs rounded-lg px-3 py-2.5 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all appearance-none font-medium" 
                                            value={localAjuste.tipo} 
                                            onChange={e=>setLocalAjuste({...localAjuste, tipo:e.target.value})}
                                        >
                                            <option value="ISS">ISS</option>
                                            <option value="IRRF">IRRF</option>
                                            <option value="PCC">PCC</option>
                                            <option value="INSS">INSS</option>
                                            <option value="DESC. TÉCNICO">Desc. Técnico</option>
                                            <option value="OUTROS">Outros</option>
                                        </select>
                                    </div>
                                    <div className="w-1/3 relative">
                                        <span className="absolute left-3 top-2.5 text-slate-400 text-xs">R$</span>
                                        <input 
                                            type="text" 
                                            placeholder="0,00" 
                                            className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-xs rounded-lg pl-8 pr-3 py-2.5 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all font-mono font-bold placeholder:font-sans" 
                                            value={localAjuste.valor} 
                                            onChange={e=>setLocalAjuste({...localAjuste, valor:e.target.value})} 
                                            required 
                                        />
                                    </div>
                                    <button 
                                        type="submit" 
                                        disabled={isSaving} 
                                        className="w-1/3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-3 py-2.5 text-xs font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20"
                                    >
                                        {isSaving ? <div className="loader h-3 w-3 border-2 border-white/30 border-t-white rounded-full"></div> : <><Icons.Plus width={14}/> Adicionar</>}
                                    </button>
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="Descrição ou observação (Opcional)" 
                                    className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-xs rounded-lg px-3 py-2.5 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder:text-slate-400" 
                                    value={localAjuste.obs} 
                                    onChange={e=>setLocalAjuste({...localAjuste, obs:e.target.value})} 
                                />
                            </form>
                        </div>
                        <div className="p-4 bg-slate-50 dark:bg-slate-800/80 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center">
                            <span className="text-xs font-medium text-slate-500 uppercase">Total Ajustes</span>
                            <span className="text-sm font-bold text-orange-600 dark:text-orange-400 font-mono">{Utils.formatters.currency(totalAj)}</span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    );
};
// =============================================================================
// 2. COMPONENTE PRINCIPAL (TELA)
// =============================================================================
const TerceirizacaoPagamentos = ({ supabaseClient, filters, onNotify }) => {
    const [data, setData] = useState(null);
    const [loading, setLoading] = useState(false);
    
    // Estados do Modal
    const [selectedProvider, setSelectedProvider] = useState(null);
    const [drillData, setDrillData] = useState(null);
    const [drillLoading, setDrillLoading] = useState(false);
    const [ajustesData, setAjustesData] = useState([]);

    // 1. Busca Tabela Principal
    const fetchData = async () => {
        setLoading(true);
        try {
            const { data: result, error } = await supabaseClient.rpc('get_relatorio_pagamentos', {
                p_data_ini: filters.dateIni,
                p_data_fim: filters.dateFim
            });
            if (error) throw error;
            setData(result);
        } catch (e) {
            console.error(e);
            onNotify("Erro ao carregar: " + e.message, "error");
        } finally {
            setLoading(false);
        }
    };

    // 2. Busca Detalhes
    const fetchDetalhes = async (providerCode) => {
        setDrillLoading(true);
        try {
            const { data: resOps, error: errOps } = await supabaseClient.rpc('get_detalhe_pagamentos_terceiro', {
                p_data_ini: filters.dateIni, p_data_fim: filters.dateFim, p_codigo_sap: providerCode
            });
            if (errOps) throw errOps;
            setDrillData(resOps);

            const { data: resAj, error: errAj } = await supabaseClient.rpc('get_ajustes_terceiro', {
                p_data_ini: filters.dateIni, p_data_fim: filters.dateFim, p_codigo_sap: providerCode
            });
            if (errAj) throw errAj;
            setAjustesData(resAj || []);

        } catch (e) {
            onNotify("Erro ao detalhar: " + e.message, "error");
        } finally {
            setDrillLoading(false);
        }
    };

    // Eventos
    const handleRowClick = (provider) => {
        console.log("Clicou no fornecedor:", provider);
        setSelectedProvider(provider); // Isso abre o modal
        setDrillData(null); 
        setAjustesData([]);
        fetchDetalhes(provider.sap_code);
    };

    const handleAddAjuste = async (novoAjuste) => {
        try {
            const { error } = await supabaseClient.from('ajustes_conciliacao').insert({
                terceiro_codigo: selectedProvider.sap_code,
                data_referencia: filters.dateFim,
                tipo: novoAjuste.tipo,
                valor: Utils.formatters.parseBrl(novoAjuste.valor),
                observacao: novoAjuste.obs,
                usuario: 'Sistema'
            });
            if (error) throw error;
            
            onNotify("Ajuste salvo!", "success");
            await fetchDetalhes(selectedProvider.sap_code);
            fetchData(); // Atualiza saldo na tabela de trás
        } catch (err) {
            onNotify("Erro: " + err.message, "error");
        }
    };

    const handleDeleteAjuste = async (id) => {
        if(!confirm("Excluir ajuste?")) return;
        try {
            const { error } = await supabaseClient.from('ajustes_conciliacao').delete().eq('id', id);
            if(error) throw error;
            await fetchDetalhes(selectedProvider.sap_code);
            fetchData();
            onNotify("Excluído.", "success");
        } catch(e) { onNotify(e.message, "error"); }
    };

    useEffect(() => {
        if (filters.dateIni && filters.dateFim) fetchData();
    }, [filters.dateIni, filters.dateFim]);

    if (!data) return <div className="p-10 text-center text-slate-400">Carregando conciliação...</div>;
    const { kpis, lista } = data;

    return (
        <>
            {/* 1. O MODAL FICA AQUI FORA (Para fugir da animação que quebra o 'fixed') */}
            {selectedProvider && (
                <ConciliacaoModal 
                    provider={selectedProvider}
                    data={drillData}
                    loading={drillLoading}
                    ajustes={ajustesData}
                    onClose={() => setSelectedProvider(null)}
                    onAddAjuste={handleAddAjuste}
                    onDeleteAjuste={handleDeleteAjuste}
                />
            )}

            {/* 2. O CONTEÚDO DA TELA FICA AQUI (Com a animação) */}
            <div className="space-y-6 animate-enter pb-10">
                
                <div className="hidden print:block mb-4 border-b border-black pb-2">
                    <h1 className="text-xl font-bold">Relatório de Conciliação de Pagamentos</h1>
                    <p className="text-xs">Período: {Utils.date.formatNice(filters.dateIni)} à {Utils.date.formatNice(filters.dateFim)}</p>
                </div>

                {/* KPIs */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 no-print">
                    <Card title="Apurado (Crédito)" value={Utils.formatters.currency(kpis.valor_apurado_total)} iconName="fileText" color="blue" />
                    <Card title="Pago (Débito)" value={Utils.formatters.currency(kpis.valor_pago_total)} iconName="dollarSign" color="emerald" />
                    <Card title="Ajustes/Impostos" value={Utils.formatters.currency(kpis.valor_ajustado_total)} iconName="activity" color="purple" subtext="Adicionados manualmente" />
                    <Card title="Pendentes/Divergentes" value={kpis.qtd_diferenca + kpis.qtd_pendente} iconName="alertCircle" color="red" />
                </div>

                {/* Tabela Principal */}
                <div className="glass-card overflow-hidden print:border-slate-300">
                    <div className="p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex justify-between items-center print:bg-slate-100">
                        <h3 className="font-bold text-slate-700 dark:text-slate-200 text-sm flex items-center gap-2">
                            <Icons.Table className="w-4 h-4" /> Conciliação Analítica
                        </h3>
                        <div className="flex gap-2">
                            <span className="text-[10px] text-slate-400 font-bold self-center no-print mr-2">Clique na linha para detalhar</span>
                            <button onClick={() => window.print()} className="text-xs font-bold text-blue-600 hover:underline no-print flex items-center gap-1"><Icons.Download className="w-3 h-3" /> Imprimir</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-xs text-left text-slate-600 dark:text-slate-300">
                            <thead className="uppercase bg-slate-100 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 font-bold text-slate-500">
                                <tr>
                                    <th className="px-4 py-3">Fornecedor</th>
                                    <th className="px-4 py-3 text-center">SAP</th>
                                    <th className="px-4 py-3 text-right">Apurado</th>
                                    <th className="px-4 py-3 text-right">Pago</th>
                                    <th className="px-4 py-3 text-right">Ajustes</th>
                                    <th className="px-4 py-3 text-right">Saldo</th>
                                    <th className="px-4 py-3 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                                {lista.map((row, i) => (
                                    <tr key={i} onClick={() => handleRowClick(row)} className={`cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors ${i % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-slate-50/50 dark:bg-slate-800/20'}`}>
                                        <td className="px-4 py-2 font-bold group-hover:text-blue-600">{row.nome_terceiro}</td>
                                        <td className="px-4 py-2 text-center font-mono text-slate-500">{row.sap_code}</td>
                                        <td className="px-4 py-2 text-right">{Utils.formatters.currency(row.v_credito)}</td>
                                        <td className="px-4 py-2 text-right text-slate-500">{Utils.formatters.currency(row.v_pago_real)}</td>
                                        <td className="px-4 py-2 text-right text-purple-600 font-medium">{Utils.formatters.currency(row.v_ajuste)}</td>
                                        <td className={`px-4 py-2 text-right font-bold ${Math.abs(row.saldo) > 1.00 ? 'text-red-500' : 'text-green-600'}`}>{Utils.formatters.currency(row.saldo)}</td>
                                        <td className="px-4 py-2 text-center">
                                            <span className={`px-2 py-1 rounded text-[10px] font-bold border ${row.status === 'PAGO TOTAL' ? 'bg-green-100 text-green-700 border-green-200' : (row.status === 'DIFERENÇA' ? 'bg-orange-100 text-orange-700 border-orange-200' : 'bg-red-100 text-red-700 border-red-200')}`}>{row.status}</span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </>
    );
};
        // ============================================================================
// COMPONENTE: TURNOVER (RH)
// ============================================================================
const TerceirizacaoTurnover = ({ supabaseClient, filters, onNotify }) => {
    const [data, setData] = useState(null);
    const [loading, setLoading] = useState(true);

    const fetchData = async () => {
        setLoading(true);
        try {
            // Agora usa as datas do filtro global (dateIni e dateFim)
            const { data: res, error } = await supabaseClient.rpc('get_terceirizacao_turnover', {
                p_data_ini: filters.dateIni,
                p_data_fim: filters.dateFim,
                p_filial: filters.filial || 'Todas'
            });

            if (error) throw error;
            setData(res);
        } catch (e) {
            console.error("Erro Turnover:", e);
            onNotify("Erro ao calcular Turnover: " + e.message, "error");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        if (filters.dateIni && filters.dateFim) {
            fetchData();
        }
    }, [filters.dateIni, filters.dateFim, filters.filial]);

    if (loading || !data) {
        return (
            <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                <div className="loader h-10 w-10 border-4 border-cyan-500 rounded-full border-t-transparent mb-4 animate-spin"></div>
                <p>Calculando indicadores de Turnover...</p>
            </div>
        );
    }

    return (
        <div className="space-y-6 animate-enter pb-10">
            {/* Header Simples (Filtro fica no App.js agora) */}
            <div className="flex justify-between items-end mb-2 no-print">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <Icons.Briefcase className="text-cyan-500" /> Turnover (RH)
                    </h2>
                    <p className="text-sm text-slate-500 mt-1">
                        Análise de {Utils.date.formatNice(filters.dateIni)} até {Utils.date.formatNice(filters.dateFim)}
                    </p>
                </div>
            </div>

            {/* KPIs */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <Card 
                    title="Frota Inicial" 
                    value={data.headcount_inicial} 
                    iconName="truck" 
                    color="blue" 
                    subtext="Ativos no início do período"
                />
                <Card 
                    title="Admissões (Novos)" 
                    value={data.admissoes} 
                    iconName="userPlus" 
                    color="emerald" 
                    subtext="Novos contratos"
                />
                <Card 
                    title="Desligamentos" 
                    value={data.demissoes} 
                    iconName="userMinus" 
                    color="rose" 
                    subtext="Contratos encerrados"
                />
                <Card 
                    title="Taxa de Turnover" 
                    value={Number(data.turnover_perc).toFixed(2) + "%"} 
                    iconName="activity" 
                    color={data.turnover_perc > 5 ? "red" : "purple"} 
                    subtext="(Adm + Dem) / Inicial"
                />
            </div>

            {/* Tabelas de Detalhamento */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                {/* Tabela de Admissões */}
                <div className="glass-card overflow-hidden flex flex-col h-[400px]">
                    <div className="p-4 bg-emerald-50 dark:bg-emerald-900/10 border-b border-emerald-100 dark:border-emerald-800/30 flex justify-between items-center">
                        <h3 className="font-bold text-emerald-700 dark:text-emerald-400 text-sm flex items-center gap-2">
                            <Icons.TrendingUp width={16} /> Entradas / Admissões
                        </h3>
                        <span className="text-xs font-bold bg-white dark:bg-slate-800 px-2 py-1 rounded text-emerald-600 border border-emerald-200 dark:border-emerald-900">
                            {data.admissoes}
                        </span>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar">
                        <table className="w-full text-xs text-left">
                            <thead className="sticky top-0 bg-white dark:bg-slate-900 shadow-sm text-slate-500 font-semibold">
                                <tr>
                                    <th className="p-3 bg-slate-50 dark:bg-slate-800">Data Início</th>
                                    <th className="p-3 bg-slate-50 dark:bg-slate-800">Fornecedor</th>
                                    <th className="p-3 bg-slate-50 dark:bg-slate-800">Equipamento</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 dark:divide-slate-800 text-slate-600 dark:text-slate-300">
                                {(data.lista_admitidos || []).map((item, i) => (
                                    <tr key={i} className="hover:bg-emerald-50/50 dark:hover:bg-emerald-900/10 transition-colors">
                                        <td className="p-3 font-mono text-emerald-600 dark:text-emerald-400">{Utils.date.formatNice(item.data_inicial)}</td>
                                        <td className="p-3 font-bold">{item.fornecedor}</td>
                                        <td className="p-3">{item.equipamento}</td>
                                    </tr>
                                ))}
                                {(!data.lista_admitidos || data.lista_admitidos.length === 0) && (
                                    <tr><td colSpan="3" className="p-10 text-center italic text-slate-400">Nenhuma admissão registrada.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>

                {/* Tabela de Demissões */}
                <div className="glass-card overflow-hidden flex flex-col h-[400px]">
                    <div className="p-4 bg-rose-50 dark:bg-rose-900/10 border-b border-rose-100 dark:border-rose-800/30 flex justify-between items-center">
                        <h3 className="font-bold text-rose-700 dark:text-rose-400 text-sm flex items-center gap-2">
                            <Icons.TrendingDown width={16} /> Saídas / Desligamentos
                        </h3>
                        <span className="text-xs font-bold bg-white dark:bg-slate-800 px-2 py-1 rounded text-rose-600 border border-rose-200 dark:border-rose-900">
                            {data.demissoes}
                        </span>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar">
                        <table className="w-full text-xs text-left">
                            <thead className="sticky top-0 bg-white dark:bg-slate-900 shadow-sm text-slate-500 font-semibold">
                                <tr>
                                    <th className="p-3 bg-slate-50 dark:bg-slate-800">Data Fim</th>
                                    <th className="p-3 bg-slate-50 dark:bg-slate-800">Fornecedor</th>
                                    <th className="p-3 bg-slate-50 dark:bg-slate-800">Equipamento</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 dark:divide-slate-800 text-slate-600 dark:text-slate-300">
                                {(data.lista_demitidos || []).map((item, i) => (
                                    <tr key={i} className="hover:bg-rose-50/50 dark:hover:bg-rose-900/10 transition-colors">
                                        <td className="p-3 font-mono text-rose-600 dark:text-rose-400">{Utils.date.formatNice(item.data_final)}</td>
                                        <td className="p-3 font-bold">{item.fornecedor}</td>
                                        <td className="p-3">{item.equipamento}</td>
                                    </tr>
                                ))}
                                {(!data.lista_demitidos || data.lista_demitidos.length === 0) && (
                                    <tr><td colSpan="3" className="p-10 text-center italic text-slate-400">Nenhum desligamento registrado.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    );
};
// ============================================================================
// COMPONENTE: CADASTRO DE TERCEIROS (COM HOVER NAS AÇÕES)
// ============================================================================
const TerceirizacaoCadastros = ({ supabaseClient, onNotify }) => {
    const [terceiros, setTerceiros] = useState([]);
    const [loading, setLoading] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    
    // Estados do Modal
    const [showModal, setShowModal] = useState(false);
    const [isSaving, setIsSaving] = useState(false);
    const [loadingCep, setLoadingCep] = useState(false);
    
    // Estado do Formulário
    const [formData, setFormData] = useState({
        id: null,
        apelido: '',
        cod_sap: '',
        tipo_pessoa: 'Jurídica',
        cnpj: '',
        cpf: '',
        razao_social: '',
        nome_completo: '', 
        cep: '',
        rua: '',
        bairro: '',
        cidade: '',
        estado: '',
        email: '',
        telefone: ''
    });

    // --- FUNÇÕES AUXILIARES DE FORMATAÇÃO ---
    const formatDocumento = (val, type) => {
        if (!val) return '-';
        const str = String(val).replace(/\D/g, '');
        
        if (type === 'CNPJ' || str.length > 11) {
            return str.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2}).*/, "$1.$2.$3/$4-$5");
        } else {
            return str.replace(/^(\d{3})(\d{3})(\d{3})(\d{2}).*/, "$1.$2.$3-$4");
        }
    };

    const handleMaskInput = (e, type) => {
        let val = e.target.value.replace(/\D/g, ''); 
        if (type === 'CNPJ') {
            val = val.slice(0, 14);
            val = val.replace(/^(\d{2})(\d)/, "$1.$2");
            val = val.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
            val = val.replace(/\.(\d{3})(\d)/, ".$1/$2");
            val = val.replace(/(\d{4})(\d)/, "$1-$2");
            setFormData({...formData, cnpj: val});
        } else if (type === 'CPF') {
            val = val.slice(0, 11);
            val = val.replace(/^(\d{3})(\d)/, "$1.$2");
            val = val.replace(/^(\d{3})\.(\d{3})(\d)/, "$1.$2.$3");
            val = val.replace(/\.(\d{3})(\d)/, ".$1-$2");
            setFormData({...formData, cpf: val});
        } else if (type === 'TEL') {
            val = val.slice(0, 11);
            val = val.replace(/^(\d{2})(\d)/, "($1) $2");
            val = val.replace(/(\d)(\d{4})$/, "$1-$2");
            setFormData({...formData, telefone: val});
        }
    };

    // 1. Buscar Dados
    const fetchTerceiros = async () => {
        setLoading(true);
        try {
            const { data, error } = await supabaseClient
                .from('terceiros')
                .select('*')
                .order('apelido', { ascending: true });
            if (error) throw error;
            setTerceiros(data || []);
        } catch (e) {
            onNotify("Erro ao carregar: " + e.message, "error");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => { fetchTerceiros(); }, []);

    // 2. Busca CEP
    const checkCEP = async (e) => {
        const cep = e.target.value.replace(/\D/g, '');
        if (cep.length === 8) {
            setLoadingCep(true);
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                if (!data.erro) {
                    setFormData(prev => ({
                        ...prev,
                        rua: data.logradouro,
                        bairro: data.bairro,
                        cidade: data.localidade,
                        estado: data.uf
                    }));
                } else {
                    onNotify("CEP não encontrado.", "error");
                }
            } catch (err) {
                console.error(err);
            } finally {
                setLoadingCep(false);
            }
        }
    };

    // 3. Salvar
    const handleSave = async (e) => {
        e.preventDefault();
        setIsSaving(true);
        try {
            const payload = { 
                ...formData,
                cnpj: formData.cnpj.replace(/\D/g, ''), 
                cpf: formData.cpf.replace(/\D/g, ''),   
                nome_completo: formData.nome_completo || formData.razao_social 
            };

            let error;
            if (payload.id) {
                const { error: err } = await supabaseClient.from('terceiros').update(payload).eq('id', payload.id);
                error = err;
            } else {
                delete payload.id;
                const { error: err } = await supabaseClient.from('terceiros').insert(payload);
                error = err;
            }

            if (error) throw error;
            onNotify("Salvo com sucesso!", "success");
            setShowModal(false);
            fetchTerceiros();
        } catch (e) {
            onNotify("Erro ao salvar: " + e.message, "error");
        } finally {
            setIsSaving(false);
        }
    };

    // 4. Excluir
    const handleDelete = async (id) => {
        if (!confirm("Excluir cadastro?")) return;
        try {
            const { error } = await supabaseClient.from('terceiros').delete().eq('id', id);
            if (error) throw error;
            onNotify("Excluído.", "success");
            fetchTerceiros();
        } catch (e) {
            onNotify(e.message, "error");
        }
    };

    // 5. Filtro
    const filteredData = terceiros.filter(t => {
        const search = searchTerm.toLowerCase();
        return (
            (t.apelido || '').toLowerCase().includes(search) ||
            (t.razao_social || '').toLowerCase().includes(search) ||
            (t.cod_sap || '').toLowerCase().includes(search) ||
            (t.cnpj || '').includes(search)
        );
    });

    // 6. Abrir Modal
    const openModal = (item = null) => {
        if (item) {
            setFormData({
                ...item,
                cnpj: formatDocumento(item.cnpj, 'CNPJ'),
                cpf: formatDocumento(item.cpf, 'CPF'),
                rua: item.rua || '',
                bairro: item.bairro || '',
                cidade: item.cidade || '',
                estado: item.estado || '',
                cep: item.cep || '',
                email: item.email || '',
                telefone: item.telefone || ''
            });
        } else {
            setFormData({
                id: null, apelido: '', cod_sap: '', tipo_pessoa: 'Jurídica',
                cnpj: '', cpf: '', razao_social: '', nome_completo: '', 
                cep: '', rua: '', bairro: '', cidade: '', estado: '',
                email: '', telefone: ''
            });
        }
        setShowModal(true);
    };

    // --- CONTEÚDO DO MODAL (VIA PORTAL) ---
    const ModalContent = (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[99999] p-4" onClick={() => setShowModal(false)}>
            <div className="bg-white dark:bg-slate-900 w-full max-w-3xl rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 flex flex-col max-h-[90vh] overflow-hidden animate-enter" onClick={e => e.stopPropagation()}>
                
                <div className="px-6 py-4 border-b border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50 flex justify-between items-center">
                    <h3 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        {formData.id ? <Icons.Edit className="text-blue-500" /> : <Icons.Plus className="text-blue-500" />}
                        {formData.id ? 'Editar Cadastro' : 'Novo Cadastro'}
                    </h3>
                    <button onClick={() => setShowModal(false)} className="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full text-slate-500"><Icons.X width={20}/></button>
                </div>

                <div className="p-6 overflow-y-auto custom-scrollbar">
                    <form onSubmit={handleSave} className="space-y-6">
                        <div className="space-y-4">
                            <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 dark:border-slate-800 pb-2">Dados Cadastrais</h4>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="input-label">Código SAP <span className="text-red-500">*</span></label>
                                    <input type="text" required className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 font-mono text-slate-700 dark:text-white" 
                                        value={formData.cod_sap} onChange={e => setFormData({...formData, cod_sap: e.target.value})} placeholder="Ex: 4000..." />
                                </div>
                                <div>
                                    <label className="input-label">CNPJ</label>
                                    <input type="text" className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-slate-700 dark:text-white font-mono" 
                                        value={formData.cnpj} onChange={e => handleMaskInput(e, 'CNPJ')} placeholder="00.000.000/0000-00" maxLength={18} />
                                </div>
                                <div>
                                    <label className="input-label">CPF (Opcional)</label>
                                    <input type="text" className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-slate-700 dark:text-white font-mono" 
                                        value={formData.cpf} onChange={e => handleMaskInput(e, 'CPF')} placeholder="000.000.000-00" maxLength={14} />
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="input-label">Razão Social <span className="text-red-500">*</span></label>
                                    <input type="text" required className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-slate-700 dark:text-white" 
                                        value={formData.razao_social} onChange={e => setFormData({...formData, razao_social: e.target.value})} />
                                </div>
                                <div>
                                    <label className="input-label">Apelido <span className="text-red-500">*</span></label>
                                    <input type="text" required className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-slate-700 dark:text-white" 
                                        value={formData.apelido} onChange={e => setFormData({...formData, apelido: e.target.value})} />
                                </div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 dark:border-slate-800 pb-2">Endereço</h4>
                            <div className="flex gap-4">
                                <div className="w-1/3 relative">
                                    <label className="input-label">CEP {loadingCep && <span className="text-blue-500 animate-pulse text-[10px] ml-2">...</span>}</label>
                                    <input type="text" className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 font-mono text-slate-700 dark:text-white" 
                                        value={formData.cep} onChange={e => setFormData({...formData, cep: e.target.value})} onBlur={checkCEP} placeholder="00000-000" maxLength={9} />
                                </div>
                                <div className="w-2/3">
                                    <label className="input-label">Logradouro</label>
                                    <input type="text" className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-slate-700 dark:text-white" 
                                        value={formData.rua} onChange={e => setFormData({...formData, rua: e.target.value})} />
                                </div>
                            </div>
                            <div className="grid grid-cols-12 gap-4">
                                <div className="col-span-5"><label className="input-label">Bairro</label><input type="text" className="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-slate-700 dark:text-white" value={formData.bairro} onChange={e => setFormData({...formData, bairro: e.target.value})} /></div>
                                <div className="col-span-5"><label className="input-label">Cidade</label><input type="text" className="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-slate-700 dark:text-white" value={formData.cidade} onChange={e => setFormData({...formData, cidade: e.target.value})} /></div>
                                <div className="col-span-2"><label className="input-label">UF</label><input type="text" maxLength={2} className="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-slate-700 dark:text-white uppercase text-center" value={formData.estado} onChange={e => setFormData({...formData, estado: e.target.value.toUpperCase()})} /></div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 dark:border-slate-800 pb-2">Contato</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label className="input-label">E-mail</label><input type="email" className="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-slate-700 dark:text-white" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} /></div>
                                <div><label className="input-label">Telefone</label><input type="text" className="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-slate-700 dark:text-white" value={formData.telefone} onChange={e => handleMaskInput(e, 'TEL')} placeholder="(00) 00000-0000" /></div>
                            </div>
                        </div>

                        <div className="flex justify-end gap-3 pt-6 border-t border-slate-100 dark:border-slate-800">
                            <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-300 text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">Cancelar</button>
                            <button type="submit" disabled={isSaving} className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-lg flex items-center gap-2 transition-colors disabled:opacity-70">
                                {isSaving ? <div className="loader h-4 w-4 border-2 border-white rounded-full border-t-transparent"></div> : <><Icons.CheckCircle width={16} /> Salvar Cadastro</>}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    );

    return (
        <div className="space-y-6 animate-enter pb-10">
            {showModal && ReactDOM.createPortal(ModalContent, document.body)}

            <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                <div><h2 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><Icons.User className="text-blue-500" /> Cadastro de Terceiros</h2><p className="text-sm text-slate-500 mt-1">Gerencie a base de fornecedores.</p></div>
                <div className="flex gap-3 w-full md:w-auto">
                    <div className="relative flex-1 md:w-64"><Icons.Search className="absolute left-3 top-2.5 text-slate-400 w-4 h-4" /><input type="text" placeholder="Buscar..." className="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg pl-9 pr-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all text-slate-700 dark:text-white" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                    <button onClick={() => openModal()} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg"><Icons.Plus width={16} /> Novo</button>
                </div>
            </div>

            <div className="glass-card overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                        <thead className="text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
                            <tr>
                                <th className="px-6 py-3">Fornecedor / Razão Social</th>
                                <th className="px-6 py-3">Cód. SAP</th>
                                <th className="px-6 py-3">Documento</th>
                                <th className="px-6 py-3">Localização</th>
                                <th className="px-6 py-3 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                            {loading ? (<tr><td colSpan="5" className="p-8 text-center text-slate-400">Carregando...</td></tr>) : filteredData.length === 0 ? (<tr><td colSpan="5" className="p-8 text-center text-slate-400 italic">Nenhum registro.</td></tr>) : (
                                filteredData.map((row) => (
                                    <tr key={row.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors group">
                                        <td className="px-6 py-3">
                                            <div className="font-bold text-slate-800 dark:text-slate-200">{row.apelido}</div>
                                            <div className="text-xs text-slate-400 truncate max-w-[200px]" title={row.razao_social}>{row.razao_social}</div>
                                        </td>
                                        <td className="px-6 py-3 font-mono text-xs"><span className="bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded border border-slate-200 dark:border-slate-600">{row.cod_sap}</span></td>
                                        <td className="px-6 py-3 text-xs font-mono">
                                            {row.cnpj && <div className="mb-1"><span className="font-bold text-slate-500 mr-1">CNPJ:</span>{formatDocumento(row.cnpj, 'CNPJ')}</div>}
                                            {row.cpf && <div><span className="font-bold text-slate-500 mr-1">CPF:</span>{formatDocumento(row.cpf, 'CPF')}</div>}
                                        </td>
                                        <td className="px-6 py-3 text-xs">
                                            {row.cidade ? <span className="bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-2 py-0.5 rounded">{row.cidade}/{row.estado}</span> : '-'}
                                        </td>
                                        <td className="px-6 py-3 text-right">
                                            {/* EFEITO DE HOVER RETOMADO AQUI */}
                                            <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                <button onClick={() => openModal(row)} className="p-1.5 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded transition-colors" title="Editar"><Icons.Edit width={16} /></button>
                                                <button onClick={() => handleDelete(row.id)} className="p-1.5 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-colors" title="Excluir"><Icons.Trash2 width={16} /></button>
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
                <div className="p-3 bg-slate-50 dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 text-xs text-slate-500 text-center">Exibindo {filteredData.length} registros</div>
            </div>
        </div>
    );
};
        // ============================================================================
// COMPONENTE: RELATÓRIO DE ATIVOS (MULTI-SELECT CORRIGIDO)
// ============================================================================
const TerceirizacaoRelatorioAtivos = ({ supabaseClient, onNotify }) => {
    const [data, setData] = useState(null);
    const [loading, setLoading] = useState(false);
    
    // Filtros Locais
    const [filiaisOptions, setFiliaisOptions] = useState([]);
    const [selectedFiliais, setSelectedFiliais] = useState(['Todas']);

    // 1. Buscar lista de filiais disponíveis (Para o filtro não ficar vazio)
    const fetchFiliais = async () => {
        try {
            const { data, error } = await supabaseClient
                .from('concessao')
                .select('centro')
                .not('centro', 'is', null);
            
            if (error) throw error;

            // Remove duplicadas e ordena
            const uniqueBranchs = [...new Set(data.map(item => item.centro))].sort();
            setFiliaisOptions(uniqueBranchs);
        } catch (e) {
            console.error("Erro ao buscar filiais:", e);
        }
    };

    // 2. Buscar Dados do Relatório
    const fetchData = async () => {
        setLoading(true);
        try {
            const { data: res, error } = await supabaseClient.rpc('get_relatorio_ativos', {
                p_filiais: selectedFiliais
            });

            if (error) throw error;
            setData(res);
        } catch (e) {
            onNotify("Erro ao carregar ativos: " + e.message, "error");
        } finally {
            setLoading(false);
        }
    };

    // Inicialização
    useEffect(() => {
        fetchFiliais();
    }, []);

    // Recarrega quando muda o filtro
    useEffect(() => {
        fetchData();
    }, [selectedFiliais]);

    // Exportar Excel
    const handleExport = () => {
        if (!data || !data.lista.length) return onNotify("Sem dados para exportar.", "error");
        
        const XLSX = window.XLSX;
        if (!XLSX) return onNotify("Biblioteca Excel não carregada.", "error");

        const ws = XLSX.utils.json_to_sheet(data.lista.map(item => ({
            "Cód. SAP": item.cod_sap,
            "Nome / Razão": item.nome,
            "CNPJ": item.cnpj,
            "Filial": item.filial,
            "Veículo": item.veiculo,
            "Início Contrato": Utils.date.formatNice(item.data_inicial),
            "Dias Ativo": item.dias_ativo,
            "Valor Mensal": item.valor_base
        })));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Terceiros Ativos");
        XLSX.writeFile(wb, `Frota_Ativa_${new Date().toISOString().split('T')[0]}.xlsx`);
    };

    if (loading && !data) return <div className="p-10 text-center text-slate-400">Carregando frota ativa...</div>;
    
    // Fallback seguro se data for null
    const kpis = data?.kpis || { total_ativos: 0, frota_distinta: 0, custo_mensal: 0 };
    const lista = data?.lista || [];

    return (
        <div className="space-y-6 animate-enter pb-10">
            {/* Header e Filtros */}
            <div className="flex flex-col md:flex-row justify-between items-end mb-4 no-print gap-4">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <Icons.CheckCircle className="text-emerald-500" /> Relatório de Ativos
                    </h2>
                    <p className="text-sm text-slate-500 mt-1">
                        Terceiros com contrato vigente.
                    </p>
                </div>
                
                <div className="flex items-center gap-3 w-full md:w-auto">
                    {/* Componente MultiSelect (Já existente no seu código) */}
                    <div className="w-full md:w-64">
                        <MultiSelectDropdown 
                            label="Filtrar Filiais"
                            options={filiaisOptions}
                            selected={selectedFiliais}
                            onChange={setSelectedFiliais}
                        />
                    </div>

                    <button 
                        onClick={handleExport}
                        className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg transition-all h-[38px] mt-auto"
                    >
                        <Icons.Download width={16} /> Excel
                    </button>
                </div>
            </div>

            {/* KPIs */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <Card 
                    title="Terceiros Ativos" 
                    value={kpis.total_ativos} 
                    iconName="user" 
                    color="blue" 
                    subtext="Contratos vigentes"
                />
                <Card 
                    title="Frota (Veículos)" 
                    value={kpis.frota_distinta} 
                    iconName="truck" 
                    color="orange" 
                    subtext="Equipamentos distintos"
                />
                <Card 
                    title="Custo Fixo Mensal" 
                    value={Utils.formatters.currency(kpis.custo_mensal)} 
                    iconName="dollarSign" 
                    color="purple" 
                    subtext="Soma dos valores base"
                />
            </div>

            {/* Tabela */}
            <div className="glass-card overflow-hidden">
                <div className="p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex justify-between items-center">
                    <h3 className="font-bold text-slate-700 dark:text-slate-200 text-sm flex items-center gap-2">
                        <Icons.ListFilter width={16} /> Detalhamento da Frota
                    </h3>
                    <span className="text-xs font-bold bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 px-2 py-1 rounded text-slate-500">
                        {lista.length} Registros
                    </span>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-xs text-left text-slate-600 dark:text-slate-300">
                        <thead className="uppercase bg-slate-100 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 font-bold text-slate-500">
                            <tr>
                                <th className="px-4 py-3">Status</th>
                                <th className="px-4 py-3">SAP / Nome</th>
                                <th className="px-4 py-3">Filial</th>
                                <th className="px-4 py-3">Veículo</th>
                                <th className="px-4 py-3">Início</th>
                                <th className="px-4 py-3 text-right">Valor Base</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                            {lista.map((row, i) => (
                                <tr key={i} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                    <td className="px-4 py-3">
                                        <span className="bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 px-2 py-1 rounded text-[10px] font-bold border border-emerald-200 dark:border-emerald-800">
                                            ATIVO
                                        </span>
                                    </td>
                                    <td className="px-4 py-3">
                                        <div className="font-bold text-slate-800 dark:text-slate-200">{row.nome}</div>
                                        <div className="text-[10px] text-slate-400 font-mono">SAP: {row.cod_sap} | Doc: {row.cnpj || '-'}</div>
                                    </td>
                                    <td className="px-4 py-3">
                                        <div className="font-medium bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded inline-block text-[10px] border border-slate-200 dark:border-slate-700">{row.filial}</div>
                                    </td>
                                    <td className="px-4 py-3">
                                        <div className="flex items-center gap-2">
                                            <div className="p-1 bg-orange-100 dark:bg-orange-900/30 text-orange-600 rounded"><Icons.Truck width={12} /></div>
                                            <span className="font-mono font-bold">{row.veiculo}</span>
                                        </div>
                                    </td>
                                    <td className="px-4 py-3">
                                        <div>{Utils.date.formatNice(row.data_inicial)}</div>
                                        <div className="text-[9px] text-slate-400">{row.dias_ativo} dias ativo</div>
                                    </td>
                                    <td className="px-4 py-3 text-right font-mono font-bold text-slate-700 dark:text-slate-200">
                                        {Utils.formatters.currency(row.valor_base)}
                                    </td>
                                </tr>
                            ))}
                            {lista.length === 0 && (
                                <tr>
                                    <td colSpan="6" className="p-10 text-center italic text-slate-400">
                                        Nenhum terceiro ativo encontrado para os filtros selecionados.
                                    </td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};
        const App = () => {
            
            const [supabaseClient, setSupabaseClient] = useState(null);
            const [session, setSession] = useState(null);
            const [userRole, setUserRole] = useState(null);
            const [loading, setLoading] = useState(false);
            const [logs, setLogs] = useState([]);
            
            const [isDark, setIsDark] = useState(() => {
                if (typeof window !== 'undefined') {
                    return localStorage.getItem('theme') === 'dark' || 
                           (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
                }
                return false;
            });
            
            const chartColors = getChartColors(isDark);
            const currentYear = new Date().getFullYear();
            const [drePeriodoIni, setDrePeriodoIni] = useState(`${currentYear}-01`);
            const [drePeriodoFim, setDrePeriodoFim] = useState(`${currentYear}-12`);
            const [dreUsinas, setDreUsinas] = useState(['Todas']);
            const [mappings, setMappings] = useState([]);
            
            useEffect(() => {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [isDark]);

            useEffect(() => {
                const { createClient } = window.supabase || {};
                if (createClient) {
                    const client = createClient('https://jsmnykikflkjceiqfmne.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzbW55a2lrZmxramNlaXFmbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTI5NzYsImV4cCI6MjA3OTU4ODk3Nn0.1EtrQTvZERRe8igl0PYnGH8H9SXuOg7mq4PVZVwRJVA');
                    setSupabaseClient(client);
                } else {
                    console.error("Supabase library not loaded");
                }
            }, []);

            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [expandedModules, setExpandedModules] = useState({ terceirizacao: false, controladoria: false, diesel: false });
            const [view, setView] = useState('dashboard');
            const [subView, setSubView] = useState('dash');
            const [dashboardData, setDashboardData] = useState({ kpis: { total_vol: 0, total_val: 0, vol_bomba: 0, vol_transp: 0 }, chart_class: [], chart_plate: [], chart_evo: [], chart_branch: [] });
            const [dieselData, setDieselData] = useState([]);
            const [controladoriaAnalise, setControladoriaAnalise] = useState([]);
            const [controladoriaRaw, setControladoriaRaw] = useState([]);
            const [resumoData, setResumoData] = useState([]);
            const [confirmData, setConfirmData] = useState(null);
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
            const [filters, setFilters] = useState({ month: 'Todos', filial: 'Todas', cidade: 'Todas', ctrlPeriodo: '', ctrlPeriodoComp: '', ctrlUsina: 'Todas', ctrlTipo: 'Despesa', dieselPeriodo: '', dateIni: firstDay, dateFim: lastDay });
            const [selectedReportPeriods, setSelectedReportPeriods] = useState([]);
            const [drillDownConta, setDrillDownConta] = useState(null);
            const [controladoriaContas, setControladoriaContas] = useState([]);
            const [controladoriaFiliais, setControladoriaFiliais] = useState([]);
            const [rankingFilter, setRankingFilter] = useState('top10');

            const addLog = (msg, type='info') => setLogs(p => [{msg, type}, ...p]);

            const uniqueReportPeriods = useMemo(() => {
                if (view === 'controladoria' && subView === 'report') {
                    if (!controladoriaRaw || controladoriaRaw.length === 0) return [];
                    return [...new Set(controladoriaRaw.map(item => item.periodo))].sort();
                }
                if (!resumoData || resumoData.length === 0) return [];
                return [...new Set(resumoData.map(item => item.mes || item.periodo || 'Unknown'))].sort();
            }, [resumoData, controladoriaRaw, view, subView]);

            const filteredReportData = useMemo(() => {
                if (view === 'controladoria' && subView === 'report') {
                    if (!controladoriaRaw) return [];
                    if (selectedReportPeriods.length === 0) return controladoriaRaw; 
                    return controladoriaRaw.filter(item => selectedReportPeriods.includes(item.periodo));
                }
                if (!resumoData) return [];
                if (selectedReportPeriods.length === 0) return resumoData;
                return resumoData.filter(item => selectedReportPeriods.includes(item.mes || item.periodo));
            }, [resumoData, controladoriaRaw, selectedReportPeriods, view, subView]);

            useEffect(() => {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                const m = (today.getMonth() + 1).toString().padStart(2, '0');
                const y = today.getFullYear();
                const cur = `${y}-${m}`;
                const prevDate = new Date(today); prevDate.setMonth(prevDate.getMonth() - 1);
                const pm = prevDate.getMonth() + 1; const py = prevDate.getFullYear();
                const defaultPrevPeriod = `${py}-${pm.toString().padStart(2, '0')}`;
                setFilters(prev => ({...prev, dieselPeriodo: cur}));
                const loadLatestCtrl = async () => {
                    if (!supabaseClient) return;
                    const { data } = await supabaseClient.from('controladoria_importacoes').select('periodo').order('periodo', { ascending: false }).limit(1);
                    if (data && data.length > 0) {
                        setFilters(prev => ({...prev, ctrlPeriodo: data[0].periodo, ctrlPeriodoComp: defaultPrevPeriod}));
                    } else {
                        setFilters(prev => ({...prev, ctrlPeriodo: cur, ctrlPeriodoComp: defaultPrevPeriod}));
                    }
                };
                loadLatestCtrl();
                if (supabaseClient) {
                    supabaseClient.auth.getSession().then(({ data: { session } }) => {
                        if(session) { setSession(session); checkUserRole(session.user.id, session.user.email); }
                    });
                    const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                        setSession(session);
                        if(session) checkUserRole(session.user.id, session.user.email); else setUserRole(null);
                    });
                    return () => subscription.unsubscribe();
                }
            }, [supabaseClient]);

            useEffect(() => {
                if(!session) return;
                if(view === 'dashboard') fetchDashboard();
                if(view === 'reports') fetchReport();
                if(view === 'controladoria') {
                    if(subView === 'dash') { fetchControladoriaAnalitico(); fetchControladoriaFiliais(); }
                    if(subView === 'report') fetchControladoriaRaw();
                    if(subView === 'centro_custo') fetchControladoriaContasAmigaveis();
                    if(subView === 'dre') { fetchControladoriaFiliais(); fetchDREData(); }
                }
                if(view === 'diesel' && (subView === 'dash' || subView === 'report')) fetchDieselData();
            }, [view, subView, filters, session, drePeriodoIni, drePeriodoFim]);

            const checkUserRole = async (userId, email) => {
                const { data } = await supabaseClient.from('user_roles').select('role').eq('user_id', userId).single();
                let role = data?.role || (email.includes('admin') ? 'admin' : 'terceirizacao');
                setUserRole(role);
                if (role === 'controladoria') handleSetView('controladoria', 'dash');
                else if (role === 'diesel') handleSetView('diesel', 'dash');
                else handleSetView('dashboard');
            };

            const handleSetView = (v, sv) => { 
                setView(v); 
                if(sv) setSubView(sv); 
                setSelectedReportPeriods([]);
            };

            const fetchDashboard = async () => {
    setLoading(true);
    try {
        // Chamada RPC atualizada com data_ini e data_fim
        const { data, error } = await supabaseClient.rpc('get_dashboard_stats', { 
            p_data_ini: filters.dateIni, 
            p_data_fim: filters.dateFim, 
            selected_branch: filters.filial 
        });

        if(error) throw error; 
        if(data) setDashboardData(data);
    } catch(e) { 
        console.error(e); 
        addLog("Erro ao carregar dashboard: " + e.message, 'error');
    } finally { 
        setLoading(false);
    }
};

            const fetchReport = async () => {
                setLoading(true);
                try {
                    const { data } = await supabaseClient.from('resumo_mensal').select('*').limit(5000);
                    if(data) setResumoData(data);
                } catch(e) { addLog(e.message, "error"); } finally { setLoading(false); }
            };

            const fetchDieselData = async () => {
                if(!filters.dieselPeriodo) return;
                setLoading(true);
                try { const { data } = await supabaseClient.from('diesel_estoque').select('*').eq('periodo', filters.dieselPeriodo).order('usina'); setDieselData(data || []); } catch(e) { addLog(e.message, 'error'); } finally { setLoading(false); }
            };

            const fetchControladoriaAnalitico = async () => {
                if(!filters.ctrlPeriodo) return;
                setLoading(true);
                try {
                    const { data: dataAtual } = await supabaseClient.rpc('get_controladoria_analise_contas', { p_periodo: filters.ctrlPeriodo, p_tipo: filters.ctrlTipo, p_usina: filters.ctrlUsina === 'Todas' ? null : filters.ctrlUsina });
                    let dataComp = [];
                    if (filters.ctrlPeriodoComp) {
                        const { data: resComp } = await supabaseClient.rpc('get_controladoria_analise_contas', { p_periodo: filters.ctrlPeriodoComp, p_tipo: filters.ctrlTipo, p_usina: filters.ctrlUsina === 'Todas' ? null : filters.ctrlUsina });
                        dataComp = resComp || [];
                    }
                    const merged = (dataAtual || []).map(item => {
                        const match = dataComp.find(c => c.conta === item.conta);
                        const vAnt = match ? parseFloat(match.valor_atual) : 0;
                        const vAtu = parseFloat(item.valor_atual);
                        let variacao = 0;
                        if (vAnt !== 0) variacao = ((vAtu - vAnt) / Math.abs(vAnt)) * 100;
                        else if (vAtu !== 0) variacao = 100;
                        return { ...item, variacao_perc: variacao };
                    });
                    setControladoriaAnalise(merged);
                } catch(e) { addLog(e.message, 'error'); } finally { setLoading(false); }
            };

            const fetchControladoriaRaw = async () => {
                setLoading(true);
                try {
                    let q = supabaseClient.from('controladoria_importacoes').select('*');
                    if(filters.ctrlPeriodo) q = q.eq('periodo', filters.ctrlPeriodo);
                    const { data } = await q.limit(2000).order('usina');
                    setControladoriaRaw((data || []).map(row => ({ periodo: row.periodo, usina: row.usina, custo_total: parseFloat(row.custo_total)||0, volume_total: parseFloat(row.volume_total)||0, ...row.detalhes })));
                } catch(e) { addLog(e.message, 'error'); } finally { setLoading(false); }
            };

            const fetchDREData = async () => {
                if(!drePeriodoIni || !drePeriodoFim) return;
                setLoading(true);
                try {
                    const { data: mapData } = await supabaseClient.from('controladoria_de_para').select('*');
                    setMappings(mapData || []);
                    const { data: rawData, error } = await supabaseClient.from('controladoria_importacoes').select('*').gte('periodo', drePeriodoIni).lte('periodo', drePeriodoFim);
                    if(error) throw error;
                    const processedRaw = (rawData || []).map(row => ({ periodo: row.periodo, usina: row.usina, detalhes: row.detalhes }));
                    setControladoriaRaw(processedRaw);
                } catch(e) { addLog("Erro DRE: " + e.message, 'error'); } finally { setLoading(false); }
            };

            const fetchControladoriaFiliais = async () => { try { const { data } = await supabaseClient.from('controladoria_importacoes').select('usina'); const unique = [...new Set((data||[]).map(d => d.usina))].sort(); setControladoriaFiliais(unique); } catch(e) {} };
            const fetchControladoriaContasAmigaveis = async () => { try { const { data } = await supabaseClient.from('controladoria_de_para').select('friendly_name').eq('tipo', 'Despesa').order('friendly_name'); setControladoriaContas(data.map(d => d.friendly_name)); } catch(e) {} };

            const processDieselFile = (file, periodDate) => {
                const XLSX = window.XLSX;
                if (!XLSX) { addLog("XLSX lib not loaded", "error"); return; }
                setLoading(true); const reader = new FileReader();
                reader.onload = async (e) => { try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); 
                    const batch = jsonData.map(row => {
                        const getVal = (colName) => { const key = Object.keys(row).find(k => k.toLowerCase().trim() === colName.toLowerCase().trim()); return key ? row[key] : 0; };
                        const getStr = (colName) => { const key = Object.keys(row).find(k => k.toLowerCase().trim() === colName.toLowerCase().trim()); return key ? String(row[key]) : ''; }
                        return { periodo: periodDate, usina: getStr('Centro') || 'ND', vol_inicial: Utils.formatters.parseBrl(getVal('Estoque inicial')), entradas: Utils.formatters.parseBrl(getVal('Totais qtds.entrada')), saidas: Utils.formatters.parseBrl(getVal('Totais qtds.saída')), vol_final: Utils.formatters.parseBrl(getVal('SAP')), ajuste_vol: Utils.formatters.parseBrl(getVal('Ajuste de Volume')), ajuste_vlr: Utils.formatters.parseBrl(getVal('Valor Total de Ajuste')), custo_medio: Utils.formatters.parseBrl(getVal('Valor Médio')), vlr_final: Utils.formatters.parseBrl(getVal('Valor Total Estoque Final')), vlr_inicial: 0, vlr_entrada: 0, vlr_saida: 0, motivo_ajuste: getStr('Motivo') };
                    }).filter(i => i.usina !== 'ND' && i.usina !== 'Total' && i.usina !== '' && i.usina !== 'Centro');
                    if (batch.length === 0) throw new Error("Sem registros.");
                    await supabaseClient.from('diesel_estoque').delete().eq('periodo', periodDate);
                    await supabaseClient.from('diesel_estoque').insert(batch);
                    addLog(`Importado!`, "success"); setFilters(prev => ({...prev, dieselPeriodo: periodDate})); fetchDieselData();
                } catch (err) { addLog("Erro: " + err.message, "error"); } finally { setLoading(false); } };
                reader.readAsArrayBuffer(file);
            };

            const processControladoriaFile = (file, periodDate) => {
                const XLSX = window.XLSX;
                if (!XLSX) { addLog("XLSX lib not loaded", "error"); return; }
                setLoading(true); const reader = new FileReader();
                reader.onload = async (e) => { try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1}); 
                    if (rawData.length < 4) throw new Error("Arquivo inválido.");
                    const headers = rawData[0]; const batch = [];
                    for (let i = 3; i < rawData.length; i++) {
                        const row = rawData[i]; const rawUsina = row[0];
                        if (rawUsina && typeof rawUsina === 'string') {
                            const usinaCode = rawUsina.substring(0, 4).toUpperCase(); let custoTotal = 0; let volTotal = 0; const detalhes = {};
                            headers.forEach((h, colIdx) => {
                                if(!h || colIdx === 0) return; const val = parseFloat(row[colIdx]) || 0; const hStr = h.toString().trim(); detalhes[hStr] = val; 
                                if (hStr.toLowerCase().includes('tot. custos')) custoTotal = val; else if (hStr.toLowerCase().includes('qtd.transp') || hStr.toLowerCase().includes('qtd.bomb')) volTotal += val;
                            });
                            batch.push({ periodo: periodDate, usina: usinaCode, custo_total: custoTotal, volume_total: volTotal, detalhes: detalhes });
                        }
                    }
                    await supabaseClient.rpc('limpar_periodo_controladoria', { p_periodo: periodDate });
                    for (let i = 0; i < batch.length; i += 100) await supabaseClient.from('controladoria_importacoes').insert(batch.slice(i, i + 100));
                    addLog(`Sucesso!`, "success"); setFilters(prev => ({...prev, ctrlPeriodo: periodDate}));
                } catch (err) { addLog("Erro: " + err.message, "error"); } finally { setLoading(false); } };
                reader.readAsArrayBuffer(file);
            };

            const handleUploadTerceirizacao = (file, type) => {
                const XLSX = window.XLSX;
                if (!XLSX) { addLog("XLSX lib not loaded", "error"); return; }
                setLoading(true);
                const r = new FileReader();
                r.onload = (e) => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:""});
                    setConfirmData({type, count: json.length, data: json});
                    setLoading(false);
                };
                r.readAsArrayBuffer(file);
            };

            const confirmImportTerceirizacao = async () => {
    if (!confirmData) return;
    const { type, data } = confirmData;
    setConfirmData(null);
    setLoading(true);

    // 1. Define quais colunas tornam o registro único (para ignorar repetidos)
    let conflictColumns = '';
    if (type === 'apuracao') {
        // Tem que bater com a Constraint criada no SQL
        conflictColumns = 'filial_prod, dt_viagem, n_viagem, placa, tipo_lancamento, valor_base';
    } else if (type === 'pagamentos') {
        // Assumindo que o Nº Documento + Fornecedor é único
        conflictColumns = 'n_documento, fornecedor, data_documento'; 
    } else if (type === 'concessao') {
        // Assumindo Equipamento + Data Inicial
        conflictColumns = 'equipamento, fornecedor, data_inicial';
    }

    const mapRow = (row) => {
        // Função auxiliar para normalizar e buscar a chave ignorando maiúsculas/acentos
        const get = (k) => {
            const key = Object.keys(row).find(x => Utils.normalizeKey(x) === Utils.normalizeKey(k));
            return key ? row[key] : "";
        };

        // --- BLOCO NOVO PARA APURAÇÃO ---
        if (type === 'apuracao') {
            return {
                // Coluna Banco : Coluna Excel
                filial_prod: get('Filial Prod.'),
                n_viagem: get('N° Viagem'),
                terceiro: get('Terceiro'),
                nome_terceiro: get('Nome Terceiro'),
                placa: get('Placa'),
                cidade: get('Cidade'),
                regiao: get('Região'),
                valor_base: Utils.formatters.parseBrl(get('Valor Base')),
                material: get('Material'),
                volume: Utils.formatters.parseBrl(get('Volume')),
                total: Utils.formatters.parseBrl(get('Total')),
                classe: get('Classe'),
                dt_viagem: Utils.formatters.parseDate(get('Dt. Viagem')),
                tipo_lancamento: get('Tipo Lancamento'),
                manual: get('Manual')
            };
        }

        if(type === 'pagamentos') return { 
            n_documento: get('Nº documento'), 
            referencia: get('Referência'),
            tipo_documento: get('Tipo de documento'),
            data_documento: Utils.formatters.parseDate(get('Data do documento')),
            vencimento_liquido: Utils.formatters.parseDate(get('Vencimento líquido')),
            data_compensacao: Utils.formatters.parseDate(get('Data de compensação')),
            montante: Utils.formatters.parseBrl(get('Montante em moeda interna')),
            doc_compensacao: get('Doc.compensação'),
            nome_1: get('Nome 1'),
            fornecedor: get('Fornecedor'),
            texto: get('Texto'),
            data_lancamento: Utils.formatters.parseDate(get('Data de lançamento')),
            loc_negocios: get('Loc.negócios'),
            data_pagamento: Utils.formatters.parseDate(get('Data de pagamento')),
            usuario: get('Nome do usuário') || get('Nome do Usuário')
        };

        if(type === 'concessao') return {
            equipamento: get('Equipamento'),
            material: get('Material'),
            data_inicial: Utils.formatters.parseDate(get('Data Inicial')),
            data_final: Utils.formatters.parseDate(get('Data Final')),
            fornecedor: get('Fornecedor'),
            centro: get('Centro'),
            valor_base: Utils.formatters.parseBrl(get('Valor Base'))
        };

        return null;
    };

    try {
        const batch = data.map(mapRow).filter(Boolean);
        let novosCount = 0;

        // Processa em lotes de 100
        for (let i = 0; i < batch.length; i += 100) {
            const chunk = batch.slice(i, i + 100);

            // UPSERT COM IGNORE DUPLICATES
            // Tenta inserir. Se a chave bater com existente, ignora e segue.
            const { data: inserted, error } = await supabaseClient
                .from(type)
                .upsert(chunk, { 
                    onConflict: conflictColumns, 
                    ignoreDuplicates: true,
                    select: true // Retorna os que foram inseridos de fato (opcional)
                });

            if (error) {
                // Se o erro for de coluna unique não encontrada, avisa
                if (error.code === '42P10') {
                    throw new Error("Erro de configuração: Faltou criar a regra UNIQUE no banco de dados.");
                }
                throw error;
            }
        }

        addLog(`Processo finalizado! O arquivo foi processado e apenas novos registros foram salvos.`, "success");
    } catch (e) {
        addLog("Erro na importação: " + e.message, 'error');
    } finally {
        setLoading(false);
    }
};

            const handleImport = async (file, type, period) => {
                if(type === 'controladoria') processControladoriaFile(file, period);
                else if(type === 'diesel') processDieselFile(file, period);
                else handleUploadTerceirizacao(file, type);
            };

            const batchExport = async (tableName, fileName) => {
                addLog("Exportação iniciada...", "info");
            };

            if (!supabaseClient) {
                return (
                    <div className="flex h-screen items-center justify-center bg-slate-50 dark:bg-slate-900">
                        <div className="text-center">
                            <div className="loader h-8 w-8 border-4 border-blue-500 rounded-full border-t-transparent mx-auto mb-4"></div>
                            <p className="text-sm text-slate-500 dark:text-slate-400">Inicializando sistema...</p>
                        </div>
                    </div>
                );
            }

            if (!session) return <LoginScreen onLogin={(e,p) => supabaseClient.auth.signInWithPassword({email:e, password:p})} loading={loading} />;

            return (
                <div className="min-h-screen flex bg-slate-100 dark:bg-slate-900 font-sans text-slate-800 dark:text-slate-200 overflow-hidden transition-colors duration-300">
                    <StatusLog logs={logs} clearLogs={() => setLogs([])} />
                    {confirmData && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
                            <div className="glass-card p-6 w-96 animate-enter bg-white dark:bg-slate-800">
                                <h3 className="font-bold mb-2 text-lg text-slate-800 dark:text-white">Confirmar Upload</h3>
                                <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">Deseja importar <strong>{confirmData.count}</strong> registros para <strong>{confirmData.type}</strong>?</p>
                                <div className="flex gap-2">
                                    <button onClick={()=>setConfirmData(null)} className="flex-1 border border-slate-300 dark:border-slate-600 p-2 rounded hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">Cancelar</button>
                                    <button onClick={confirmImportTerceirizacao} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded text-sm font-medium">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <Sidebar 
                        isSidebarOpen={isSidebarOpen} toggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)}
                        toggleModule={(m) => setExpandedModules(p => ({...p, [m]: !p[m]}))}
                        expandedModules={expandedModules} userRole={userRole}
                        setView={handleSetView} view={view} handleLogout={() => supabaseClient.auth.signOut()} session={session}
                    />
                    <div className={`flex-1 content-transition ${isSidebarOpen ? 'ml-64' : 'ml-20'} overflow-y-auto h-screen`}>
                        <header className="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md h-16 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-8 sticky top-0 z-20 transition-colors duration-300">
                            <h1 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                                {view === 'controladoria' ? <><Icons.BarChart2 className="w-4 h-4 text-slate-400" /> Controladoria / <span className="text-purple-600 dark:text-purple-400 capitalize">{subView === 'centro_custo' ? 'Detalhe C. Custo' : (subView === 'dre' ? 'DRE Gerencial' : subView)}</span></> : 
                                 view === 'diesel' ? <><Icons.Fuel className="w-4 h-4 text-slate-400" /> Diesel / <span className="text-orange-600 dark:text-orange-400 capitalize">{subView}</span></> : 
                                 <><Icons.Briefcase className="w-4 h-4 text-slate-400" /> Terceirização / <span className="text-blue-600 dark:text-blue-400 capitalize">{view}</span></>}
                            </h1>
                            <div className="flex items-center gap-4">
                                {loading && <div className="flex items-center gap-2 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-full"><div className="loader h-3 w-3 border-2 rounded-full"></div> Atualizando...</div>}
                                <button onClick={() => setIsDark(!isDark)} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors">
                                    {isDark ? <Icons.Sun /> : <Icons.Moon />}
                                </button>
                            </div>
                        </header>
                        <main className="p-8 max-w-[1600px] mx-auto pb-20">
                            <ErrorBoundary>
                                {view === 'dashboard' && (
    <div className="space-y-8">
        {/* Barra de Filtros Range de Datas */}
        <div className="glass-card p-4 flex gap-4 flex-wrap items-center relative z-30 no-print">
            <div className="flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-400">
                <Icons.Filter /> Período:
            </div>

            {/* Data Inicial */}
            <input 
                type="date"
                className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded px-3 py-1.5 text-sm text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
                value={filters.dateIni}
                onChange={e => {
                    const newVal = e.target.value;
                    setFilters(prev => ({...prev, dateIni: newVal}));
                    // Atualização imediata
                    if (supabaseClient && newVal && filters.dateFim) {
                         setLoading(true);
                         supabaseClient.rpc('get_dashboard_stats', { p_data_ini: newVal, p_data_fim: filters.dateFim, selected_branch: filters.filial })
                            .then(({ data }) => { setDashboardData(data); setLoading(false); });
                    }
                }}
            />

            <span className="text-slate-400 text-xs">até</span>

            {/* Data Final */}
            <input 
                type="date"
                className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded px-3 py-1.5 text-sm text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
                value={filters.dateFim}
                onChange={e => {
                    const newVal = e.target.value;
                    setFilters(prev => ({...prev, dateFim: newVal}));
                    if (supabaseClient && filters.dateIni && newVal) {
                         setLoading(true);
                         supabaseClient.rpc('get_dashboard_stats', { p_data_ini: filters.dateIni, p_data_fim: newVal, selected_branch: filters.filial })
                            .then(({ data }) => { setDashboardData(data); setLoading(false); });
                    }
                }}
            />

            {/* Divisor */}
            <div className="h-6 w-px bg-slate-300 dark:bg-slate-700 mx-2"></div>

            {/* Filtro de Filial */}
            <select 
                className="bg-transparent text-sm font-medium focus:outline-none dark:text-slate-200 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded px-2 py-1.5 min-w-[150px]" 
                value={filters.filial} 
                onChange={e => {
                    const newVal = e.target.value;
                    setFilters(prev => ({...prev, filial: newVal}));
                    if (supabaseClient) {
                         setLoading(true);
                         supabaseClient.rpc('get_dashboard_stats', { p_data_ini: filters.dateIni, p_data_fim: filters.dateFim, selected_branch: newVal })
                            .then(({ data }) => { setDashboardData(data); setLoading(false); });
                    }
                }}
            >
                <option value="Todas">🏭 Todas as Filiais</option>
               {(dashboardData.lista_filiais || dashboardData.chart_usina || []).map(f => (<option key={f.name} value={f.name}>{f.name}</option>))}
            </select>
        </div>

        <TerceirizacaoDashboard 
            data={dashboardData} 
            loading={loading} 
            isDark={isDark} 
            filters={filters} // Passa os filtros para exibir alertas corretos
            supabaseClient={supabaseClient}
        />
    </div>
)}
                                {view === 'reports' && (
                                    <div className="space-y-6">
                                        <div className="glass-card p-4 mb-6 flex gap-4 items-end relative z-30">
                                            <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 self-center mr-2"><Icons.Filter /> Filtros:</div>
                                            <MultiSelectDropdown label="Períodos (Meses)" options={uniqueReportPeriods} selected={selectedReportPeriods} onChange={setSelectedReportPeriods} />
                                        </div>
                                        <DataTable data={filteredReportData} onNotify={addLog} onExportAll={() => batchExport('resumo_mensal', 'Relatorio_Geral_Completo')} />
                                    </div>
                                )}
                                {view === 'terceirizacao_cadastros' && (
                                    <div className="space-y-6 animate-enter pb-10">
                                        <TerceirizacaoCadastros 
                                            supabaseClient={supabaseClient} 
                                            onNotify={addLog} 
                                        />
                                    </div>
                                )}
                                {view === 'terceirizacao_pagamentos' && (
                                        <div className="space-y-8">
                                            <div className="glass-card p-4 flex gap-4 items-center no-print">
                                                <div className="flex items-center gap-2 text-sm text-slate-600"><Icons.Filter /> Período:</div>
                                                <input type="date" className="border p-1 rounded" value={filters.dateIni} onChange={e => setFilters({...filters, dateIni: e.target.value})} />
                                                <span>até</span>
                                                <input type="date" className="border p-1 rounded" value={filters.dateFim} onChange={e => setFilters({...filters, dateFim: e.target.value})} />
                                            </div>
                                            <TerceirizacaoPagamentos 
                                                supabaseClient={supabaseClient} 
                                                filters={filters} 
                                                onNotify={addLog} 
                                            />
                                        </div>
                                    )}
                                    
                                    {view === 'terceirizacao_turnover' && (
    <div className="space-y-6 animate-enter pb-10">
        {/* Barra de Filtros Padronizada */}
        <div className="glass-card p-4 flex gap-4 items-center no-print">
            <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                <Icons.Filter /> Período:
            </div>
            
            <input 
                type="date" 
                className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded px-3 py-1.5 text-sm text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-cyan-500 outline-none"
                value={filters.dateIni} 
                onChange={e => setFilters({...filters, dateIni: e.target.value})} 
            />
            
            <span className="text-slate-400 text-xs">até</span>
            
            <input 
                type="date" 
                className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded px-3 py-1.5 text-sm text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-cyan-500 outline-none"
                value={filters.dateFim} 
                onChange={e => setFilters({...filters, dateFim: e.target.value})} 
            />

            {/* Divisor */}
            <div className="h-6 w-px bg-slate-300 dark:bg-slate-700 mx-2"></div>

            {/* Filtro de Filial (Opcional, mas útil) */}
            <select 
                className="bg-transparent text-sm font-medium focus:outline-none dark:text-slate-200 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded px-2 py-1.5 min-w-[150px]" 
                value={filters.filial} 
                onChange={e => setFilters(prev => ({...prev, filial: e.target.value}))}
            >
                <option value="Todas">🏭 Todas as Filiais</option>
                {/* Reutiliza a lista de filiais do dashboard se disponível, senão apenas 'Todas' */}
                {(dashboardData.lista_filiais || []).map(f => (<option key={f.name} value={f.name}>{f.name}</option>))}
            </select>
        </div>

        {/* Componente Turnover */}
        <TerceirizacaoTurnover 
            supabaseClient={supabaseClient} 
            filters={filters} 
            onNotify={addLog} 
        />
    </div>
)}
                       {view === 'terceirizacao_ativos' && (
    <div className="space-y-6 animate-enter pb-10">
        {/* Barra de Filtros (Simples: Apenas Filial) */}
        <div className="glass-card p-4 flex gap-4 items-center no-print">
            <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                <Icons.Filter /> Filtros:
            </div>
            
            <select 
                className="bg-transparent text-sm font-medium focus:outline-none dark:text-slate-200 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded px-2 py-1.5 min-w-[200px]" 
                value={filters.filial} 
                onChange={e => setFilters(prev => ({...prev, filial: e.target.value}))}
            >
                <option value="Todas">🏭 Todas as Filiais</option>
                {/* Reutiliza a lista de filiais existente */}
                {(dashboardData.lista_filiais || []).map(f => (<option key={f.name} value={f.name}>{f.name}</option>))}
            </select>
        </div>

        <TerceirizacaoRelatorioAtivos 
            supabaseClient={supabaseClient} 
            filters={filters} 
            onNotify={addLog} 
        />
    </div>
)}         
                                {view === 'controladoria' && (subView === 'dash' || subView === 'report') && (
                                    <>
                                        <div className="glass-card p-4 mb-6 flex gap-4 flex-wrap items-center relative z-30">
                                            <div className="flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-400"><Icons.Filter /> Filtros:</div>
                                            {subView === 'dash' && (<><MonthPicker label="Período Atual" value={filters.ctrlPeriodo} onChange={e=>setFilters({...filters, ctrlPeriodo:e})} /><MonthPicker label="Comparar Com" value={filters.ctrlPeriodoComp} onChange={e=>setFilters({...filters, ctrlPeriodoComp:e})} /></>)}
                                            {subView === 'report' && (<MonthPicker label="Selecionar Períodos" value={selectedReportPeriods} onChange={setSelectedReportPeriods} isMulti={true} />)}
                                            <div className="flex flex-col"><span className="input-label mb-1">Usina</span><select className="border border-slate-200 dark:border-slate-700 rounded-lg px-2 py-2 text-sm bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 w-32 outline-none focus:ring-2 focus:ring-blue-500/20" value={filters.ctrlUsina} onChange={e => setFilters({...filters, ctrlUsina: e.target.value})}><option value="Todas">Todas</option>{controladoriaFiliais.map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                                        </div>
                                        {subView === 'dash' && <ControladoriaDashboardAnalitico stats={controladoriaAnalise} loading={loading} tipo={filters.ctrlTipo} setTipo={t=>setFilters({...filters, ctrlTipo:t})} onDrillDown={c => { setDrillDownConta(c); handleSetView('controladoria', 'centro_custo'); }} periodo={filters.ctrlPeriodo} periodoComp={filters.ctrlPeriodoComp} isDark={isDark} />}
                                        {subView === 'report' && <DataTable data={filteredReportData} onNotify={addLog} title="Dados Detalhados Controladoria" onExportAll={() => batchExport('controladoria_importacoes', `Relatorio_Controladoria_${filters.ctrlPeriodo}`)} />}
                                    </>
                                )}
                                {view === 'controladoria' && subView === 'centro_custo' && <ControladoriaDashboardCentroCusto supabaseClient={supabaseClient} periodo={filters.ctrlPeriodo} contas={controladoriaContas} onNotify={addLog} initialConta={drillDownConta} onBack={()=>setSubView('dash')} isDark={isDark} />}
                                {view === 'controladoria' && subView === 'depara' && <ControladoriaDePara supabaseClient={supabaseClient} onNotify={addLog} />}
                                {view === 'controladoria' && subView === 'import' && <ControladoriaImport onImport={(f,d) => handleImport(f,'controladoria',d)} loading={loading} />}
                                {view === 'controladoria' && subView === 'dre' && (
                                    <div className="space-y-6 animate-enter">
                                        <div className="glass-card p-4 flex gap-4 items-end flex-wrap relative z-30">
                                            <div className="flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-400 self-center mr-2"><Icons.Filter /> Filtros DRE:</div>
                                            <MonthPicker label="De" value={drePeriodoIni} onChange={setDrePeriodoIni} />
                                            <MonthPicker label="Até" value={drePeriodoFim} onChange={setDrePeriodoFim} />
                                            <MultiSelectDropdown label="Usinas (Consolidação)" options={controladoriaFiliais} selected={dreUsinas} onChange={setDreUsinas} />
                                            <button onClick={fetchDREData} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-500/30 transition-all self-end ml-auto"><Icons.RefreshCw className="w-4 h-4 inline mr-2" /> Atualizar DRE</button>
                                        </div>
                                        <ControladoriaDRE rawData={controladoriaRaw} mappings={mappings} periodoIni={drePeriodoIni} periodoFim={drePeriodoFim} usinasSelecionadas={dreUsinas} isDark={isDark} />
                                    </div>
                                )}
                                {view === 'diesel' && subView === 'dash' && (
                                    <>
                                        <div className="glass-card p-4 mb-6 flex gap-4 relative z-30 no-print"><div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400"><Icons.Filter /> Filtros:</div><MonthPicker label="Mês" value={filters.dieselPeriodo} onChange={e=>setFilters({...filters, dieselPeriodo:e})} /></div>
                                        <DieselDashboard data={dieselData} loading={loading} periodo={filters.dieselPeriodo} isDark={isDark} />
                                    </>
                                )}
                                {view === 'diesel' && subView === 'report' && <DataTable data={dieselData} onNotify={addLog} title="Relatório Diesel" />}
                                {view === 'diesel' && subView === 'import' && <DieselImport onImport={(f,d)=>handleImport(f,'diesel',d)} loading={loading} />}
                                {view === 'upload' && (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <UploadCard type="apuracao" iconName="fileText" onAnalyze={(f)=>handleImport(f,'apuracao')} isAnalyzing={loading} progress={0} />
                                        <UploadCard type="pagamentos" iconName="dollar" onAnalyze={(f)=>handleImport(f,'pagamentos')} isAnalyzing={loading} progress={0} />
                                        <UploadCard type="concessao" iconName="truck" onAnalyze={(f)=>handleImport(f,'concessao')} isAnalyzing={loading} progress={0} />
                                    </div>
                                )}
                                {view === 'terceirizacao_depara' && (
                    <TerceirizacaoDePara supabaseClient={supabaseClient} onNotify={addLog} />
                )}
                            </ErrorBoundary>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>

































































