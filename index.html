<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tersys - SAP Analytics</title>
    
    <!-- Assets & Libraries -->
    <link rel="icon" type="image/png" href="https://jsmnykikflkjceiqfmne.supabase.co/storage/v1/object/public/LOGOS/Logo_sm_texto-removebg-preview.png">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a' }
                    },
                    boxShadow: { 'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)' }
                }
            }
        }
    </script>

    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border-top-color: #3b82f6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .glass-card { background: rgba(255, 255, 255, 0.95); border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 0.75rem; backdrop-filter: blur(8px); }
        .dark .glass-card { background: rgba(30, 41, 59, 0.95); border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .interactive-row:hover { background-color: #f1f5f9; cursor: pointer; transition: background-color 0.2s; }
        .dark .interactive-row:hover { background-color: #334155; }
        .input-label { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.05em; }
        .dark .input-label { color: #94a3b8; }
        .animate-enter { animation: fadeInScale 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .content-transition { transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .picker-popover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // 1. SETUP & UTILITIES
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell, ComposedChart, Area, Brush, ReferenceLine } = window.Recharts || {};
        
        const getChartColors = (isDark) => ({
            text: isDark ? '#94a3b8' : '#64748b',
            grid: isDark ? '#334155' : '#e2e8f0',
            tooltipBg: isDark ? '#1e293b' : '#ffffff',
            primary: '#0f172a', secondary: '#3b82f6', accent: '#f59e0b', success: '#10b981',
            bomba: isDark ? '#fdba74' : '#f97316', betoneira: isDark ? '#93c5fd' : '#3b82f6', 
            controladoria: isDark ? '#a78bfa' : '#8b5cf6', controladoria_dark: isDark ? '#8b5cf6' : '#6d28d9', danger: '#ef4444'
        });

        const Utils = {
            normalizeKey: (key) => key ? key.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "") : '',
            cleanStr: (str) => str ? str.toString().trim().toUpperCase() : '',
            normalizeClass: (str) => str ? str.toString().trim().toUpperCase().replace(/\s+/g, ' ') : '',
            checkPermission: (role, required) => {
                if (!role) return false;
                const r = role.toLowerCase();
                if (r === 'admin' || r === 'administrador') return true;
                if (required === 'terceirizacao') return r === 'terceirizacao' || r === 'terceirização';
                if (required === 'controladoria') return r === 'controladoria';
                if (required === 'diesel') return r === 'diesel' || r === 'admin';
                return false;
            },
            formatters: {
                currency: (val) => (typeof val === 'string' ? parseFloat(val) : val || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}),
                number: (val, decimals = 2) => (typeof val === 'string' ? parseFloat(val) : val || 0).toLocaleString('pt-BR', {minimumFractionDigits: decimals, maximumFractionDigits: decimals}),
                parseDate: (val) => {
                    if(!val) return null; if(val instanceof Date) return val.toISOString().split('T')[0];
                    const str = String(val).trim();
                    if(str.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)){ const p=str.split('/'); return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; }
                    if(!isNaN(str) && parseFloat(str) > 30000){ const d = new Date((parseFloat(str)-25569)*86400*1000); return d.toISOString().split('T')[0]; }
                    if(str.match(/^\d{4}-\d{2}-\d{2}$/)) return str;
                    return null;
                },
                parseBrl: (val) => { if (!val) return 0; if(typeof val === 'number') return val; let str = String(val).replace('R$', '').trim(); if(str.includes(',') && !str.includes('e')) str = str.replace(/\./g, '').replace(',', '.'); return parseFloat(str) || 0; }
            },
            math: { roundVolume: (val) => Math.round(((typeof val === 'string' ? parseFloat(val) : val) || 0) * 2) / 2 },
            date: {
                formatNice: (dateStr) => {
                    if(!dateStr) return '';
                    const [y, m] = dateStr.split('-').map(Number);
                    const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                    return `${months[m-1]} ${y}`;
                },
                getMonths: () => ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez']
            }
        };

        const Icons = {
            Database: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 2.68-9 2.68S3 13.66 3 12"/><path d="M3 5v14c0 1.66 4 2.68 9 2.68s9-1.02 9-2.68V5"/></svg>,
            LayoutDashboard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>,
            Table: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/></svg>,
            Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Filter: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            ListFilter: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M3 6h18"/><path d="M7 12h10"/><path d="M10 18h4"/></svg>,
            LogOut: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            DollarSign: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Truck: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>,
            Droplet: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M12 2.69l5.74 5.74c.84.84 1.5 2.12 1.5 3.57v4.5c0 1.66-1.34 3-3 3H7.76c-1.66 0-3-1.34-3-3v-4.5c0-1.45.66-2.73 1.5-3.57L12 2.69z"/></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            RefreshCw: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            ChevronLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="9 18 15 12 9 6"/></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Ban: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>,
            Briefcase: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            User: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            BarChart2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
            FileText2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Edit: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Target: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            ArrowLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
            Menu: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
            ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="6 9 12 15 18 9"/></svg>,
            ChevronRightSmall: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><polyline points="9 18 15 12 9 6"/></svg>,
            Fuel: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="3" y1="22" x2="15" y2="22"/><line x1="5" y1="17" x2="5" y2="11"/><circle cx="14" cy="10" r="7"/><path d="M8 12a7 7 0 0 1 14 0"/></svg>,
            AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Moon: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Sun: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            ArrowUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>,
            ArrowDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>,
            Calendar: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"></polyline></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        };

        // --- MultiSelect Dropdown com Busca ---
        const MultiSelectDropdown = ({ label, options, selected, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const filteredOptions = options.filter(opt => 
                opt.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const toggleOption = (option) => {
                let newSelected;
                if (option === 'Todas') {
                    newSelected = ['Todas'];
                } else {
                    if (selected.includes('Todas')) {
                        newSelected = [option];
                    } else {
                        if (selected.includes(option)) {
                            newSelected = selected.filter(s => s !== option);
                            if (newSelected.length === 0) newSelected = ['Todas'];
                        } else {
                            newSelected = [...selected, option];
                        }
                    }
                }
                onChange(newSelected);
            };

            const getDisplayText = () => {
                if (selected.includes('Todas')) return 'Todas';
                if (selected.length === 0) return 'Selecione...';
                if (selected.length === 1) return selected[0];
                return `${selected.length} selecionadas`;
            };

            return (
                <div className="flex flex-col relative" ref={dropdownRef}>
                    {label && <span className="input-label mb-1">{label}</span>}
                    <div className="relative">
                        <button 
                            onClick={() => setIsOpen(!isOpen)}
                            className={`flex items-center justify-between w-full pl-3 pr-3 py-2 text-sm bg-white dark:bg-slate-800 border ${isOpen ? 'border-blue-500 ring-2 ring-blue-500/20' : 'border-slate-200 dark:border-slate-700'} rounded-lg transition-all text-slate-700 dark:text-slate-200 hover:border-slate-300 dark:hover:border-slate-600 shadow-sm min-w-[180px]`}
                        >
                            <span className="flex items-center gap-2 truncate max-w-[200px]">
                                <Icons.Filter className="w-4 h-4 text-slate-400" />
                                {getDisplayText()}
                            </span>
                            <Icons.ChevronDown className={`w-4 h-4 ml-2 transition-transform ${isOpen ? 'rotate-180 text-blue-500' : 'text-slate-400'}`} />
                        </button>

                        {isOpen && (
                            <div className="absolute z-50 mt-2 w-64 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl picker-popover overflow-hidden animate-enter top-full left-0 flex flex-col max-h-80">
                                <div className="p-2 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
                                    <div className="relative">
                                        <Icons.Search className="absolute left-2 top-2 w-3 h-3 text-slate-400" />
                                        <input 
                                            type="text" 
                                            placeholder="Buscar..." 
                                            className="w-full pl-7 pr-2 py-1 text-xs border border-slate-200 dark:border-slate-600 rounded bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 focus:outline-none focus:border-blue-500"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            autoFocus
                                        />
                                    </div>
                                </div>
                                <div className="p-2 overflow-y-auto custom-scrollbar flex-1">
                                    <div 
                                        onClick={() => toggleOption('Todas')}
                                        className={`flex items-center gap-2 px-3 py-2 rounded-md cursor-pointer text-sm ${selected.includes('Todas') ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-bold' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'}`}
                                    >
                                        <div className={`w-4 h-4 rounded border flex items-center justify-center ${selected.includes('Todas') ? 'bg-blue-500 border-blue-500 text-white' : 'border-slate-300'}`}>
                                            {selected.includes('Todas') && <Icons.Check width={12} />}
                                        </div>
                                        Todas as Usinas
                                    </div>
                                    <div className="h-px bg-slate-100 dark:bg-slate-700 my-1"></div>
                                    {filteredOptions.length > 0 ? (
                                        filteredOptions.map(opt => (
                                            <div 
                                                key={opt}
                                                onClick={() => toggleOption(opt)}
                                                className={`flex items-center gap-2 px-3 py-2 rounded-md cursor-pointer text-sm ${selected.includes(opt) ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-medium' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'}`}
                                            >
                                                <div className={`w-4 h-4 rounded border flex items-center justify-center ${selected.includes(opt) ? 'bg-blue-500 border-blue-500 text-white' : 'border-slate-300'}`}>
                                                    {selected.includes(opt) && <Icons.Check width={12} />}
                                                </div>
                                                {opt}
                                            </div>
                                        ))
                                    ) : (
                                        <div className="text-xs text-slate-400 text-center py-2">Nenhuma opção encontrada</div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Month Picker ---
        const MonthPicker = ({ label, value, onChange, isMulti = false }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [viewYear, setViewYear] = useState(new Date().getFullYear());
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            useEffect(() => {
                if (value) {
                    const firstVal = Array.isArray(value) ? value[0] : value;
                    if (firstVal && firstVal.length >= 4) {
                        setViewYear(parseInt(firstVal.split('-')[0]));
                    }
                }
            }, []);

            const months = Utils.date.getMonths();

            const handleMonthClick = (monthIndex) => {
                const monthStr = String(monthIndex + 1).padStart(2, '0');
                const selectedPeriod = `${viewYear}-${monthStr}`;

                if (isMulti) {
                    let newValues = Array.isArray(value) ? [...value] : [];
                    if (newValues.includes(selectedPeriod)) {
                        newValues = newValues.filter(v => v !== selectedPeriod);
                    } else {
                        newValues.push(selectedPeriod);
                    }
                    onChange(newValues);
                } else {
                    onChange(selectedPeriod);
                    setIsOpen(false);
                }
            };

            const isSelected = (monthIndex) => {
                const monthStr = String(monthIndex + 1).padStart(2, '0');
                const period = `${viewYear}-${monthStr}`;
                if (Array.isArray(value)) {
                    return value.includes(period);
                }
                return value === period;
            };

            const getDisplayText = () => {
                if (isMulti) {
                    if (!value || value.length === 0) return 'Selecione...';
                    if (value.length === 1) return Utils.date.formatNice(value[0]);
                    return `${value.length} meses`;
                } else {
                    return value ? Utils.date.formatNice(value) : 'Selecione...';
                }
            };

            return (
                <div className="flex flex-col relative" ref={dropdownRef}>
                    {label && <span className="input-label mb-1">{label}</span>}
                    <div className="relative">
                        <button 
                            onClick={() => setIsOpen(!isOpen)}
                            className={`flex items-center justify-between w-full pl-3 pr-3 py-2 text-sm bg-white dark:bg-slate-800 border ${isOpen ? 'border-blue-500 ring-2 ring-blue-500/20' : 'border-slate-200 dark:border-slate-700'} rounded-lg transition-all text-slate-700 dark:text-slate-200 hover:border-slate-300 dark:hover:border-slate-600 shadow-sm min-w-[180px]`}
                        >
                            <span className="flex items-center gap-2 truncate">
                                <Icons.Calendar className="w-4 h-4 text-slate-400" />
                                {getDisplayText()}
                            </span>
                            <Icons.ChevronDown className={`w-4 h-4 ml-2 transition-transform ${isOpen ? 'rotate-180 text-blue-500' : 'text-slate-400'}`} />
                        </button>

                        {isOpen && (
                            <div className="absolute z-50 mt-2 w-64 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl picker-popover overflow-hidden animate-enter p-3 top-full left-0">
                                <div className="flex justify-between items-center mb-3 pb-2 border-b border-slate-100 dark:border-slate-700">
                                    <button onClick={() => setViewYear(viewYear - 1)} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-slate-500 dark:text-slate-400"><Icons.ChevronLeft width={16}/></button>
                                    <span className="font-bold text-slate-700 dark:text-slate-200">{viewYear}</span>
                                    <button onClick={() => setViewYear(viewYear + 1)} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-slate-500 dark:text-slate-400"><Icons.ChevronRight width={16}/></button>
                                </div>
                                <div className="grid grid-cols-3 gap-2">
                                    {months.map((m, i) => {
                                        const active = isSelected(i);
                                        return (
                                            <button 
                                                key={m} 
                                                onClick={() => handleMonthClick(i)}
                                                className={`text-xs py-2 rounded-md font-medium transition-colors ${
                                                    active 
                                                    ? 'bg-blue-600 text-white shadow-md shadow-blue-500/30' 
                                                    : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'
                                                }`}
                                            >
                                                {m}
                                            </button>
                                        )
                                    })}
                                </div>
                                {isMulti && (
                                    <div className="mt-3 pt-2 border-t border-slate-100 dark:border-slate-700 flex justify-between">
                                        <button onClick={() => onChange([])} className="text-xs text-slate-500 hover:text-red-500">Limpar</button>
                                        <button onClick={() => setIsOpen(false)} className="text-xs text-blue-600 font-bold">Pronto</button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- DRE Component ---
        const ControladoriaDRE = ({ rawData, mappings, periodoIni, periodoFim, usinasSelecionadas, isDark }) => {
            const months = useMemo(() => {
                if (!periodoIni || !periodoFim) return [];
                let start = new Date(periodoIni + '-01T00:00:00');
                let end = new Date(periodoFim + '-01T00:00:00');
                start = new Date(start.valueOf() + start.getTimezoneOffset() * 60000);
                end = new Date(end.valueOf() + end.getTimezoneOffset() * 60000);

                const list = [];
                while (start <= end) {
                    const mStr = (start.getMonth() + 1).toString().padStart(2, '0');
                    const yStr = start.getFullYear();
                    const id = `${yStr}-${mStr}`;
                    const label = `${Utils.date.getMonths()[start.getMonth()]} ${yStr.toString().substring(2)}`;
                    list.push({ id, label });
                    start.setMonth(start.getMonth() + 1);
                }
                return list;
            }, [periodoIni, periodoFim]);

            const dreData = useMemo(() => {
                const structure = {
                    receita: { title: 'Receita Bruta', items: {}, total: {}, type: 'credit' },
                    custo_var: { title: '(-) Custos Variáveis', items: {}, total: {}, type: 'debit' },
                    margem: { title: '(=) Margem de Contribuição', isResult: true },
                    custo_fix: { title: '(-) Custos Fixos', items: {}, total: {}, type: 'debit' },
                    despesa: { title: '(-) Despesas', items: {}, total: {}, type: 'debit' },
                    ebitda: { title: '(=) Resultado Operacional', isResult: true }
                };

                months.forEach(m => {
                    structure.receita.total[m.id] = 0;
                    structure.custo_var.total[m.id] = 0;
                    structure.custo_fix.total[m.id] = 0;
                    structure.despesa.total[m.id] = 0;
                });

                const filteredRaw = rawData.filter(r => 
                    usinasSelecionadas.includes('Todas') || usinasSelecionadas.includes(r.usina)
                );

                filteredRaw.forEach(row => {
                    if (row.periodo < periodoIni || row.periodo > periodoFim) return;

                    Object.entries(row.detalhes || {}).forEach(([contaOriginal, valor]) => {
                        const val = parseFloat(valor) || 0;
                        if (val === 0) return;

                        const map = mappings.find(m => m.original_name === contaOriginal);
                        if (!map) return; 

                        let groupKey = null;
                        if (map.tipo === 'Receita') groupKey = 'receita';
                        else if (map.tipo === 'Custo' && map.classificacao === 'Variável') groupKey = 'custo_var';
                        else if (map.tipo === 'Custo' && map.classificacao === 'Fixo') groupKey = 'custo_fix';
                        else if (map.tipo === 'Despesa') groupKey = 'despesa';

                        if (groupKey) {
                            const friendlyName = map.friendly_name;
                            if (!structure[groupKey].items[friendlyName]) {
                                structure[groupKey].items[friendlyName] = {};
                                months.forEach(m => structure[groupKey].items[friendlyName][m.id] = 0);
                            }
                            if (structure[groupKey].items[friendlyName][row.periodo] !== undefined) {
                                structure[groupKey].items[friendlyName][row.periodo] += val;
                            }
                            if (structure[groupKey].total[row.periodo] !== undefined) {
                                structure[groupKey].total[row.periodo] += val;
                            }
                        }
                    });
                });

                return structure;
            }, [rawData, mappings, months, usinasSelecionadas, periodoIni, periodoFim]);

            const getStats = (rowObj) => {
                let sum = 0;
                let count = 0;
                months.forEach(m => {
                    const val = rowObj[m.id] || 0;
                    sum += val;
                    if (val !== 0) count++;
                });
                return { total: sum, avg: count > 0 ? sum / count : 0 };
            };

            const renderRow = (label, values, isHeader = false, indent = false) => {
                const stats = getStats(values);
                return (
                    <tr key={label} className={`border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors ${isHeader ? 'font-bold bg-slate-50 dark:bg-slate-800 text-slate-800 dark:text-white' : 'text-slate-600 dark:text-slate-300'}`}>
                        <td className={`px-4 py-2 whitespace-nowrap ${indent ? 'pl-8' : ''}`}>{label}</td>
                        {months.map(m => (
                            <td key={m.id} className="px-2 py-2 text-right text-xs whitespace-nowrap">
                                {values[m.id] ? Utils.formatters.currency(values[m.id]) : '-'}
                            </td>
                        ))}
                        <td className="px-2 py-2 text-right text-xs font-bold bg-yellow-50/50 dark:bg-yellow-900/10 text-slate-800 dark:text-slate-200">
                            {Utils.formatters.currency(stats.avg)}
                        </td>
                        <td className="px-2 py-2 text-right text-xs font-bold bg-slate-100 dark:bg-slate-800">
                            {Utils.formatters.currency(stats.total)}
                        </td>
                    </tr>
                );
            };

            const renderResultRow = (key, title) => {
                const values = {};
                months.forEach(m => {
                    const rec = dreData.receita.total[m.id] || 0;
                    const cv = dreData.custo_var.total[m.id] || 0;
                    const cf = dreData.custo_fix.total[m.id] || 0;
                    const desp = dreData.despesa.total[m.id] || 0;

                    if (key === 'margem') values[m.id] = rec - cv; 
                    if (key === 'ebitda') values[m.id] = (rec - cv) - cf - desp; 
                });
                
                const stats = getStats(values);
                const colorClass = key === 'ebitda' 
                    ? (stats.total >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400') 
                    : 'text-blue-600 dark:text-blue-400';

                return (
                    <tr key={key} className="border-y-2 border-slate-200 dark:border-slate-600 bg-slate-100 dark:bg-slate-800 font-bold text-sm">
                        <td className="px-4 py-3">{title}</td>
                        {months.map(m => (
                            <td key={m.id} className={`px-2 py-3 text-right whitespace-nowrap ${values[m.id] < 0 ? 'text-red-500' : ''}`}>
                                {Utils.formatters.currency(values[m.id])}
                            </td>
                        ))}
                        <td className={`px-2 py-3 text-right bg-yellow-100/50 dark:bg-yellow-900/20 ${colorClass}`}>
                            {Utils.formatters.currency(stats.avg)}
                        </td>
                        <td className={`px-2 py-3 text-right ${colorClass}`}>
                            {Utils.formatters.currency(stats.total)}
                        </td>
                    </tr>
                );
            };

            return (
                <div className="glass-card overflow-hidden">
                    <div className="overflow-x-auto custom-scrollbar">
                        <table className="w-full text-sm text-left">
                            <thead className="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-10">
                                <tr>
                                    <th className="px-4 py-3 min-w-[200px]">DRE / Conta</th>
                                    {months.map(m => <th key={m.id} className="px-2 py-3 text-right min-w-[100px]">{m.label}</th>)}
                                    <th className="px-2 py-3 text-right min-w-[100px] bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-500">Média</th>
                                    <th className="px-2 py-3 text-right min-w-[120px] bg-slate-100 dark:bg-slate-700">Total Período</th>
                                </tr>
                            </thead>
                            <tbody>
                                {renderRow(dreData.receita.title, dreData.receita.total, true)}
                                {Object.entries(dreData.receita.items).sort().map(([k, v]) => renderRow(k, v, false, true))}
                                
                                {renderRow(dreData.custo_var.title, dreData.custo_var.total, true)}
                                {Object.entries(dreData.custo_var.items).sort().map(([k, v]) => renderRow(k, v, false, true))}

                                {renderResultRow('margem', dreData.margem.title)}

                                {renderRow(dreData.custo_fix.title, dreData.custo_fix.total, true)}
                                {Object.entries(dreData.custo_fix.items).sort().map(([k, v]) => renderRow(k, v, false, true))}

                                {renderRow(dreData.despesa.title, dreData.despesa.total, true)}
                                {Object.entries(dreData.despesa.items).sort().map(([k, v]) => renderRow(k, v, false, true))}

                                {renderResultRow('ebitda', dreData.ebitda.title)}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- Core Components ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null, errorInfo: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Erro capturado:", error, errorInfo); this.setState({ errorInfo }); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-slate-100 dark:bg-slate-900 p-4">
                            <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-2xl max-w-3xl w-full border-l-8 border-red-500">
                                <h1 className="text-2xl font-bold text-red-600 dark:text-red-400 mb-4">Ocorreu um erro na aplicação</h1>
                                <div className="bg-red-50 dark:bg-red-900/20 p-4 rounded border border-red-100 dark:border-red-800 mb-6 overflow-auto max-h-60">
                                    <p className="font-mono text-sm text-red-800 dark:text-red-300 font-bold mb-2">{this.state.error && this.state.error.toString()}</p>
                                    <pre className="text-xs text-red-600 dark:text-red-400 whitespace-pre-wrap">{this.state.errorInfo && this.state.errorInfo.componentStack}</pre>
                                </div>
                                <div className="flex gap-4">
                                    <button onClick={() => window.location.reload()} className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">Recarregar Página</button>
                                    <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="px-6 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded hover:bg-slate-300 dark:hover:bg-slate-600 font-bold">Limpar Cache</button>
                                </div>
                            </div>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        const CustomTooltip = ({ active, payload, label, isDark }) => {
            if (active && payload && payload.length) {
                const bgClass = isDark ? 'bg-slate-800 border-slate-700 text-slate-200' : 'bg-white border-slate-200 text-slate-800';
                return (
                    <div className={`p-3 border shadow-xl rounded-lg text-sm z-50 ${bgClass}`}>
                        <p className="font-bold mb-2 border-b border-slate-600/20 pb-1">{label}</p>
                        {payload.map((entry, index) => (
                            <div key={index} className="flex items-center justify-between gap-4 mb-1 last:mb-0">
                                <div className="flex items-center gap-2" style={{ color: entry.color }}>
                                    <span className="w-2 h-2 rounded-full" style={{ backgroundColor: entry.color }}></span>
                                    <span className="font-medium truncate max-w-[200px]">{entry.name}:</span>
                                </div>
                                <div className="flex gap-2 text-right">
                                    <span className="font-bold">{typeof entry.value === 'number' ? entry.value.toLocaleString('pt-BR', {maximumFractionDigits: 2}) : entry.value}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                );
            }
            return null;
        };

        const StatusLog = ({ logs, clearLogs }) => {
            if (logs.length === 0) return null;
            return (
                <div className="fixed bottom-4 right-4 z-50 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-4 rounded-lg shadow-xl w-80 max-h-60 overflow-y-auto animate-enter">
                    <div className="flex justify-between mb-2 border-b dark:border-slate-700 pb-1">
                        <span className="font-bold text-xs text-slate-700 dark:text-slate-300">Notificações</span>
                        <button onClick={clearLogs} className="text-xs text-blue-500 hover:underline">Limpar</button>
                    </div>
                    {logs.map((l, i) => (
                        <div key={i} className={`text-xs p-2 mb-1 rounded border-l-2 ${l.type === 'error' ? 'bg-red-50 dark:bg-red-900/30 border-red-500 text-red-700 dark:text-red-300' : 'bg-blue-50 dark:bg-blue-900/30 border-blue-500 text-slate-700 dark:text-slate-300'}`}>{l.msg}</div>
                    ))}
                </div>
            );
        };

        const Card = ({ title, value, subtext, iconName, color = "blue" }) => {
            const Icon = Icons[iconName.charAt(0).toUpperCase() + iconName.slice(1)] || Icons.Database;
            const styles = {
                blue: { bg: "bg-gradient-to-br from-white to-blue-50/50 dark:from-slate-800 dark:to-blue-900/20", icon: "bg-blue-100 text-blue-600 dark:bg-blue-900/50 dark:text-blue-400", border: "border-blue-100 dark:border-blue-900/30" },
                emerald: { bg: "bg-gradient-to-br from-white to-emerald-50/50 dark:from-slate-800 dark:to-emerald-900/20", icon: "bg-emerald-100 text-emerald-600 dark:bg-emerald-900/50 dark:text-emerald-400", border: "border-emerald-100 dark:border-emerald-900/30" },
                sky: { bg: "bg-gradient-to-br from-white to-sky-50/50 dark:from-slate-800 dark:to-sky-900/20", icon: "bg-sky-100 text-sky-600 dark:bg-sky-900/50 dark:text-sky-400", border: "border-sky-100 dark:border-sky-900/30" },
                orange: { bg: "bg-gradient-to-br from-white to-orange-50/50 dark:from-slate-800 dark:to-orange-900/20", icon: "bg-orange-100 text-orange-600 dark:bg-orange-900/50 dark:text-orange-400", border: "border-orange-100 dark:border-orange-900/30" },
                purple: { bg: "bg-gradient-to-br from-white to-purple-50/50 dark:from-slate-800 dark:to-purple-900/20", icon: "bg-purple-100 text-purple-600 dark:bg-purple-900/50 dark:text-purple-400", border: "border-purple-100 dark:border-purple-900/30" },
                gray: { bg: "bg-gradient-to-br from-white to-slate-50/50 dark:from-slate-800 dark:to-slate-700/20", icon: "bg-slate-100 text-slate-500 dark:bg-slate-700/50 dark:text-slate-400", border: "border-slate-100 dark:border-slate-700" },
                green: { bg: "bg-gradient-to-br from-white to-green-50/50 dark:from-slate-800 dark:to-green-900/20", icon: "bg-green-100 text-green-600 dark:bg-green-900/50 dark:text-green-400", border: "border-green-100 dark:border-green-900/30" }
            };
            const s = styles[color] || styles.blue;
            return (
                <div className={`glass-card p-6 flex justify-between items-start hover:shadow-lg hover:-translate-y-1 transition-all duration-300 border ${s.border} ${s.bg}`}>
                    <div>
                        <p className="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">{title}</p>
                        <h3 className="text-2xl font-extrabold text-slate-800 dark:text-white tracking-tight">{value}</h3>
                        {subtext && <p className="text-xs text-slate-400 dark:text-slate-500 mt-1 font-medium">{subtext}</p>}
                    </div>
                    <div className={`p-3 rounded-xl shadow-sm ${s.icon}`}><Icon /></div>
                </div>
            );
        };

        const DataTable = ({ data, onNotify, onExportAll, title }) => {
            const [currentPage, setCurrentPage] = useState(1);
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
            const rowsPerPage = 20;

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            const sortedData = useMemo(() => {
                let sortableItems = [...data];
                if (sortConfig.key !== null) {
                    sortableItems.sort((a, b) => {
                        let aVal = a[sortConfig.key];
                        let bVal = b[sortConfig.key];
                        
                        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                        if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return sortableItems;
            }, [data, sortConfig]);

            const headers = data.length > 0 ? Object.keys(data[0]).filter(k => k !== 'detalhes') : [];
            const totalPages = Math.ceil(sortedData.length / rowsPerPage);
            const currentRows = sortedData.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);
            const goToPage = (p) => setCurrentPage(Math.min(Math.max(1, p), totalPages));
            
            const exportLocal = () => {
                const XLSX = window.XLSX;
                if (!XLSX) { if (onNotify) onNotify("Biblioteca XLSX não carregada.", "error"); return; }
                if (data.length === 0) { if (onNotify) onNotify("Sem dados.", "error"); return; }
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Dados");
                XLSX.writeFile(wb, "Exportacao_Parcial.xlsx");
            };

            if(data.length === 0) return <div className="p-8 text-center text-slate-400 dark:text-slate-500">Sem dados para exibir.</div>;
            
            return (
                <div className="glass-card overflow-hidden">
                    <div className="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h3 className="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2 text-sm"><Icons.Table /> {title || `Visualizando ${data.length} registros`}</h3>
                        <div className="flex gap-2">
                            <button onClick={onExportAll || exportLocal} className="text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/30 border border-green-200 dark:border-green-800 px-3 py-1.5 rounded text-xs flex items-center gap-1 transition-colors font-bold"><Icons.Download /> {onExportAll ? 'Baixar TUDO (Excel)' : 'Exportar Visualização'}</button>
                            <div className="border-l border-slate-300 dark:border-slate-600 mx-2 h-6"></div>
                            <span className="text-xs text-slate-400 dark:text-slate-500 self-center">Página {currentPage} de {totalPages}</span>
                            <button onClick={() => goToPage(currentPage-1)} disabled={currentPage===1} className="p-1 border dark:border-slate-600 rounded hover:bg-white dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 disabled:opacity-30"><Icons.ChevronLeft /></button>
                            <button onClick={() => goToPage(currentPage+1)} disabled={currentPage===totalPages} className="p-1 border dark:border-slate-600 rounded hover:bg-white dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 disabled:opacity-30"><Icons.ChevronRight /></button>
                        </div>
                    </div>
                    <div className="overflow-x-auto custom-scrollbar">
                        <table className="w-full text-xs text-left text-slate-600 dark:text-slate-300">
                            <thead className="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700">
                                <tr>
                                    {headers.map(h => (
                                        <th key={h} onClick={() => requestSort(h)} className="px-4 py-3 font-semibold whitespace-nowrap cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors group select-none">
                                            <div className="flex items-center gap-1">
                                                {h}
                                                <span className={`text-slate-300 dark:text-slate-600 ${sortConfig.key === h ? 'text-blue-500 dark:text-blue-400' : ''}`}>
                                                    {sortConfig.key === h ? (sortConfig.direction === 'asc' ? <Icons.ArrowUp width={12} /> : <Icons.ArrowDown width={12} />) : <div className="h-3 w-3 opacity-0 group-hover:opacity-50"><Icons.ArrowDown width={12} /></div>}
                                                </span>
                                            </div>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {currentRows.map((row, i) => (
                                    <tr key={i} className={`border-b border-slate-50 dark:border-slate-800 transition-colors ${i % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-slate-50/50 dark:bg-slate-800/30'} hover:bg-blue-50/30 dark:hover:bg-blue-900/20`}>
                                        {headers.map(h => { 
                                            const val = row[h]; const displayVal = typeof val === 'number' ? val.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : val; 
                                            return <td key={h} className="px-4 py-2.5 whitespace-nowrap">{displayVal}</td> 
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 3. AUTHENTICATION MODULE
        // ==========================================
        const LoginScreen = ({ onLogin, loading }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            return (
                <div className="min-h-screen flex bg-slate-50 dark:bg-slate-900 font-sans">
                    <div className="hidden md:block md:w-1/2 bg-cover bg-center relative" style={{ backgroundImage: "url('https://jsmnykikflkjceiqfmne.supabase.co/storage/v1/object/public/LOGOS/Loginpage.jpg')" }}>
                        <div className="absolute inset-0 bg-gradient-to-r from-black/20 to-transparent"></div>
                    </div>
                    <div className="w-full md:w-1/2 flex items-center justify-center p-8 md:p-12 bg-white dark:bg-slate-900">
                        <div className="w-full max-w-md space-y-8">
                            <div className="text-center">
                                <div className="inline-block p-6 rounded-2xl bg-slate-50 dark:bg-slate-800 mb-6 shadow-sm logo-interactive animate-enter cursor-pointer">
                                    <img src="https://jsmnykikflkjceiqfmne.supabase.co/storage/v1/object/public/LOGOS/Logo_com_texto-removebg-preview.png" alt="SAP Analytics Logo" className="h-40 mx-auto object-contain" />
                                </div>
                                <h2 className="text-3xl font-bold tracking-tight text-slate-900 dark:text-white">Bem-vindo de volta</h2>
                                <p className="mt-2 text-sm text-slate-600 dark:text-slate-400">Acesse sua conta para gerenciar os dados</p>
                            </div>
                            <form className="mt-8 space-y-6" onSubmit={(e) => { e.preventDefault(); onLogin(email, password); }}>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Email Corporativo</label>
                                        <div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><Icons.User /></div><input type="email" required className="block w-full pl-10 pr-3 py-3 border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 transition-colors outline-none" placeholder="seu@email.com" value={email} onChange={e => setEmail(e.target.value)} /></div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Senha</label>
                                        <div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><Icons.Lock /></div><input type="password" required className="block w-full pl-10 pr-3 py-3 border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 transition-colors outline-none" placeholder="••••••••" value={password} onChange={e => setPassword(e.target.value)} /></div>
                                    </div>
                                </div>
                                <div><button type="submit" disabled={loading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-bold rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all disabled:opacity-70 shadow-lg shadow-blue-200 dark:shadow-blue-900/30">{loading ? <span className="loader h-5 w-5 border-2 border-white rounded-full border-t-transparent"></span> : 'Entrar na Plataforma'}</button></div>
                            </form>
                            <div className="mt-6 text-center"><p className="text-xs text-slate-400 dark:text-slate-500">&copy; {new Date().getFullYear()} SAP Analytics. Todos os direitos reservados.</p></div>
                        </div>
                    </div>
                </div>
            );
        };

        const ControladoriaDashboardAnalitico = ({ stats, loading, tipo, setTipo, onDrillDown, periodo, periodoComp, isDark }) => {
            const chartColors = getChartColors(isDark);
            const isPositiveGood = tipo === 'Receita' || tipo === 'Resultado';
            const getVariationColor = (val) => {
                if(val === 0) return 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300';
                if(isPositiveGood) return val > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400';
                return val > 0 ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400' : 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400';
            };
            const getArrow = (val) => val > 0 ? '▲' : (val < 0 ? '▼' : '-');
            
            const totalValue = (stats || []).reduce((acc, curr) => acc + (parseFloat(curr.valor_atual) || 0), 0);

            const safeStats = (stats || []).map(row => {
                const val = parseFloat(row.valor_atual) || 0;
                let perc = parseFloat(row.perc_receita) || 0;
                if (Math.abs(perc) < 0.01 && totalValue !== 0) {
                    perc = (val / totalValue) * 100;
                }
                return {
                    ...row,
                    valor_atual: val,
                    rs_m3: parseFloat(row.rs_m3) || 0,
                    perc_receita: perc,
                    variacao_perc: parseFloat(row.variacao_perc) || 0
                };
            });

            if (safeStats.length === 0) return (
                <div className="flex flex-col items-center justify-center h-64 text-slate-400 dark:text-slate-500"><Icons.Info /><p className="mt-2 font-bold">Sem dados.</p><p className="text-sm text-center">Verifique o período ou o cadastro De/Para para "{tipo}".</p></div>
            );

            const topVariacoes = [...safeStats]
                .filter(i => isPositiveGood ? (i.variacao_perc < 0 && Math.abs(i.valor_atual) > 500) : (i.variacao_perc > 0 && i.valor_atual > 500))
                .sort((a,b) => isPositiveGood ? a.variacao_perc - b.variacao_perc : b.variacao_perc - a.variacao_perc)
                .slice(0, 3);

            const tabs = [{ id: 'Receita', color: 'emerald' }, { id: 'Resultado', color: 'blue' }, { id: 'Custo', color: 'orange' }, { id: 'Despesa', color: 'red' }];

            return (
                <div className="space-y-6">
                    <div className="flex justify-center mb-4"><div className="bg-slate-200 dark:bg-slate-700 p-1 rounded-lg flex shadow-inner gap-1">{tabs.map(t => (<button key={t.id} onClick={() => setTipo(t.id)} className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${tipo === t.id ? `bg-white dark:bg-slate-600 text-${t.color}-600 dark:text-${t.color}-400 shadow` : 'text-slate-500 dark:text-slate-400'}`}>{t.id}s</button>))}</div></div>
                    
                    <div className="flex gap-6 items-start flex-col lg:flex-row">
                        <div className="flex-1 glass-card overflow-hidden w-full relative z-10">
                            <div className="p-4 bg-slate-50 dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center"><h3 className="font-bold text-sm text-slate-700 dark:text-slate-200">Detalhamento de {tipo}s</h3><span className="text-xs text-slate-400">Comparando: {periodo} vs {periodoComp || '...'}</span></div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                                    <thead className="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700">
                                        <tr>
                                            <th className="px-6 py-3">Conta</th>
                                            <th className="px-6 py-3 text-right">Valor Total</th>
                                            <th className="px-6 py-3 text-right">R$ / m³</th>
                                            <th className="px-6 py-3 text-right">% Repres.</th>
                                            <th className="px-6 py-3 text-right">Var. Período</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {safeStats.map((row, i) => (
                                            <tr key={i} onClick={() => onDrillDown(row.conta)} className="border-b border-slate-50 dark:border-slate-800 interactive-row transition-colors">
                                                <td className="px-6 py-3 font-medium text-slate-800 dark:text-slate-200">{row.conta}</td>
                                                <td className="px-6 py-3 text-right">{Utils.formatters.currency(row.valor_atual)}</td>
                                                <td className="px-6 py-3 text-right font-mono text-slate-600 dark:text-slate-400">{Utils.formatters.currency(row.rs_m3)}</td>
                                                <td className="px-6 py-3 text-right">
                                                    <div className="flex items-center justify-end gap-2">
                                                        <span className="text-xs font-bold text-slate-700 dark:text-slate-300">{row.perc_receita.toFixed(2)}%</span>
                                                        <div className="w-16 h-1.5 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                                            <div className={`h-full ${isPositiveGood ? 'bg-emerald-500' : 'bg-red-500'}`} style={{ width: `${Math.min(row.perc_receita, 100)}%` }}></div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-3 text-right">
                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${getVariationColor(row.variacao_perc)}`}>
                                                        {getArrow(row.variacao_perc)} {Math.abs(row.variacao_perc).toFixed(1)}%
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="w-full lg:w-80 space-y-4"><div className={`glass-card p-5 border-t-4 ${isPositiveGood ? 'border-orange-500' : 'border-red-500'}`}><h4 className="font-bold text-slate-800 dark:text-white mb-3 flex items-center gap-2"><span className={isPositiveGood ? 'text-orange-500' : 'text-red-500'}><Icons.BarChart2 /></span> {isPositiveGood ? 'Quedas Relevantes' : 'Aumentos de Custo'}</h4><p className="text-xs text-slate-500 dark:text-slate-400 mb-4">Maiores impactos negativos.</p>{topVariacoes.length > 0 ? (<div className="space-y-3">{topVariacoes.map((item, idx) => (<div key={idx} onClick={() => onDrillDown(item.conta)} className={`p-3 rounded-lg border interactive-row ${isPositiveGood ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-100 dark:border-orange-900/30' : 'bg-red-50 dark:bg-red-900/20 border-red-100 dark:border-red-900/30'}`}><p className="text-xs font-bold text-slate-700 dark:text-slate-300 mb-1">{item.conta}</p><div className="flex justify-between items-end"><span className={`${isPositiveGood ? 'text-orange-600 dark:text-orange-400' : 'text-red-600 dark:text-red-400'} font-bold text-sm`}>{isPositiveGood ? '▼' : '▲'} {Math.abs(item.variacao_perc).toFixed(1)}%</span><span className="text-xs text-slate-400">R$ {item.valor_atual.toLocaleString('pt-BR', {notation: 'compact'})}</span></div></div>))}</div>) : (<div className="text-center py-4 text-slate-400 text-xs">Nenhuma variação crítica.</div>)}</div></div>
                    </div>
                </div>
            );
        };

        const ControladoriaDashboardCentroCusto = ({ supabaseClient, periodo, contas, onNotify, initialConta, onBack, isDark }) => {
            const [selectedConta, setSelectedConta] = useState(initialConta || (contas.length > 0 ? contas[0] : ''));
            const [data, setData] = useState({ ranking: [], evolucao: [] });
            const chartColors = getChartColors(isDark);
            
            useEffect(() => { if(contas.length > 0 && !selectedConta) setSelectedConta(contas[0]); }, [contas]);

            const fetchData = async () => {
                if (!selectedConta || !periodo) return;
                try {
                    const { data: ranking, error: errRank } = await supabaseClient.rpc('get_controladoria_detalhe_conta', { p_periodo: periodo, p_conta: selectedConta });
                    if (errRank) throw errRank;
                    const { data: evolucao, error: errEvo } = await supabaseClient.rpc('get_controladoria_evolucao_conta', { p_conta: selectedConta, p_periodo_fim: periodo });
                    if (errEvo) throw errEvo;
                    const safeRanking = (ranking || []).map(r => ({ ...r, valor_atual: parseFloat(r.valor_atual)||0, vol_atual: parseFloat(r.vol_atual)||0, rs_m3_atual: parseFloat(r.rs_m3_atual)||0, media_12m: parseFloat(r.media_12m)||0, variacao_12m_perc: parseFloat(r.variacao_12m_perc)||0 }));
                    const safeEvolucao = (evolucao || []).sort((a,b)=>a.periodo.localeCompare(b.periodo)).map(e => ({ ...e, valor_total: parseFloat(e.valor_total)||0, rs_m3_medio: parseFloat(e.rs_m3_medio)||0 }));
                    setData({ ranking: safeRanking, evolucao: safeEvolucao });
                } catch (e) { onNotify("Erro detalhe: " + e.message, "error"); }
            };

            useEffect(() => { fetchData(); }, [selectedConta, periodo]);

            const totalGasto = data.ranking.reduce((acc, curr) => acc + curr.valor_atual, 0);
            const totalVol = data.ranking.reduce((acc, curr) => acc + curr.vol_atual, 0);
            const mediaRsM3 = totalVol > 0 ? totalGasto / totalVol : 0;
            const trend = data.evolucao.length >= 2 ? ((data.evolucao[data.evolucao.length-1].valor_total - data.evolucao[0].valor_total) / data.evolucao[0].valor_total) * 100 : 0;
            const safeTrend = isFinite(trend) ? trend : 0;

            return (
                <div className="space-y-6">
                    <div className="flex items-center gap-4 mb-4">
                        <button onClick={onBack} className="flex items-center gap-2 text-slate-500 hover:text-purple-600 transition-colors font-medium text-sm bg-white dark:bg-slate-800 px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm"><Icons.ArrowLeft /> Voltar</button>
                        <h2 className="text-xl font-bold text-slate-800 dark:text-white">Detalhamento: <span className="text-purple-600 dark:text-purple-400">{selectedConta}</span></h2>
                    </div>
                    <div className="glass-card p-4 flex items-center gap-4 relative z-20">
                        <div className="flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-400"><Icons.Filter className="w-4 h-4" /> Alternar Centro de Custo:</div>
                        <select className="border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm w-96 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 focus:ring-2 focus:ring-purple-500 outline-none" value={selectedConta} onChange={e => setSelectedConta(e.target.value)}>
                            {contas.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                        <button onClick={fetchData} className="text-purple-600 hover:text-purple-800"><Icons.RefreshCw className="w-4 h-4" /></button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <Card title="Gasto Total (Mês)" value={Utils.formatters.currency(totalGasto)} iconName="dollar" color="purple" />
                        <Card title="Custo Unitário Médio" value={`R$ ${Utils.formatters.number(mediaRsM3)}/m³`} iconName="target" color="blue" subtext="Média global" />
                        <Card title="Volatilidade" value={`${safeTrend > 0 ? '+' : ''}${safeTrend.toFixed(1)}%`} iconName="barChart" color={safeTrend > 0 ? "orange" : "emerald"} subtext="vs 12 meses" />
                        <Card title="Volume Afetado" value={`${Utils.math.roundVolume(totalVol).toLocaleString('pt-BR')} m³`} iconName="truck" color="gray" />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="glass-card p-6 h-[400px] flex flex-col">
                            <h3 className="font-bold text-slate-800 dark:text-slate-200 mb-4">Top 10 Usinas - Maior Custo por m³</h3>
                            <ResponsiveContainer width="100%" height="100%"><BarChart layout="vertical" data={data.ranking.sort((a,b) => b.rs_m3_atual - a.rs_m3_atual).slice(0,10)} margin={{top: 5, right: 30, left: 40, bottom: 5}}><CartesianGrid strokeDasharray="3 3" horizontal={false} stroke={chartColors.grid} /><XAxis type="number" tick={{fill: chartColors.text}} tickFormatter={(val) => `R$ ${val}`} /><YAxis dataKey="usina" type="category" width={50} tick={{fontSize: 11, fontWeight: 'bold', fill: chartColors.text}} /><Tooltip content={<CustomTooltip isDark={isDark} />} /><Bar dataKey="rs_m3_atual" fill={chartColors.controladoria} radius={[0, 4, 4, 0]} name="R$/m³" barSize={20}>{data.ranking.slice(0,10).map((entry, index) => (<Cell key={`cell-${index}`} fill={entry.rs_m3_atual > mediaRsM3 ? chartColors.danger : chartColors.success} />))}</Bar></BarChart></ResponsiveContainer>
                        </div>
                        <div className="glass-card p-6 h-[400px] flex flex-col">
                            <h3 className="font-bold text-slate-800 dark:text-slate-200 mb-4">Evolução Histórica (12 Meses)</h3>
                            <ResponsiveContainer width="100%" height="100%"><ComposedChart data={data.evolucao} margin={{top: 10, right: 10, left: 0, bottom: 0}}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke={chartColors.grid} /><XAxis dataKey="periodo" tick={{fontSize: 10, fill: chartColors.text}} /><YAxis yAxisId="left" orientation="left" tick={{fill: chartColors.text}} tickFormatter={(val) => `R$ ${val/1000}k`} /><YAxis yAxisId="right" orientation="right" tick={{fill: chartColors.text}} tickFormatter={(val) => `R$ ${val}`} /><Tooltip content={<CustomTooltip isDark={isDark} />} /><Legend /><Bar yAxisId="left" dataKey="valor_total" name="Valor Total" fill={chartColors.controladoria_dark} barSize={30} fillOpacity={0.6} /><Line yAxisId="right" type="monotone" dataKey="rs_m3_medio" name="R$/m³ Médio" stroke={chartColors.accent} strokeWidth={3} dot={{r:4}} /></ComposedChart></ResponsiveContainer>
                        </div>
                    </div>
                    <DataTable data={data.ranking} onNotify={onNotify} title="Detalhamento Completo por Usina" />
                </div>
            );
        };

        const ControladoriaImport = ({ onImport, loading }) => {
            const [date, setDate] = useState('');
            return (
                <div className="max-w-2xl mx-auto glass-card p-8">
                    <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><Icons.Upload /> Importação Controladoria</h3>
                    <div className="space-y-4">
                        <MonthPicker label="Período de Referência" value={date} onChange={setDate} />
                        <div className="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-8 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"><input type="file" accept=".xlsx, .csv" className="hidden" id="fileInput" disabled={loading || !date} onChange={(e) => { if(e.target.files[0]) onImport(e.target.files[0], date); e.target.value = null; }} /><label htmlFor="fileInput" className={`cursor-pointer flex flex-col items-center ${!date ? 'opacity-50 cursor-not-allowed' : ''}`}><div className="bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 p-4 rounded-full mb-3"><Icons.FileText /></div><span className="font-bold text-slate-700 dark:text-slate-300">Selecionar Arquivo</span></label></div>
                        {loading && <div className="text-center text-xs text-blue-600 font-medium">Processando...</div>}
                    </div>
                </div>
            );
        };

        const ControladoriaDePara = ({ supabaseClient, onNotify }) => {
            const [mappings, setMappings] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [formData, setFormData] = useState({ id: null, original_name: '', friendly_name: '', tipo: 'Despesa', classificacao: 'Variável' });
            const [availableAccounts, setAvailableAccounts] = useState([]);

            const fetchMappings = async () => { try { const { data } = await supabaseClient.from('controladoria_de_para').select('*').order('friendly_name'); setMappings(data || []); } catch (e) { onNotify(e.message, "error"); } };
            const fetchAvailableAccounts = async () => { try { const { data, error } = await supabaseClient.rpc('get_controladoria_contas'); if (error) throw error; setAvailableAccounts(data.map(d => d.conta)); } catch (e) { onNotify("Erro contas: " + e.message, "error"); } };
            
            useEffect(() => { fetchMappings(); fetchAvailableAccounts(); }, []);

            const handleEdit = (item) => {
                setFormData({
                    id: item.id,
                    original_name: item.original_name,
                    friendly_name: item.friendly_name,
                    tipo: item.tipo,
                    classificacao: item.classificacao || 'Variável'
                });
                setShowModal(true);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                try {
                    const payload = { original_name: formData.original_name, friendly_name: formData.friendly_name, tipo: formData.tipo, classificacao: (formData.tipo === 'Custo' || formData.tipo === 'Despesa') ? formData.classificacao : null };
                    const { error } = formData.id ? await supabaseClient.from('controladoria_de_para').update(payload).eq('id', formData.id) : await supabaseClient.from('controladoria_de_para').insert(payload);
                    if (error) throw error; onNotify("Salvo!", "success"); setShowModal(false); fetchMappings();
                } catch (e) { onNotify(e.message, "error"); }
            };

            const handleDelete = async (id) => { if(!confirm('Confirmar exclusão?')) return; await supabaseClient.from('controladoria_de_para').delete().eq('id', id); fetchMappings(); };

            const getTypeColor = (tipo) => { switch(tipo) { case 'Receita': return 'bg-green-100 text-green-700'; case 'Resultado': return 'bg-blue-100 text-blue-700'; case 'Custo': return 'bg-orange-100 text-orange-700'; default: return 'bg-red-100 text-red-700'; } };

            return (
                <div className="max-w-5xl mx-auto space-y-6">
                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><Icons.Settings /> Configuração De/Para</h2><button onClick={() => { setFormData({ id: null, original_name: '', friendly_name: '', tipo: 'Despesa', classificacao: 'Variável' }); setShowModal(true); }} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><Icons.Plus /> Novo De/Para</button></div>
                    <div className="glass-card overflow-hidden">
                        <table className="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                            <thead className="text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700"><tr><th className="px-6 py-3">Original</th><th className="px-6 py-3">Amigável</th><th className="px-6 py-3">Tipo</th><th className="px-6 py-3 text-right">Ações</th></tr></thead>
                            <tbody>{mappings.map(item => (<tr key={item.id} className="border-b border-slate-50 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800"><td className="px-6 py-3 font-mono">{item.original_name}</td><td className="px-6 py-3 font-bold">{item.friendly_name}</td><td className="px-6 py-3"><div className="flex gap-2"><span className={`px-2 py-1 rounded text-xs font-bold ${getTypeColor(item.tipo)}`}>{item.tipo}</span>{item.classificacao && <span className="px-2 py-1 rounded text-xs font-bold bg-slate-100 text-slate-600 border border-slate-200">{item.classificacao}</span>}</div></td><td className="px-6 py-3 text-right flex justify-end gap-3"><button onClick={() => handleEdit(item)} className="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"><Icons.Edit /></button><button onClick={() => handleDelete(item.id)} className="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition-colors"><Icons.Trash2 /></button></td></tr>))}</tbody>
                        </table>
                    </div>
                    {showModal && (
    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div className="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-lg border border-slate-200 dark:border-slate-700 shadow-2xl animate-enter">
            <h3 className="font-bold mb-4 text-slate-800 dark:text-white">{formData.id ? 'Editar' : 'Novo'} Mapeamento</h3>
            <form onSubmit={handleSave} className="space-y-4">
                <div>
                    <label className="input-label">Conta Original</label>
                    <select 
                        className="w-full border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" 
                        value={formData.original_name} 
                        onChange={e => setFormData({...formData, original_name: e.target.value})} 
                        required 
                        disabled={!!formData.id}
                    >
                        <option value="">Selecione...</option>
                        {availableAccounts.map(acc => (<option key={acc} value={acc}>{acc}</option>))}
                    </select>
                </div>
                
                <div>
                    <label className="input-label">Nome Amigável</label>
                    <input 
                        placeholder="Ex: Combustível Frota" 
                        className="w-full border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none placeholder-slate-400" 
                        value={formData.friendly_name} 
                        onChange={e=>setFormData({...formData, friendly_name:e.target.value})} 
                        required 
                    />
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="input-label">Categoria</label>
                        <select 
                            className="w-full border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" 
                            value={formData.tipo} 
                            onChange={e => setFormData({...formData, tipo: e.target.value})} 
                            required
                        >
                            <option value="Despesa">Despesa</option>
                            <option value="Custo">Custo</option>
                            <option value="Receita">Receita</option>
                            <option value="Resultado">Resultado</option>
                        </select>
                    </div>
                    {(formData.tipo === 'Custo' || formData.tipo === 'Despesa') && (
                        <div>
                            <label className="input-label">Classificação</label>
                            <select 
                                className="w-full border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" 
                                value={formData.classificacao} 
                                onChange={e => setFormData({...formData, classificacao: e.target.value})}
                            >
                                <option value="Variável">Variável</option>
                                <option value="Fixo">Fixo</option>
                            </select>
                        </div>
                    )}
                </div>
                
                <div className="flex justify-end gap-2 pt-2">
                    <button 
                        type="button" 
                        onClick={()=>setShowModal(false)} 
                        className="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors font-medium text-sm"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm transition-colors shadow-lg shadow-blue-500/30"
                    >
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
)}
</div>
    );
};
        const DieselImport = ({ onImport, loading }) => {
            const [date, setDate] = useState('');
            return (
                <div className="max-w-2xl mx-auto glass-card p-8">
                    <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><Icons.Upload /> Importação de Estoque Diesel</h3>
                    <div className="space-y-4">
                        <MonthPicker label="Mês de Referência" value={date} onChange={setDate} />
                        <div className="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-8 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"><input type="file" accept=".xlsx, .csv" className="hidden" id="fileDiesel" disabled={loading || !date} onChange={(e) => { if(e.target.files[0]) onImport(e.target.files[0], date); e.target.value = null; }} /><label htmlFor="fileDiesel" className={`cursor-pointer flex flex-col items-center ${!date ? 'opacity-50 cursor-not-allowed' : ''}`}><div className="bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 p-4 rounded-full mb-3"><Icons.Fuel /></div><span className="font-bold text-slate-700 dark:text-slate-300">Selecionar Arquivo</span></label></div>
                        {loading && <div className="text-center text-xs text-blue-600 font-medium">Processando...</div>}
                    </div>
                </div>
            );
        };

        const DieselDashboard = ({ data, loading, periodo, isDark }) => {
            if (!data || data.length === 0) return <div className="p-8 text-center text-slate-400">Sem dados para o período {periodo}.</div>;
            const totalVol = data.reduce((acc, curr) => acc + (curr.vol_final || 0), 0);
            const totalVal = data.reduce((acc, curr) => acc + (curr.vlr_final || 0), 0);
            const totalEntrada = data.reduce((acc, curr) => acc + (curr.entradas || 0), 0);
            const totalSaida = data.reduce((acc, curr) => acc + (curr.saidas || 0), 0);
            const topCustos = [...data].sort((a, b) => b.custo_medio - a.custo_medio).slice(0, 10);
            const topAjustes = [...data].filter(d => Math.abs(d.ajuste_vol) > 0).sort((a, b) => Math.abs(b.ajuste_vol) - Math.abs(a.ajuste_vol)).slice(0, 10);
            const chartColors = getChartColors(isDark);

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 animate-slide-up">
                        <Card title="Estoque Atual (L)" value={Utils.math.roundVolume(totalVol).toLocaleString('pt-BR') + " L"} iconName="truck" color="blue" />
                        <Card title="Valor em Estoque" value={Utils.formatters.currency(totalVal)} iconName="dollar" color="emerald" />
                        <Card title="Entradas no Mês" value={Utils.math.roundVolume(totalEntrada).toLocaleString('pt-BR') + " L"} iconName="arrowRight" color="green" subtext="Abastecimentos recebidos" />
                        <Card title="Saídas no Mês" value={Utils.math.roundVolume(totalSaida).toLocaleString('pt-BR') + " L"} iconName="fuel" color="orange" subtext="Consumo da frota" />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-slide-up delay-200">
                        <div className="glass-card p-6 h-[400px] flex flex-col">
                            <h3 className="font-bold text-slate-800 dark:text-slate-200 mb-4">Top 10 - Maior Custo Médio (R$/L)</h3>
                            <ResponsiveContainer width="100%" height="100%"><BarChart layout="vertical" data={topCustos} margin={{top: 5, right: 30, left: 40, bottom: 5}}><CartesianGrid strokeDasharray="3 3" horizontal={false} stroke={chartColors.grid} /><XAxis type="number" domain={['auto', 'auto']} tick={{fill: chartColors.text}} tickFormatter={(val) => `R$ ${val}`} /><YAxis dataKey="usina" type="category" width={60} tick={{fontSize: 10, fontWeight: 'bold', fill: chartColors.text}} /><Tooltip content={<CustomTooltip isDark={isDark} />} /><Bar dataKey="custo_medio" fill={chartColors.bomba} radius={[0, 4, 4, 0]} barSize={20} name="Custo Médio" /></BarChart></ResponsiveContainer>
                        </div>
                        <div className="glass-card p-6 h-[400px] flex flex-col">
                            <h3 className="font-bold text-slate-800 dark:text-slate-200 mb-4">Top 10 - Maiores Ajustes (L)</h3>
                            <ResponsiveContainer width="100%" height="100%"><BarChart data={topAjustes} margin={{top: 5, right: 5, left: 0, bottom: 5}}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke={chartColors.grid} /><XAxis dataKey="usina" tick={{fontSize: 10, fill: chartColors.text}} interval={0} angle={-15} textAnchor="end" height={50} /><YAxis tick={{fill: chartColors.text}} tickFormatter={(val) => `${val} L`} /><Tooltip content={<CustomTooltip isDark={isDark} />} /><ReferenceLine y={0} stroke={chartColors.text} /><Bar dataKey="ajuste_vol" name="Ajuste (L)" radius={[4, 4, 0, 0]} fill={chartColors.secondary} /></BarChart></ResponsiveContainer>
                        </div>
                    </div>
                </div>
            );
        };

        const UploadCard = ({ type, iconName, onAnalyze, isAnalyzing, progress }) => {
            const Icon = Icons[iconName.charAt(0).toUpperCase() + iconName.slice(1)] || Icons.FileText;
            return (
                <div className="glass-card p-6 text-center relative group hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-300">
                    <div className="mb-4 text-slate-400 p-4 bg-slate-50 dark:bg-slate-800 rounded-full inline-block group-hover:text-blue-500 group-hover:bg-blue-50 dark:group-hover:bg-blue-900/30 transition-colors"><Icon /></div>
                    <h3 className="font-bold capitalize mb-2 text-slate-700 dark:text-slate-200">{type}</h3>
                    <input type="file" className="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 dark:file:bg-blue-900/50 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 cursor-pointer" onChange={e => e.target.files && onAnalyze(e.target.files[0], type)} disabled={isAnalyzing} />
                    {progress > 0 && (<div className="w-full bg-slate-100 h-1.5 mt-4 rounded-full overflow-hidden"><div className="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div></div>)}
                </div>
            );
        };

        const Sidebar = ({ isSidebarOpen, toggleSidebar, toggleModule, expandedModules, userRole, setView, view, handleLogout, session }) => {
            return (
                <div className={`bg-slate-900 text-slate-300 flex flex-col fixed h-full shadow-2xl z-50 sidebar-transition ${isSidebarOpen ? 'w-64' : 'w-20'}`}>
                    <div className="p-4 border-b border-slate-800 flex items-center justify-between relative">
                        <div className={`flex items-center gap-3 overflow-hidden ${!isSidebarOpen && 'justify-center w-full'}`}><img src="https://jsmnykikflkjceiqfmne.supabase.co/storage/v1/object/public/LOGOS/Logo_sm_texto-removebg-preview.png" alt="Logo" className="h-12 w-auto flex-shrink-0" />{isSidebarOpen && <div className="fade-enter whitespace-nowrap"><span className="font-bold text-white text-lg block leading-tight">SAP</span><span className="text-[10px] font-medium text-slate-400 tracking-widest uppercase">Analytics</span></div>}</div>
                        <button onClick={toggleSidebar} className="absolute -right-4 top-6 bg-slate-800 text-slate-400 hover:text-white p-1 rounded-full border border-slate-700 shadow-lg z-30 hover:scale-110 transition-transform"><Icons.ChevronLeft className={`transform transition-transform ${!isSidebarOpen ? 'rotate-180' : ''}`} /></button>
                    </div>
                    <nav className="flex-1 p-2 space-y-2 overflow-y-auto custom-scrollbar">
                        {Utils.checkPermission(userRole, 'terceirizacao') && (<div className="group"><button onClick={() => isSidebarOpen && toggleModule('terceirizacao')} className={`w-full flex items-center justify-between px-3 py-3 rounded-lg transition-colors ${!isSidebarOpen ? 'justify-center' : 'bg-slate-800/40 text-slate-100 hover:bg-slate-800'}`}><div className="flex items-center gap-3"><Icons.Briefcase />{isSidebarOpen && <span className="font-semibold text-sm fade-enter">Terceirização</span>}</div>{isSidebarOpen && (<span className={`text-slate-500 transform transition-transform duration-200 ${expandedModules.terceirizacao ? 'rotate-180' : ''}`}><Icons.ChevronDown /></span>)}</button>{isSidebarOpen && expandedModules.terceirizacao && (<div className="ml-4 mt-1 space-y-1 border-l-2 border-slate-800 pl-3 fade-enter"><button onClick={() => setView('dashboard')} className={`w-full flex items-center gap-2 px-2 py-2 text-sm rounded transition-colors ${view === 'dashboard' ? 'text-blue-400 font-medium bg-slate-800/50' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`}>Visão Geral</button><button onClick={() => setView('reports')} className={`w-full flex items-center gap-2 px-2 py-2 text-sm rounded transition-colors ${view === 'reports' ? 'text-emerald-400 font-medium bg-slate-800/50' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`}>Relatórios</button><button onClick={() => setView('upload')} className={`w-full flex items-center gap-2 px-2 py-2 text-sm rounded transition-colors ${view === 'upload' ? 'text-purple-400 font-medium bg-slate-800/50' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`}>Importação</button></div>)}</div>)}
                        {Utils.checkPermission(userRole, 'controladoria') && (
    <div className="group mt-2">
        <button onClick={() => isSidebarOpen && toggleModule('controladoria')} className={`w-full flex items-center justify-between px-3 py-3 rounded-lg transition-colors ${!isSidebarOpen ? 'justify-center' : 'bg-slate-800/40 text-slate-100 hover:bg-slate-800'}`}>
            <div className="flex items-center gap-3"><Icons.BarChart2 />{isSidebarOpen && <span className="font-semibold text-sm fade-enter">Controladoria</span>}</div>
            {isSidebarOpen && (<span className={`text-slate-500 transform transition-transform duration-200 ${expandedModules.controladoria ? 'rotate-180' : ''}`}><Icons.ChevronDown /></span>)}
        </button>
        {isSidebarOpen && expandedModules.controladoria && (
            <div className="ml-4 mt-1 space-y-1 border-l-2 border-slate-800 pl-3 fade-enter">
                <button onClick={() => setView('controladoria', 'dash')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Visão Geral</button>
                {/* Botão DRE corrigido e padronizado aqui */}
                <button onClick={() => setView('controladoria', 'dre')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">DRE Gerencial</button>
                <button onClick={() => setView('controladoria', 'report')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Dados Detalhados</button>
                <button onClick={() => setView('controladoria', 'depara')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Configuração</button>
                <button onClick={() => setView('controladoria', 'import')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Importação</button>
            </div>
        )}
    </div>
)}
                        {Utils.checkPermission(userRole, 'diesel') && (<div className="group mt-2"><button onClick={() => isSidebarOpen && toggleModule('diesel')} className={`w-full flex items-center justify-between px-3 py-3 rounded-lg transition-colors ${!isSidebarOpen ? 'justify-center' : 'bg-slate-800/40 text-slate-100 hover:bg-slate-800'}`}><div className="flex items-center gap-3"><Icons.Fuel />{isSidebarOpen && <span className="font-semibold text-sm fade-enter">Diesel</span>}</div>{isSidebarOpen && (<span className={`text-slate-500 transform transition-transform duration-200 ${expandedModules.diesel ? 'rotate-180' : ''}`}><Icons.ChevronDown /></span>)}</button>{isSidebarOpen && expandedModules.diesel && (<div className="ml-4 mt-1 space-y-1 border-l-2 border-slate-800 pl-3 fade-enter"><button onClick={() => setView('diesel', 'dash')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Visão Geral</button><button onClick={() => setView('diesel', 'report')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Relatório</button><button onClick={() => setView('diesel', 'import')} className="w-full flex items-center gap-2 px-2 py-2 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/30 rounded">Importação</button></div>)}</div>)}
                    </nav>
                    <div className="p-4 border-t border-slate-800"><div className={`flex items-center gap-3 ${!isSidebarOpen && 'justify-center'}`}><div className="relative w-9 h-9 flex items-center justify-center flex-shrink-0"><div className="absolute inset-0 rounded-full bg-[conic-gradient(from_0deg,red,orange,yellow,green,blue,purple,red)] animate-[spin_3s_linear_infinite] blur-[2px]"></div><div className="relative w-8 h-8 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-white font-bold text-xs z-10 shadow-inner">{session.user.email.substring(0,2).toUpperCase()}</div></div>{isSidebarOpen && (<div className="overflow-hidden flex-1 fade-enter"><p className="text-white text-xs font-medium truncate">{session.user.email.split('@')[0]}</p><p className="text-[10px] text-slate-500 truncate capitalize">{userRole}</p></div>)}{isSidebarOpen && (<button onClick={handleLogout} className="text-slate-400 hover:text-white transition-colors" title="Sair"><Icons.LogOut /></button>)}</div></div>
                </div>
            );
        };

        const App = () => {
            const [supabaseClient, setSupabaseClient] = useState(null);
            const [session, setSession] = useState(null);
            const [userRole, setUserRole] = useState(null);
            const [loading, setLoading] = useState(false);
            const [logs, setLogs] = useState([]);
            
            const [isDark, setIsDark] = useState(() => {
                if (typeof window !== 'undefined') {
                    return localStorage.getItem('theme') === 'dark' || 
                           (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
                }
                return false;
            });
            
            const chartColors = getChartColors(isDark);
            const currentYear = new Date().getFullYear();
            const [drePeriodoIni, setDrePeriodoIni] = useState(`${currentYear}-01`);
            const [drePeriodoFim, setDrePeriodoFim] = useState(`${currentYear}-12`);
            const [dreUsinas, setDreUsinas] = useState(['Todas']);
            const [mappings, setMappings] = useState([]);

            useEffect(() => {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [isDark]);

            useEffect(() => {
                const { createClient } = window.supabase || {};
                if (createClient) {
                    const client = createClient('https://jsmnykikflkjceiqfmne.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzbW55a2lrZmxramNlaXFmbW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTI5NzYsImV4cCI6MjA3OTU4ODk3Nn0.1EtrQTvZERRe8igl0PYnGH8H9SXuOg7mq4PVZVwRJVA');
                    setSupabaseClient(client);
                } else {
                    console.error("Supabase library not loaded");
                }
            }, []);

            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [expandedModules, setExpandedModules] = useState({ terceirizacao: false, controladoria: false, diesel: false });
            const [view, setView] = useState('dashboard');
            const [subView, setSubView] = useState('dash');
            const [dashboardData, setDashboardData] = useState({ kpis: { total_vol: 0, total_val: 0, vol_bomba: 0, vol_transp: 0 }, chart_class: [], chart_plate: [], chart_evo: [], chart_branch: [] });
            const [dieselData, setDieselData] = useState([]);
            const [controladoriaAnalise, setControladoriaAnalise] = useState([]);
            const [controladoriaRaw, setControladoriaRaw] = useState([]);
            const [resumoData, setResumoData] = useState([]);
            const [confirmData, setConfirmData] = useState(null);
            const [filters, setFilters] = useState({ month: 'Todos', filial: 'Todas', cidade: 'Todas', ctrlPeriodo: '', ctrlPeriodoComp: '', ctrlUsina: 'Todas', ctrlTipo: 'Despesa', dieselPeriodo: '' });
            const [selectedReportPeriods, setSelectedReportPeriods] = useState([]);
            const [drillDownConta, setDrillDownConta] = useState(null);
            const [controladoriaContas, setControladoriaContas] = useState([]);
            const [controladoriaFiliais, setControladoriaFiliais] = useState([]);
            const [rankingFilter, setRankingFilter] = useState('top10');

            const addLog = (msg, type='info') => setLogs(p => [{msg, type}, ...p]);

            const uniqueReportPeriods = useMemo(() => {
                if (view === 'controladoria' && subView === 'report') {
                    if (!controladoriaRaw || controladoriaRaw.length === 0) return [];
                    return [...new Set(controladoriaRaw.map(item => item.periodo))].sort();
                }
                if (!resumoData || resumoData.length === 0) return [];
                return [...new Set(resumoData.map(item => item.mes || item.periodo || 'Unknown'))].sort();
            }, [resumoData, controladoriaRaw, view, subView]);

            const filteredReportData = useMemo(() => {
                if (view === 'controladoria' && subView === 'report') {
                    if (!controladoriaRaw) return [];
                    if (selectedReportPeriods.length === 0) return controladoriaRaw; 
                    return controladoriaRaw.filter(item => selectedReportPeriods.includes(item.periodo));
                }
                if (!resumoData) return [];
                if (selectedReportPeriods.length === 0) return resumoData;
                return resumoData.filter(item => selectedReportPeriods.includes(item.mes || item.periodo));
            }, [resumoData, controladoriaRaw, selectedReportPeriods, view, subView]);

            useEffect(() => {
                const today = new Date();
                const m = (today.getMonth() + 1).toString().padStart(2, '0');
                const y = today.getFullYear();
                const cur = `${y}-${m}`;
                const prevDate = new Date(today); prevDate.setMonth(prevDate.getMonth() - 1);
                const pm = prevDate.getMonth() + 1; const py = prevDate.getFullYear();
                const defaultPrevPeriod = `${py}-${pm.toString().padStart(2, '0')}`;
                setFilters(prev => ({...prev, dieselPeriodo: cur}));
                const loadLatestCtrl = async () => {
                    if (!supabaseClient) return;
                    const { data } = await supabaseClient.from('controladoria_importacoes').select('periodo').order('periodo', { ascending: false }).limit(1);
                    if (data && data.length > 0) {
                        setFilters(prev => ({...prev, ctrlPeriodo: data[0].periodo, ctrlPeriodoComp: defaultPrevPeriod}));
                    } else {
                        setFilters(prev => ({...prev, ctrlPeriodo: cur, ctrlPeriodoComp: defaultPrevPeriod}));
                    }
                };
                loadLatestCtrl();
                if (supabaseClient) {
                    supabaseClient.auth.getSession().then(({ data: { session } }) => {
                        if(session) { setSession(session); checkUserRole(session.user.id, session.user.email); }
                    });
                    const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                        setSession(session);
                        if(session) checkUserRole(session.user.id, session.user.email); else setUserRole(null);
                    });
                    return () => subscription.unsubscribe();
                }
            }, [supabaseClient]);

            useEffect(() => {
                if(!session) return;
                if(view === 'dashboard') fetchDashboard();
                if(view === 'reports') fetchReport();
                if(view === 'controladoria') {
                    if(subView === 'dash') { fetchControladoriaAnalitico(); fetchControladoriaFiliais(); }
                    if(subView === 'report') fetchControladoriaRaw();
                    if(subView === 'centro_custo') fetchControladoriaContasAmigaveis();
                    if(subView === 'dre') { fetchControladoriaFiliais(); fetchDREData(); }
                }
                if(view === 'diesel' && (subView === 'dash' || subView === 'report')) fetchDieselData();
            }, [view, subView, filters, session, drePeriodoIni, drePeriodoFim]);

            const checkUserRole = async (userId, email) => {
                const { data } = await supabaseClient.from('user_roles').select('role').eq('user_id', userId).single();
                let role = data?.role || (email.includes('admin') ? 'admin' : 'terceirizacao');
                setUserRole(role);
                if (role === 'controladoria') handleSetView('controladoria', 'dash');
                else if (role === 'diesel') handleSetView('diesel', 'dash');
                else handleSetView('dashboard');
            };

            const handleSetView = (v, sv) => { 
                setView(v); 
                if(sv) setSubView(sv); 
                setSelectedReportPeriods([]);
            };

            const fetchDashboard = async () => {
                setLoading(true);
                try {
                    const { data, error } = await supabaseClient.rpc('get_dashboard_stats', { selected_month: filters.month, selected_branch: filters.filial });
                    if(error) throw error; if(data) setDashboardData(data);
                } catch(e) { console.error(e); } finally { setLoading(false); }
            };

            const fetchReport = async () => {
                setLoading(true);
                try {
                    const { data } = await supabaseClient.from('resumo_mensal').select('*').limit(5000);
                    if(data) setResumoData(data);
                } catch(e) { addLog(e.message, "error"); } finally { setLoading(false); }
            };

            const fetchDieselData = async () => {
                if(!filters.dieselPeriodo) return;
                setLoading(true);
                try { const { data } = await supabaseClient.from('diesel_estoque').select('*').eq('periodo', filters.dieselPeriodo).order('usina'); setDieselData(data || []); } catch(e) { addLog(e.message, 'error'); } finally { setLoading(false); }
            };

            const fetchControladoriaAnalitico = async () => {
                if(!filters.ctrlPeriodo) return;
                setLoading(true);
                try {
                    const { data: dataAtual } = await supabaseClient.rpc('get_controladoria_analise_contas', { p_periodo: filters.ctrlPeriodo, p_tipo: filters.ctrlTipo, p_usina: filters.ctrlUsina === 'Todas' ? null : filters.ctrlUsina });
                    let dataComp = [];
                    if (filters.ctrlPeriodoComp) {
                        const { data: resComp } = await supabaseClient.rpc('get_controladoria_analise_contas', { p_periodo: filters.ctrlPeriodoComp, p_tipo: filters.ctrlTipo, p_usina: filters.ctrlUsina === 'Todas' ? null : filters.ctrlUsina });
                        dataComp = resComp || [];
                    }
                    const merged = (dataAtual || []).map(item => {
                        const match = dataComp.find(c => c.conta === item.conta);
                        const vAnt = match ? parseFloat(match.valor_atual) : 0;
                        const vAtu = parseFloat(item.valor_atual);
                        let variacao = 0;
                        if (vAnt !== 0) variacao = ((vAtu - vAnt) / Math.abs(vAnt)) * 100;
                        else if (vAtu !== 0) variacao = 100;
                        return { ...item, variacao_perc: variacao };
                    });
                    setControladoriaAnalise(merged);
                } catch(e) { addLog(e.message, 'error'); } finally { setLoading(false); }
            };

            const fetchControladoriaRaw = async () => {
                setLoading(true);
                try {
                    let q = supabaseClient.from('controladoria_importacoes').select('*');
                    if(filters.ctrlPeriodo) q = q.eq('periodo', filters.ctrlPeriodo);
                    const { data } = await q.limit(2000).order('usina');
                    setControladoriaRaw((data || []).map(row => ({ periodo: row.periodo, usina: row.usina, custo_total: parseFloat(row.custo_total)||0, volume_total: parseFloat(row.volume_total)||0, ...row.detalhes })));
                } catch(e) { addLog(e.message, 'error'); } finally { setLoading(false); }
            };

            const fetchDREData = async () => {
                if(!drePeriodoIni || !drePeriodoFim) return;
                setLoading(true);
                try {
                    const { data: mapData } = await supabaseClient.from('controladoria_de_para').select('*');
                    setMappings(mapData || []);
                    const { data: rawData, error } = await supabaseClient.from('controladoria_importacoes').select('*').gte('periodo', drePeriodoIni).lte('periodo', drePeriodoFim);
                    if(error) throw error;
                    const processedRaw = (rawData || []).map(row => ({ periodo: row.periodo, usina: row.usina, detalhes: row.detalhes }));
                    setControladoriaRaw(processedRaw);
                } catch(e) { addLog("Erro DRE: " + e.message, 'error'); } finally { setLoading(false); }
            };

            const fetchControladoriaFiliais = async () => { try { const { data } = await supabaseClient.from('controladoria_importacoes').select('usina'); const unique = [...new Set((data||[]).map(d => d.usina))].sort(); setControladoriaFiliais(unique); } catch(e) {} };
            const fetchControladoriaContasAmigaveis = async () => { try { const { data } = await supabaseClient.from('controladoria_de_para').select('friendly_name').eq('tipo', 'Despesa').order('friendly_name'); setControladoriaContas(data.map(d => d.friendly_name)); } catch(e) {} };

            const processDieselFile = (file, periodDate) => {
                const XLSX = window.XLSX;
                if (!XLSX) { addLog("XLSX lib not loaded", "error"); return; }
                setLoading(true); const reader = new FileReader();
                reader.onload = async (e) => { try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); 
                    const batch = jsonData.map(row => {
                        const getVal = (colName) => { const key = Object.keys(row).find(k => k.toLowerCase().trim() === colName.toLowerCase().trim()); return key ? row[key] : 0; };
                        const getStr = (colName) => { const key = Object.keys(row).find(k => k.toLowerCase().trim() === colName.toLowerCase().trim()); return key ? String(row[key]) : ''; }
                        return { periodo: periodDate, usina: getStr('Centro') || 'ND', vol_inicial: Utils.formatters.parseBrl(getVal('Estoque inicial')), entradas: Utils.formatters.parseBrl(getVal('Totais qtds.entrada')), saidas: Utils.formatters.parseBrl(getVal('Totais qtds.saída')), vol_final: Utils.formatters.parseBrl(getVal('SAP')), ajuste_vol: Utils.formatters.parseBrl(getVal('Ajuste de Volume')), ajuste_vlr: Utils.formatters.parseBrl(getVal('Valor Total de Ajuste')), custo_medio: Utils.formatters.parseBrl(getVal('Valor Médio')), vlr_final: Utils.formatters.parseBrl(getVal('Valor Total Estoque Final')), vlr_inicial: 0, vlr_entrada: 0, vlr_saida: 0, motivo_ajuste: getStr('Motivo') };
                    }).filter(i => i.usina !== 'ND' && i.usina !== 'Total' && i.usina !== '' && i.usina !== 'Centro');
                    if (batch.length === 0) throw new Error("Sem registros.");
                    await supabaseClient.from('diesel_estoque').delete().eq('periodo', periodDate);
                    await supabaseClient.from('diesel_estoque').insert(batch);
                    addLog(`Importado!`, "success"); setFilters(prev => ({...prev, dieselPeriodo: periodDate})); fetchDieselData();
                } catch (err) { addLog("Erro: " + err.message, "error"); } finally { setLoading(false); } };
                reader.readAsArrayBuffer(file);
            };

            const processControladoriaFile = (file, periodDate) => {
                const XLSX = window.XLSX;
                if (!XLSX) { addLog("XLSX lib not loaded", "error"); return; }
                setLoading(true); const reader = new FileReader();
                reader.onload = async (e) => { try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1}); 
                    if (rawData.length < 4) throw new Error("Arquivo inválido.");
                    const headers = rawData[0]; const batch = [];
                    for (let i = 3; i < rawData.length; i++) {
                        const row = rawData[i]; const rawUsina = row[0];
                        if (rawUsina && typeof rawUsina === 'string') {
                            const usinaCode = rawUsina.substring(0, 4).toUpperCase(); let custoTotal = 0; let volTotal = 0; const detalhes = {};
                            headers.forEach((h, colIdx) => {
                                if(!h || colIdx === 0) return; const val = parseFloat(row[colIdx]) || 0; const hStr = h.toString().trim(); detalhes[hStr] = val; 
                                if (hStr.toLowerCase().includes('tot. custos')) custoTotal = val; else if (hStr.toLowerCase().includes('qtd.transp') || hStr.toLowerCase().includes('qtd.bomb')) volTotal += val;
                            });
                            batch.push({ periodo: periodDate, usina: usinaCode, custo_total: custoTotal, volume_total: volTotal, detalhes: detalhes });
                        }
                    }
                    await supabaseClient.rpc('limpar_periodo_controladoria', { p_periodo: periodDate });
                    for (let i = 0; i < batch.length; i += 100) await supabaseClient.from('controladoria_importacoes').insert(batch.slice(i, i + 100));
                    addLog(`Sucesso!`, "success"); setFilters(prev => ({...prev, ctrlPeriodo: periodDate}));
                } catch (err) { addLog("Erro: " + err.message, "error"); } finally { setLoading(false); } };
                reader.readAsArrayBuffer(file);
            };

            const handleUploadTerceirizacao = (file, type) => {
                const XLSX = window.XLSX;
                if (!XLSX) { addLog("XLSX lib not loaded", "error"); return; }
                setLoading(true);
                const r = new FileReader();
                r.onload = (e) => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:""});
                    setConfirmData({type, count: json.length, data: json});
                    setLoading(false);
                };
                r.readAsArrayBuffer(file);
            };

            const confirmImportTerceirizacao = async () => {
                if(!confirmData) return; const { type, data } = confirmData; setConfirmData(null); setLoading(true);
                const mapRow = (row) => {
                    const get = (k) => { const key = Object.keys(row).find(x => Utils.normalizeKey(x) === Utils.normalizeKey(k)); return key ? row[key] : ""; };
                    if(type==='apuracao') return { filial_prod: get('Filial Prod.'), n_viagem: get('N° Viagem'), terceiro: get('Terceiro'), placa: get('Placa'), valor_base: Utils.formatters.parseBrl(get('Valor Base')), volume: Utils.formatters.parseBrl(get('Volume')), total: Utils.formatters.parseBrl(get('Total')), classe: Utils.normalizeClass(get('Classe')), dt_viagem: Utils.formatters.parseDate(get('Dt. Viagem')), tipo_lancamento: get('Tipo Lancamento') };
                    if(type==='pagamentos') return { n_documento: get('Nº documento'), montante: Utils.formatters.parseBrl(get('Montante em moeda interna')), fornecedor: get('Fornecedor'), data_documento: Utils.formatters.parseDate(get('Data do documento')) };
                    if(type==='concessao') return { equipamento: get('Equipamento'), valor_base: Utils.formatters.parseBrl(get('Valor Base')), data_inicial: Utils.formatters.parseDate(get('Data Inicial')) };
                    return null;
                };
                try {
                    const batch = data.map(mapRow).filter(Boolean);
                    for(let i=0; i<batch.length; i+=100) await supabaseClient.from(type).insert(batch.slice(i, i+100));
                    addLog("Importado com sucesso!", "success");
                } catch(e) { addLog("Erro DB: "+e.message, 'error'); } finally { setLoading(false); }
            };

            const handleImport = async (file, type, period) => {
                if(type === 'controladoria') processControladoriaFile(file, period);
                else if(type === 'diesel') processDieselFile(file, period);
                else handleUploadTerceirizacao(file, type);
            };

            const batchExport = async (tableName, fileName) => {
                addLog("Exportação iniciada...", "info");
            };

            if (!supabaseClient) {
                return (
                    <div className="flex h-screen items-center justify-center bg-slate-50 dark:bg-slate-900">
                        <div className="text-center">
                            <div className="loader h-8 w-8 border-4 border-blue-500 rounded-full border-t-transparent mx-auto mb-4"></div>
                            <p className="text-sm text-slate-500 dark:text-slate-400">Inicializando sistema...</p>
                        </div>
                    </div>
                );
            }

            if (!session) return <LoginScreen onLogin={(e,p) => supabaseClient.auth.signInWithPassword({email:e, password:p})} loading={loading} />;

            return (
                <div className="min-h-screen flex bg-slate-100 dark:bg-slate-900 font-sans text-slate-800 dark:text-slate-200 overflow-hidden transition-colors duration-300">
                    <StatusLog logs={logs} clearLogs={() => setLogs([])} />
                    {confirmData && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
                            <div className="glass-card p-6 w-96 animate-enter bg-white dark:bg-slate-800">
                                <h3 className="font-bold mb-2 text-lg text-slate-800 dark:text-white">Confirmar Upload</h3>
                                <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">Deseja importar <strong>{confirmData.count}</strong> registros para <strong>{confirmData.type}</strong>?</p>
                                <div className="flex gap-2">
                                    <button onClick={()=>setConfirmData(null)} className="flex-1 border border-slate-300 dark:border-slate-600 p-2 rounded hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">Cancelar</button>
                                    <button onClick={confirmImportTerceirizacao} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded text-sm font-medium">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <Sidebar 
                        isSidebarOpen={isSidebarOpen} toggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)}
                        toggleModule={(m) => setExpandedModules(p => ({...p, [m]: !p[m]}))}
                        expandedModules={expandedModules} userRole={userRole}
                        setView={handleSetView} view={view} handleLogout={() => supabaseClient.auth.signOut()} session={session}
                    />
                    <div className={`flex-1 content-transition ${isSidebarOpen ? 'ml-64' : 'ml-20'} overflow-y-auto h-screen`}>
                        <header className="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md h-16 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-8 sticky top-0 z-20 transition-colors duration-300">
                            <h1 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                                {view === 'controladoria' ? <><Icons.BarChart2 className="w-4 h-4 text-slate-400" /> Controladoria / <span className="text-purple-600 dark:text-purple-400 capitalize">{subView === 'centro_custo' ? 'Detalhe C. Custo' : (subView === 'dre' ? 'DRE Gerencial' : subView)}</span></> : 
                                 view === 'diesel' ? <><Icons.Fuel className="w-4 h-4 text-slate-400" /> Diesel / <span className="text-orange-600 dark:text-orange-400 capitalize">{subView}</span></> : 
                                 <><Icons.Briefcase className="w-4 h-4 text-slate-400" /> Terceirização / <span className="text-blue-600 dark:text-blue-400 capitalize">{view}</span></>}
                            </h1>
                            <div className="flex items-center gap-4">
                                {loading && <div className="flex items-center gap-2 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-full"><div className="loader h-3 w-3 border-2 rounded-full"></div> Atualizando...</div>}
                                <button onClick={() => setIsDark(!isDark)} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors">
                                    {isDark ? <Icons.Sun /> : <Icons.Moon />}
                                </button>
                            </div>
                        </header>
                        <main className="p-8 max-w-[1600px] mx-auto pb-20">
                            <ErrorBoundary>
                                {view === 'dashboard' && (
                                    <div className="space-y-8">
                                        <div className="glass-card p-4 flex gap-4">
                                            <div className="flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-400"><Icons.Filter /> Filtros:</div>
                                            <select className="bg-transparent text-sm font-medium focus:outline-none dark:text-slate-200 dark:bg-slate-800" value={filters.month} onChange={e=>setFilters({...filters, month:e.target.value})}><option value="Todos">📅 Todos os Meses</option>{dashboardData.meses && dashboardData.meses.map(m=><option key={m} value={m}>{m}</option>)}</select>
                                            <select className="bg-transparent text-sm font-medium focus:outline-none dark:text-slate-200 dark:bg-slate-800" value={filters.filial} onChange={e=>setFilters({...filters, filial:e.target.value})}><option value="Todas">🏭 Todas as Filiais</option>{dashboardData.filiais && dashboardData.filiais.map(f=><option key={f} value={f}>{f}</option>)}</select>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                                            <Card title="Volume Total" value={Utils.math.roundVolume(dashboardData.kpis.total_vol).toLocaleString() + " m³"} iconName="Database" color="blue" />
                                            <Card title="Vol. Bombeado" value={Utils.math.roundVolume(dashboardData.kpis.vol_bomba).toLocaleString() + " m³"} iconName="Droplet" color="sky" />
                                            <Card title="Vol. Transp" value={Utils.math.roundVolume(dashboardData.kpis.vol_transp).toLocaleString() + " m³"} iconName="Truck" color="orange" />
                                            <Card title="Custo Médio" value={Utils.formatters.currency(dashboardData.kpis.total_vol > 0 ? dashboardData.kpis.total_val/dashboardData.kpis.total_vol : 0)} iconName="DollarSign" color="emerald" />
                                            <Card title="Valor Total" value={Utils.formatters.currency(dashboardData.kpis.total_val)} iconName="DollarSign" color="purple" />
                                        </div>
                                        <div className="glass-card p-6 h-[450px]">
                                            <div className="flex justify-between items-center mb-6"><div><h3 className="font-bold text-slate-800 dark:text-white text-lg">Custo Médio por m³ por Usina</h3></div><div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-700 p-1 rounded-lg border border-slate-200 dark:border-slate-600"><Icons.ListFilter className="text-slate-400 ml-2 w-4 h-4" /><select className="bg-transparent text-xs font-medium text-slate-600 dark:text-slate-300 p-1 focus:outline-none dark:bg-slate-700" value={rankingFilter} onChange={(e) => setRankingFilter(e.target.value)}><option value="top10">10 Maiores</option><option value="bottom10">10 Menores</option></select></div></div>
                                            <ResponsiveContainer width="100%" height="100%"><BarChart data={dashboardData.chart_branch || []} onClick={(data) => { if (data && data.activeLabel) { setFilters(prev => ({...prev, filial: prev.filial === data.activeLabel ? 'Todas' : data.activeLabel})); }}} style={{ cursor: 'pointer' }}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke={chartColors.grid} /><XAxis dataKey="name" tick={{fill: chartColors.text}} /><YAxis tick={{fill: chartColors.text}} tickFormatter={(val) => `R$ ${val}`} /><Tooltip content={<CustomTooltip isDark={isDark} />} /><Legend /><Bar dataKey="val_betoneira" stackId="a" fill={chartColors.betoneira} name="Transporte" /><Bar dataKey="val_bomba" stackId="a" fill={chartColors.bomba} name="Bombeamento" /></BarChart></ResponsiveContainer>
                                        </div>
                                    </div>
                                )}
                                {view === 'reports' && (
                                    <div className="space-y-6">
                                        <div className="glass-card p-4 mb-6 flex gap-4 items-end relative z-30">
                                            <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 self-center mr-2"><Icons.Filter /> Filtros:</div>
                                            <MultiSelectDropdown label="Períodos (Meses)" options={uniqueReportPeriods} selected={selectedReportPeriods} onChange={setSelectedReportPeriods} />
                                        </div>
                                        <DataTable data={filteredReportData} onNotify={addLog} onExportAll={() => batchExport('resumo_mensal', 'Relatorio_Geral_Completo')} />
                                    </div>
                                )}
                                {view === 'controladoria' && (subView === 'dash' || subView === 'report') && (
                                    <>
                                        <div className="glass-card p-4 mb-6 flex gap-4 flex-wrap items-center relative z-30">
                                            <div className="flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-400"><Icons.Filter /> Filtros:</div>
                                            {subView === 'dash' && (<><MonthPicker label="Período Atual" value={filters.ctrlPeriodo} onChange={e=>setFilters({...filters, ctrlPeriodo:e})} /><MonthPicker label="Comparar Com" value={filters.ctrlPeriodoComp} onChange={e=>setFilters({...filters, ctrlPeriodoComp:e})} /></>)}
                                            {subView === 'report' && (<MonthPicker label="Selecionar Períodos" value={selectedReportPeriods} onChange={setSelectedReportPeriods} isMulti={true} />)}
                                            <div className="flex flex-col"><span className="input-label mb-1">Usina</span><select className="border border-slate-200 dark:border-slate-700 rounded-lg px-2 py-2 text-sm bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 w-32 outline-none focus:ring-2 focus:ring-blue-500/20" value={filters.ctrlUsina} onChange={e => setFilters({...filters, ctrlUsina: e.target.value})}><option value="Todas">Todas</option>{controladoriaFiliais.map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                                        </div>
                                        {subView === 'dash' && <ControladoriaDashboardAnalitico stats={controladoriaAnalise} loading={loading} tipo={filters.ctrlTipo} setTipo={t=>setFilters({...filters, ctrlTipo:t})} onDrillDown={c => { setDrillDownConta(c); handleSetView('controladoria', 'centro_custo'); }} periodo={filters.ctrlPeriodo} periodoComp={filters.ctrlPeriodoComp} isDark={isDark} />}
                                        {subView === 'report' && <DataTable data={filteredReportData} onNotify={addLog} title="Dados Detalhados Controladoria" onExportAll={() => batchExport('controladoria_importacoes', `Relatorio_Controladoria_${filters.ctrlPeriodo}`)} />}
                                    </>
                                )}
                                {view === 'controladoria' && subView === 'centro_custo' && <ControladoriaDashboardCentroCusto supabaseClient={supabaseClient} periodo={filters.ctrlPeriodo} contas={controladoriaContas} onNotify={addLog} initialConta={drillDownConta} onBack={()=>setSubView('dash')} isDark={isDark} />}
                                {view === 'controladoria' && subView === 'depara' && <ControladoriaDePara supabaseClient={supabaseClient} onNotify={addLog} />}
                                {view === 'controladoria' && subView === 'import' && <ControladoriaImport onImport={(f,d) => handleImport(f,'controladoria',d)} loading={loading} />}
                                {view === 'controladoria' && subView === 'dre' && (
                                    <div className="space-y-6 animate-enter">
                                        <div className="glass-card p-4 flex gap-4 items-end flex-wrap relative z-30">
                                            <div className="flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-400 self-center mr-2"><Icons.Filter /> Filtros DRE:</div>
                                            <MonthPicker label="De" value={drePeriodoIni} onChange={setDrePeriodoIni} />
                                            <MonthPicker label="Até" value={drePeriodoFim} onChange={setDrePeriodoFim} />
                                            <MultiSelectDropdown label="Usinas (Consolidação)" options={controladoriaFiliais} selected={dreUsinas} onChange={setDreUsinas} />
                                            <button onClick={fetchDREData} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-500/30 transition-all self-end ml-auto"><Icons.RefreshCw className="w-4 h-4 inline mr-2" /> Atualizar DRE</button>
                                        </div>
                                        <ControladoriaDRE rawData={controladoriaRaw} mappings={mappings} periodoIni={drePeriodoIni} periodoFim={drePeriodoFim} usinasSelecionadas={dreUsinas} isDark={isDark} />
                                    </div>
                                )}
                                {view === 'diesel' && subView === 'dash' && (
                                    <>
                                        <div className="glass-card p-4 mb-6 flex gap-4 relative z-30"><div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400"><Icons.Filter /> Filtros:</div><MonthPicker label="Mês" value={filters.dieselPeriodo} onChange={e=>setFilters({...filters, dieselPeriodo:e})} /></div>
                                        <DieselDashboard data={dieselData} loading={loading} periodo={filters.dieselPeriodo} isDark={isDark} />
                                    </>
                                )}
                                {view === 'diesel' && subView === 'report' && <DataTable data={dieselData} onNotify={addLog} title="Relatório Diesel" />}
                                {view === 'diesel' && subView === 'import' && <DieselImport onImport={(f,d)=>handleImport(f,'diesel',d)} loading={loading} />}
                                {view === 'upload' && (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <UploadCard type="apuracao" iconName="fileText" onAnalyze={(f)=>handleImport(f,'apuracao')} isAnalyzing={loading} progress={0} />
                                        <UploadCard type="pagamentos" iconName="dollar" onAnalyze={(f)=>handleImport(f,'pagamentos')} isAnalyzing={loading} progress={0} />
                                        <UploadCard type="concessao" iconName="truck" onAnalyze={(f)=>handleImport(f,'concessao')} isAnalyzing={loading} progress={0} />
                                    </div>
                                )}
                            </ErrorBoundary>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>






